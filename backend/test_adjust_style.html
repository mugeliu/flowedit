<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>测试 Adjust Style API</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
            background: #fef7ff; 
            padding: 20px;
        }
        .container { 
            max-width: 1000px; 
            margin: 0 auto; 
            background: white; 
            border-radius: 12px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header { 
            background: linear-gradient(135deg, #a855f7 0%, #9333ea 100%); 
            color: white; 
            padding: 30px; 
            text-align: center; 
        }
        .header h1 { font-size: 28px; margin-bottom: 10px; }
        .header p { opacity: 0.9; font-size: 16px; }
        .content { padding: 30px; }
        .test-section { 
            border: 1px solid #e1e8ed; 
            border-radius: 8px; 
            margin-bottom: 25px; 
            overflow: hidden;
        }
        .section-header { 
            background: #faf5ff; 
            padding: 15px 20px; 
            border-bottom: 1px solid #e1e8ed; 
            font-weight: 600; 
            color: #7c2d12;
        }
        .section-content { padding: 20px; }
        .form-group { margin-bottom: 20px; }
        label { 
            display: block; 
            margin-bottom: 8px; 
            font-weight: 500; 
            color: #374151; 
        }
        input, textarea, select { 
            width: 100%; 
            padding: 12px 16px; 
            border: 2px solid #e5e7eb; 
            border-radius: 8px; 
            font-size: 14px; 
            transition: all 0.3s;
        }
        input:focus, textarea:focus, select:focus { 
            outline: none; 
            border-color: #a855f7; 
            box-shadow: 0 0 0 3px rgba(168, 85, 247, 0.1);
        }
        textarea { 
            min-height: 100px; 
            resize: vertical; 
            font-family: inherit;
        }
        .btn { 
            background: linear-gradient(135deg, #a855f7 0%, #9333ea 100%); 
            color: white; 
            padding: 12px 24px; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: 600; 
            font-size: 16px;
            transition: all 0.3s;
            margin-right: 10px;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(168, 85, 247, 0.3); }
        .btn:disabled { 
            background: #9ca3af; 
            cursor: not-allowed; 
            transform: none; 
            box-shadow: none; 
        }
        .btn.secondary { 
            background: #6b7280; 
        }
        .btn.secondary:hover { 
            background: #4b5563; 
            box-shadow: 0 8px 25px rgba(107, 114, 128, 0.3);
        }
        .result { 
            background: #f8fafc; 
            border: 1px solid #e5e7eb; 
            border-radius: 8px; 
            padding: 20px; 
            margin-top: 20px; 
            white-space: pre-wrap; 
            font-family: 'Monaco', 'Courier New', monospace; 
            font-size: 12px; 
            max-height: 400px; 
            overflow-y: auto;
        }
        .success { border-color: #10b981; background-color: #ecfdf5; }
        .error { border-color: #ef4444; background-color: #fef2f2; }
        .warning { border-color: #f59e0b; background-color: #fffbeb; }
        .status { 
            padding: 8px 12px; 
            border-radius: 6px; 
            font-size: 12px; 
            font-weight: 600; 
            margin-bottom: 15px;
        }
        .status.loading { background: #dbeafe; color: #1d4ed8; }
        .status.success { background: #dcfce7; color: #166534; }
        .status.error { background: #fee2e2; color: #991b1b; }
        .theme-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); 
            gap: 10px; 
            margin-bottom: 20px; 
        }
        .theme-card { 
            background: #f3f4f6; 
            padding: 15px 10px; 
            border-radius: 8px; 
            cursor: pointer; 
            transition: all 0.2s; 
            text-align: center;
            border: 2px solid transparent;
        }
        .theme-card:hover { 
            background: #e5e7eb; 
            border-color: #a855f7;
        }
        .theme-card.selected { 
            background: #f3e8ff; 
            border-color: #a855f7; 
            color: #7c2d12;
        }
        .theme-card .name { font-weight: 600; font-size: 13px; }
        .theme-card .desc { font-size: 11px; margin-top: 5px; opacity: 0.7; }
        .api-info { 
            background: #fdf4ff; 
            border-left: 4px solid #a855f7; 
            padding: 15px; 
            margin-bottom: 25px; 
            border-radius: 0 8px 8px 0;
        }
        .info-note {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 15px;
            margin: 15px 0;
            border-radius: 0 8px 8px 0;
            font-size: 14px;
        }
        .quick-adjustments { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); 
            gap: 10px; 
            margin-bottom: 20px; 
        }
        .quick-adjustment { 
            background: #faf5ff; 
            padding: 12px; 
            border-radius: 6px; 
            cursor: pointer; 
            transition: all 0.2s; 
            text-align: center;
            font-size: 13px;
            border: 1px solid #e9d5ff;
        }
        .quick-adjustment:hover { background: #f3e8ff; border-color: #a855f7; }
        .example-section {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
        }
        .example-header {
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }
        .example-content {
            font-size: 13px;
            color: #6b7280;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎛️ Adjust Style API 测试器</h1>
            <p>调整和优化已有风格主题的样式配置</p>
        </div>

        <div class="content">
            <div class="api-info">
                <strong>API端点:</strong> POST /api/v1/styles/adjust<br>
                <strong>功能:</strong> 根据调整要求修改已有风格主题的样式DNA配置<br>
                <strong>前提:</strong> 需要先使用 Create Style API 创建风格主题
            </div>

            <div class="info-note">
                💡 <strong>使用说明:</strong> 此API用于微调已创建的风格主题，如调整颜色、字体大小、间距等样式属性。
            </div>

            <div class="test-section">
                <div class="section-header">📝 API配置</div>
                <div class="section-content">
                    <div class="form-group">
                        <label for="apiBase">API基础地址</label>
                        <input type="text" id="apiBase" value="http://localhost:8000/api" placeholder="http://localhost:8000/api">
                    </div>
                </div>
            </div>

            <div class="test-section">
                <div class="section-header">📚 可用主题</div>
                <div class="section-content">
                    <button class="btn secondary" onclick="loadThemes()">🔄 刷新主题列表</button>
                    <div id="themesStatus" class="status" style="display:none;"></div>
                    <div class="theme-grid" id="themeGrid">
                        <div class="theme-card" onclick="selectTheme('测试风格')">
                            <div class="name">测试风格</div>
                            <div class="desc">默认测试主题</div>
                        </div>
                    </div>
                    <input type="hidden" id="selectedTheme" value="测试风格">
                </div>
            </div>

            <div class="test-section">
                <div class="section-header">🚀 快速调整选项</div>
                <div class="section-content">
                    <div class="quick-adjustments">
                        <div class="quick-adjustment" onclick="loadAdjustmentCase('larger')">字体放大</div>
                        <div class="quick-adjustment" onclick="loadAdjustmentCase('smaller')">字体缩小</div>
                        <div class="quick-adjustment" onclick="loadAdjustmentCase('darker')">颜色加深</div>
                        <div class="quick-adjustment" onclick="loadAdjustmentCase('lighter')">颜色变浅</div>
                        <div class="quick-adjustment" onclick="loadAdjustmentCase('spacing')">增加间距</div>
                        <div class="quick-adjustment" onclick="loadAdjustmentCase('compact')">紧凑布局</div>
                        <div class="quick-adjustment" onclick="loadAdjustmentCase('colorful')">色彩丰富</div>
                        <div class="quick-adjustment" onclick="loadAdjustmentCase('minimal')">极简风格</div>
                    </div>

                    <div class="example-section">
                        <div class="example-header">调整请求示例：</div>
                        <div class="example-content">
                            • "把标题字体调大一些，颜色改成深蓝色"<br>
                            • "整体风格改成更简洁的样式，减少装饰元素"<br>
                            • "增加段落间距，让内容更透气"<br>
                            • "把配色方案改成暖色调"
                        </div>
                    </div>
                </div>
            </div>

            <div class="test-section">
                <div class="section-header">📋 请求参数</div>
                <div class="section-content">
                    <div class="form-group">
                        <label for="themeName">主题名称 (theme_name)</label>
                        <input type="text" id="themeName" placeholder="选择一个已创建的主题" value="测试风格" readonly>
                        <small style="color: #6b7280;">从上面的主题列表中选择要调整的主题</small>
                    </div>

                    <div class="form-group">
                        <label for="adjustmentRequest">调整要求 (adjustment_request)</label>
                        <textarea id="adjustmentRequest" placeholder="详细描述你希望如何调整这个风格主题...">把字体调大一点，颜色改成更深的蓝色系，增加一些段落间距让内容看起来更清爽</textarea>
                        <small style="color: #6b7280;">
                            可以描述颜色、字体大小、间距、布局等方面的调整需求
                        </small>
                    </div>
                </div>
            </div>

            <div class="test-section">
                <div class="section-header">🔧 执行测试</div>
                <div class="section-content">
                    <button class="btn" onclick="testAdjustStyle()" id="testBtn">
                        🎛️ 执行 Adjust Style API 测试
                    </button>
                    
                    <div id="status"></div>
                    <div id="result" class="result" style="display: none;"></div>
                </div>
            </div>

            <div class="test-section" id="comparisonSection" style="display: none;">
                <div class="section-header">🔍 调整前后对比</div>
                <div class="section-content">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <div class="example-header">调整前的样式DNA:</div>
                            <div id="originalStyle" class="example-section" style="font-family: 'Monaco', 'Courier New', monospace; font-size: 11px; white-space: pre-wrap;"></div>
                        </div>
                        <div>
                            <div class="example-header">调整后的样式DNA:</div>
                            <div id="adjustedStyle" class="example-section" style="font-family: 'Monaco', 'Courier New', monospace; font-size: 11px; white-space: pre-wrap;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentApiBase = 'http://localhost:8000/api';
        let availableThemes = [];
        let originalStyleDNA = null;

        // 更新API基础地址
        document.getElementById('apiBase').addEventListener('change', function() {
            currentApiBase = this.value;
        });

        // 调整请求案例
        const adjustmentCases = {
            larger: {
                request: "把所有字体都调大一些，标题字体增加到28px，段落字体增加到18px，让内容更容易阅读"
            },
            smaller: {
                request: "把字体调小一点，使用更紧凑的排版，标题20px，段落14px，适合移动端阅读"
            },
            darker: {
                request: "把所有文字颜色调深一些，提高对比度，标题使用深灰色#2c3e50，段落使用#374151"
            },
            lighter: {
                request: "使用更浅的颜色搭配，标题改成浅灰色#6b7280，段落使用#9ca3af，营造轻松的感觉"
            },
            spacing: {
                request: "增加各元素之间的间距，段落间距调整为24px，标题上下边距增加到30px，让布局更透气"
            },
            compact: {
                request: "采用更紧凑的布局，减少所有间距，段落间距调整为12px，标题间距调整为16px"
            },
            colorful: {
                request: "使用更丰富的颜色搭配，标题使用蓝色#3b82f6，强调文字使用红色#ef4444，列表使用绿色#10b981"
            },
            minimal: {
                request: "改成极简风格，只使用黑白灰三种颜色，去掉所有装饰性样式，专注于内容的可读性"
            }
        };

        // 加载调整案例
        function loadAdjustmentCase(type) {
            const testCase = adjustmentCases[type];
            if (testCase) {
                document.getElementById('adjustmentRequest').value = testCase.request;
                showStatus('已加载调整案例: ' + type, 'success');
            }
        }

        // 加载主题列表
        async function loadThemes() {
            const statusDiv = document.getElementById('themesStatus');
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = '<div class="status loading">正在加载主题列表...</div>';

            try {
                const response = await fetch(`${currentApiBase}/v1/styles/themes`);
                const result = await response.json();

                if (response.ok && result.themes) {
                    availableThemes = result.themes;
                    renderThemes(result.themes);
                    statusDiv.innerHTML = '<div class="status success">✅ 已加载 ' + result.themes.length + ' 个主题</div>';
                } else {
                    statusDiv.innerHTML = '<div class="status error">❌ 加载主题失败</div>';
                    renderThemes([]);
                }
            } catch (error) {
                statusDiv.innerHTML = '<div class="status error">❌ 网络错误: ' + error.message + '</div>';
                renderThemes([]);
            }

            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 3000);
        }

        // 渲染主题网格
        function renderThemes(themes) {
            const themeGrid = document.getElementById('themeGrid');
            
            if (themes.length === 0) {
                themeGrid.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 20px; color: #6b7280;">
                        😔 暂无可用主题，请先使用 Create Style API 创建主题
                    </div>
                `;
                return;
            }

            themeGrid.innerHTML = themes.map(theme => `
                <div class="theme-card" onclick="selectTheme('${theme}')">
                    <div class="name">${theme}</div>
                    <div class="desc">点击选择调整</div>
                </div>
            `).join('');
        }

        // 选择主题
        function selectTheme(themeName) {
            // 更新UI状态
            document.querySelectorAll('.theme-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            event.target.closest('.theme-card').classList.add('selected');
            
            // 更新表单
            document.getElementById('selectedTheme').value = themeName;
            document.getElementById('themeName').value = themeName;
            
            showStatus('已选择主题: ' + themeName, 'success');
            
            // 清空之前的对比数据
            originalStyleDNA = null;
            document.getElementById('comparisonSection').style.display = 'none';
        }

        // 显示状态
        function showStatus(message, type = 'loading') {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        // 显示结果
        function showResult(data, isSuccess = true, originalData = null) {
            const resultDiv = document.getElementById('result');
            const comparisonSection = document.getElementById('comparisonSection');
            
            resultDiv.style.display = 'block';
            resultDiv.className = `result ${isSuccess ? 'success' : 'error'}`;
            
            if (isSuccess && data.html_content) {
                // 只显示大模型返回的HTML内容
                resultDiv.textContent = data.html_content;
                
                // 如果有对比数据，显示对比
                if (data.style_dna && originalData) {
                    comparisonSection.style.display = 'block';
                    document.getElementById('originalStyle').textContent = JSON.stringify(originalData, null, 2);
                    document.getElementById('adjustedStyle').textContent = JSON.stringify(data.style_dna, null, 2);
                }
            } else {
                // 错误时显示完整响应
                resultDiv.textContent = JSON.stringify(data, null, 2);
            }
        }

        // 获取原始样式DNA（用于对比）
        async function getOriginalStyleDNA(themeName) {
            try {
                // 通过创建一个临时的apply请求来获取当前的style_dna
                const response = await fetch(`${currentApiBase}/v1/styles/apply`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        raw_content: "# 临时内容\n用于获取原始样式DNA",
                        theme_name: themeName
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    return result.style_dna;
                }
            } catch (error) {
                console.log('获取原始样式DNA失败:', error);
            }
            return null;
        }

        // 执行API测试
        async function testAdjustStyle() {
            const btn = document.getElementById('testBtn');
            const themeName = document.getElementById('themeName').value;
            const adjustmentRequest = document.getElementById('adjustmentRequest').value;
            
            if (!themeName) {
                showStatus('❌ 请选择一个主题', 'error');
                return;
            }
            
            if (!adjustmentRequest.trim()) {
                showStatus('❌ 请输入调整要求', 'error');
                return;
            }

            btn.disabled = true;
            btn.textContent = '⏳ 正在测试...';
            
            showStatus('正在获取原始样式数据...', 'loading');
            
            try {
                // 先获取原始样式DNA用于对比
                originalStyleDNA = await getOriginalStyleDNA(themeName);
                
                showStatus('正在发送调整请求到 Adjust Style API...', 'loading');
                
                const requestData = {
                    theme_name: themeName,
                    adjustment_request: adjustmentRequest
                };

                console.log('发送请求:', requestData);
                
                const response = await fetch(`${currentApiBase}/v1/styles/adjust`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });

                const result = await response.json();
                console.log('收到响应:', result);

                if (response.ok) {
                    showStatus('✅ API测试成功完成！风格已调整', 'success');
                    showResult(result, true, originalStyleDNA);
                } else {
                    showStatus(`❌ API测试失败: ${response.status} - ${result.detail || '未知错误'}`, 'error');
                    showResult(result, false);
                }

            } catch (error) {
                console.error('请求错误:', error);
                showStatus('❌ 网络请求失败: ' + error.message, 'error');
                showResult({ error: error.message, stack: error.stack }, false);
            } finally {
                btn.disabled = false;
                btn.textContent = '🎛️ 执行 Adjust Style API 测试';
            }
        }

        // 页面加载时的初始化
        window.onload = function() {
            showStatus('准备就绪，可以开始测试 Adjust Style API', 'success');
            loadThemes(); // 自动加载主题列表
        };
    </script>
</body>
</html>