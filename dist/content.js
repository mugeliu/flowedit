!function(){"use strict";const t=new class{constructor(){this.plugins=new Map,this.initialized=new Set}register(t,e){if(!e.initialize||"function"!=typeof e.initialize)throw new Error(`插件 ${t} 必须提供 initialize 方法`);if(!e.cleanup||"function"!=typeof e.cleanup)throw new Error(`插件 ${t} 必须提供 cleanup 方法`);this.plugins.set(t,e),console.log(`插件 ${t} 已注册`)}async initializePlugin(t){const e=this.plugins.get(t);if(!e)return console.warn(`插件 ${t} 未注册`),!1;if(this.initialized.has(t))return console.warn(`插件 ${t} 已经初始化`),!0;try{return e.isEnabled&&!e.isEnabled()?(console.log(`插件 ${t} 已禁用，跳过初始化`),!1):(await e.initialize(),this.initialized.add(t),console.log(`插件 ${t} 初始化成功`),!0)}catch(n){return console.error(`插件 ${t} 初始化失败:`,n),!1}}async initializeAll(){const t={success:[],failed:[],skipped:[]};for(const[e]of this.plugins){await this.initializePlugin(e)?t.success.push(e):t.failed.push(e)}return console.log("插件初始化完成:",t),t}cleanupPlugin(t){const e=this.plugins.get(t);if(!e)return console.warn(`插件 ${t} 未注册`),!1;if(!this.initialized.has(t))return console.warn(`插件 ${t} 未初始化，无需清理`),!0;try{return e.cleanup(),this.initialized.delete(t),console.log(`插件 ${t} 清理成功`),!0}catch(n){return console.error(`插件 ${t} 清理失败:`,n),!1}}cleanupAll(){const t={success:[],failed:[]};for(const e of this.initialized){this.cleanupPlugin(e)?t.success.push(e):t.failed.push(e)}return console.log("插件清理完成:",t),t}getRegisteredPlugins(){return Array.from(this.plugins.keys())}getInitializedPlugins(){return Array.from(this.initialized)}isRegistered(t){return this.plugins.has(t)}isInitialized(t){return this.initialized.has(t)}},e={placeholder:"开始输入内容...",autofocus:!0,hideToolbar:!1,tools:{paragraph:{class:"Paragraph",inlineToolbar:!0},header:{class:"Header",inlineToolbar:!0,config:{levels:[1,2,3],defaultLevel:1,placeholder:"请输入标题"},toolbox:[{title:"Heading 1",icon:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24"><path stroke="currentColor" stroke-linecap="round" stroke-width="2" d="M6 7L6 12M6 17L6 12M6 12L12 12M12 7V12M12 17L12 12"/><path stroke="currentColor" stroke-linecap="round" stroke-width="2" d="M19 17V10.2135C19 10.1287 18.9011 10.0824 18.836 10.1367L16 12.5"/></svg>',data:{level:1}},{title:"Heading 2",icon:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24"><path stroke="currentColor" stroke-linecap="round" stroke-width="2" d="M6 7L6 12M6 17L6 12M6 12L12 12M12 7V12M12 17L12 12"/><path stroke="currentColor" stroke-linecap="round" stroke-width="2" d="M16 11C16 10 19 9.5 19 12C19 13.9771 16.0684 13.9997 16.0012 16.8981C15.9999 16.9533 16.0448 17 16.1 17L19.3 17"/></svg>',data:{level:2}},{title:"Heading 3",icon:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24"><path stroke="currentColor" stroke-linecap="round" stroke-width="2" d="M6 7L6 12M6 17L6 12M6 12L12 12M12 7V12M12 17L12 12"/><path stroke="currentColor" stroke-linecap="round" stroke-width="2" d="M16 11C16 10.5 16.8323 10 17.6 10C18.3677 10 19.5 10.311 19.5 11.5C19.5 12.5315 18.7474 12.9022 18.548 12.9823C18.5378 12.9864 18.5395 13.0047 18.5503 13.0063C18.8115 13.0456 20 13.3065 20 14.8C20 16 19.5 17 17.8 17C17.8 17 16 17 16 16.3"/></svg>',data:{level:3}}]},quote:{class:"Quote",inlineToolbar:!0,config:{quotePlaceholder:"输入引用内容",captionPlaceholder:"引用来源"}},image:{class:"ImageTool",inlineToolbar:!0,config:{endpoints:{}}},raw:{class:"RawTool"}},minHeight:300,logLevel:"WARN"},n={toolbar:"#js_toolbar_0",editorContent:'div[contenteditable="true"].ProseMirror',editorWrapper:"#edui1_iframeholder",buttonArea:"#bottom_main",sidebar:"#js_side_article_list",authorArea:"#js_author_area",ueditor:"#ueditor_0",botBar:".js_bot_bar"},i={head:'<section data-mpa-template="t" data-mpa-template-id="23968" data-mpa-category="style_single_material"><section style="display: flex;flex-direction: column;padding: 0 10px;" data-mid=""><section style="display: flex;flex-direction: column;align-self: flex-start;" data-mid=""><section nodeleaf="" style="display: flex;justify-content: center;align-items: center;z-index: 1;width: 16px;margin: 0 0 -1px 25px;" data-mid=""><img src="https://mmbiz.qpic.cn/mmbiz_png/dEf5U8O2YzjX7RPfmgLtXZGQ4emxXdzQs0UcN2m15pprg9EBQ6X6wYZvncMFvgT45MTASpAn6tyLMN2ibLGiawRA/0?from=appmsg" alt="" style="display: block;" data-mid=""></section><section style="background: #FFFFFF;border: 1px solid #0092FF;padding: 6px 18px 5px 19px;text-align: left;border-radius: 32px;" data-mid=""><p yb-mpa-mark="mark-style-text" style="font-size: 14px;color: #333333;line-height: 20px;word-break: break-word;" data-mid="">点击上方<span style="color: #0092ff;" data-mid="">蓝字</span>关注我们</p></section><section nodeleaf="" style="display: flex;justify-content: center;align-items: center;width: 24px;align-self: center;margin: -6px 0 0 0;" data-mid=""><img src="https://mmbiz.qpic.cn/mmbiz_gif/YtIDLfKRkon8SLKBvmCfjvZ4I8azbdaFnZbM5cE2jjuApZCV2VwwWaUAgspNrka1Qn9VQnbH2064IVdEaFl37w/0?from=appmsg" alt="" style="display: block;" data-mid=""></section></section></section></section>',ending:'<section data-mpa-template="t" data-mpa-template-id="23502" data-mpa-category="style_single_material"><section style="display: flex;flex-direction: column;" data-mid=""><section style="align-self: center;display: flex;flex-direction: column;" data-mid=""><section style="width: 100px;margin: 0 0 -21px 16px;" data-mid=""><section style="text-align: center;margin: 0 0 -16px 0;" data-mid=""><p style="font-weight: bold;font-size: 20px;color: #F1F5FF;line-height: 28px;word-break: break-word;" data-mid="">HISTORY</p></section><section style="text-align: center;" data-mid=""><p style="font-weight: bold;font-size: 16px;color: #FFD750;line-height: 22px;word-break: break-word;" data-mid="">往期推荐 </p></section></section><section style="display: flex;justify-content: center;align-items: center;width: 267px;" data-mid=""><img src="https://mmbiz.qpic.cn/mmbiz_png/JnFVjHuvmJ8D1wqQf1Fef720vyhcqcoLFlPOcljZibuqdMVpKMhfnRvkraoM2pZmlvPe4Ewm8Np90Gqq9BLBufw/0?from=appmsg" data-mid=""></section><section style="width: 267px;border: 1px solid #86A4FF;border-top: none !important;padding: 8px;" data-mid=""><section style="display: flex;flex-direction: column;padding: 10px 0 11px 0;background: #F1F5FF;" data-mid=""><section data-mpa-template-rows="1" style="width: 100%;padding: 21px 27px 20px 27px;" data-mid=""><section style="display: flex;align-items: flex-start;padding: 5px 5px 5px 5px;border-bottom: 1.3px dashed #86A4FF;" data-mid=""><section style="width: 9px;height: 9px;background: #86A4FF;margin: 5px 8px 0 0;transform: skewX(-10deg);" data-mid=""></section><section style="text-align: left;" data-mid=""><p style="font-size: 14px;color: #000000;line-height: 20px;word-break: break-word;" data-mid="">当季出游穿搭分享</p></section></section>\n  <section style="display: flex;align-items: flex-start;padding: 5px 5px 5px 5px;border-bottom: 1.3px dashed #86A4FF;" data-mid=""><section style="width: 9px;height: 9px;background: #86A4FF;margin: 5px 8px 0 0;transform: skewX(-10deg);" data-mid=""></section><section style="text-align: left;" data-mid=""><p style="font-size: 14px;color: #000000;line-height: 20px;word-break: break-word;" data-mid="">减脂人初春低糖饮品推荐</p></section></section><section style="display: flex;align-items: flex-start;padding: 5px 5px 5px 5px;border-bottom: 1.3px dashed #86A4FF;" data-mid=""><section style="width: 9px;height: 9px;background: #86A4FF;margin: 5px 8px 0 0;transform: skewX(-10deg);" data-mid=""></section><section style="text-align: left;" data-mid=""><p style="font-size: 14px;color: #000000;line-height: 20px;word-break: break-word;" data-mid="">五一踏青旅游胜地推荐</p></section></section></section></section></section></section></section></section>',inlineStyles:{bold:"font-weight: bold;",italic:"font-style: italic;",underline:"text-decoration: underline;",strikethrough:"text-decoration: line-through;",code:"background: rgba(26, 104, 64, 0.1); padding: 2px 4px; border-radius: 3px; font-family: 'Courier New', monospace; font-size: 0.9em;",mark:"background: rgba(26, 104, 64, 0.2); padding: 1px 2px; border-radius: 2px;",small:"font-size: 0.85em;",sup:"font-size: 0.75em; vertical-align: super;",sub:"font-size: 0.75em; vertical-align: sub;",link:"color: rgba(26, 104, 64, 1); text-decoration: underline; transition: color 0.2s ease;",cite:"display: block; margin-top: 0.5em; font-size: 0.9em; color: rgba(26, 104, 64, 0.7);"},header:{h1:'<section data-mpa-template="t" data-mpa-template-id="7371" data-mpa-category="style_single_material"><section style="width: 100%;padding: 0px 12px;" data-mid=""><section style="width: 100%;display: flex;align-items: center;justify-content: space-between;" data-mid=""><section style="display: flex;align-items: center;width: 100%;height: 5px;" data-mid=""><section style="flex-shrink: 0;width: 6px;height: 6px;background: #4499e7;border-radius: 50%;" data-mid=""><span leaf=""><br class="ProseMirror-trailingBreak"></span></section><section style="width: 100%;border-top: 1px solid #4499e7;height: 1px;" data-mid=""><span leaf=""><br class="ProseMirror-trailingBreak"></span></section></section><section style="flex-shrink: 0;min-width: 79px;text-align: center;background: #4499e7;padding: 5px 15px 4px 15px;" data-mid=""><p style="color: #ffffff;font-size: 16px;line-height: 17px;word-break: break-word;" data-mid=""><span leaf="">{{content}}</span><mpchecktext></mpchecktext></p></section><section style="display: flex;align-items: center;width: 100%;" data-mid=""><section style="width: 100%;border-top: 1px solid #4499e7;height: 1px;" data-mid=""><span leaf=""><br class="ProseMirror-trailingBreak"></span></section><section style="flex-shrink: 0;width: 6px;height: 6px;background: #4499e7;border-radius: 50%;" data-mid=""><span leaf=""><br class="ProseMirror-trailingBreak"></span></section></section></section></section></section>',h2:'<section data-block="header" data-level="2" style="text-indent: 0px; margin-bottom: 8px;">\n      <h2 style="font-size: 17px; color: rgba(26, 104, 64, 1); font-weight: bold; margin: 1.5em 8px 1em; border-bottom: 1px solid rgba(26, 104, 64, 0.3); padding-bottom: 0.3em;">\n        {{content}}\n      </h2>\n    </section>',h3:'<section data-block="header" data-level="3" style="text-indent: 0px; margin-bottom: 8px;">\n      <h3 style="font-size: 15px; color: rgba(26, 104, 64, 1); font-weight: bold; margin: 1.2em 8px 0.8em;">\n        {{content}}\n      </h3>\n    </section>',h4:'<section data-block="header" data-level="4" style="text-indent: 0px; margin-bottom: 8px;">\n      <h4 style="font-size: 14px; color: rgba(26, 104, 64, 1); font-weight: bold; margin: 1em 8px 0.6em;">\n        {{content}}\n      </h4>\n    </section>',h5:'<section data-block="header" data-level="5" style="text-indent: 0px; margin-bottom: 8px;">\n      <h5 style="font-size: 13px; color: rgba(26, 104, 64, 1); font-weight: bold; margin: 0.8em 8px 0.5em;">\n        {{content}}\n      </h5>\n    </section>',h6:'<section data-block="header" data-level="6" style="text-indent: 0px; margin-bottom: 8px;">\n      <h6 style="font-size: 12px; color: rgba(26, 104, 64, 1); font-weight: bold; margin: 0.6em 8px 0.4em;">\n        {{content}}\n      </h6>\n    </section>'},paragraph:{default:'<section mpa-font-style="mbraxlmy23cq" style="font-size: 14px; margin-bottom: 8px; line-height: 2em; margin-left: 32px; margin-right: 32px; visibility: visible;" data-mpa-action-id="mbraxlnm103x" data-pm-slice="0 0 []"><span leaf="" style="visibility: visible;"><span textstyle="" style="letter-spacing: 2px; visibility: visible;">{{content}}</span></span></section>'},quote:{default:'<section data-block="quote" style="text-indent: 0px; margin-bottom: 8px;">\n      <blockquote style="margin: 1.5em 8px; padding: 1em; border-left: 4px solid rgba(26, 104, 64, 0.5); background-color: rgba(26, 104, 64, 0.05); font-style: italic;">\n        {{content}}\n        {{caption}}\n      </blockquote>\n    </section>'},delimiter:{default:'<section data-block="delimiter" style="text-indent: 0px; margin-bottom: 8px;">\n      <div style="text-align: center; margin: 2em 8px; color: rgba(26, 104, 64, 0.6); font-size: 1.2em;">\n        ----\n      </div>\n    </section>'},raw:{default:""},list:{ordered:'<section data-block="list" data-style="ordered" style="text-indent: 0px; margin-bottom: 8px;">\n      <ol style="margin: 1.5em 8px; padding-left: 2em;">\n        {{items}}\n      </ol>\n    </section>',unordered:'<section data-block="list" data-style="unordered" style="text-indent: 0px; margin-bottom: 8px;">\n      <ul style="margin: 1.5em 8px; padding-left: 2em;">\n        {{items}}\n      </ul>\n    </section>'},code:{default:'<section data-block="code" style="text-indent: 0px; margin-bottom: 8px;">\n      <pre style="margin: 1.5em 8px; padding: 1em; background-color: rgba(26, 104, 64, 0.08); border-radius: 4px; overflow-x: auto;"><code style="font-family: \'Courier New\', monospace; font-size: 14px;">{{content}}</code></pre>\n    </section>'},listItem:'<li style="margin: 0.3em 0;">{{content}}</li>',fallback:{container:"margin: 1.5em 8px; padding: 0.5em; border: 1px dashed rgba(26, 104, 64, 0.3); background-color: rgba(26, 104, 64, 0.05);",warning:"color: rgba(26, 104, 64, 0.7); font-size: 0.8em;",content:"margin-top: 0.5em;"}};class o{constructor(t={}){this.templates=this.mergeTemplates(i,t)}mergeTemplates(t,e){const n={...t};for(const[i,o]of Object.entries(e))n[i]?n[i]={...n[i],...o}:n[i]=o;return n}parseBlock(t){if(!t||!t.type)return console.warn("无效的块数据:",t),"";const e=t.type,n=t.data||{};if("raw"===e)return n.html||"";const i=this.getTemplate(e,n);return i?this.renderTemplate(i,n,e):(console.warn(`未找到块类型 ${e} 的模板`),this.createFallbackHtml(t))}getTemplate(t,e){const n=this.templates[t];if(!n)return null;switch(t){case"header":return n[`h${Math.min(Math.max(e.level||1,1),6)}`]||n.default;case"list":return n["ordered"===e.style?"ordered":"unordered"]||n.default;default:return n.default||Object.values(n)[0]}}renderTemplate(t,e,n){let i=t;switch(n){case"header":case"paragraph":const t=this.sanitizeHtml(this.processInlineStyles(e.text||""));i=i.replace(/{{content}}/g,t);break;case"quote":const n=this.sanitizeHtml(this.processInlineStyles(e.text||""));i=i.replace(/{{content}}/g,n);const o=e.caption?`<cite style="${this.templates.inlineStyles.cite}">${this.sanitizeHtml(this.processInlineStyles(e.caption))}</cite>`:"";i=i.replace(/{{caption}}/g,o);break;case"list":const r=(e.items||[]).map((t=>{const e=this.sanitizeHtml(this.processInlineStyles(t));return this.renderListItem(e)})).join("");i=i.replace(/{{items}}/g,r);break;case"code":i=i.replace(/{{content}}/g,this.escapeHtml(e.code||""));break;case"delimiter":case"raw":break;default:const l=this.sanitizeHtml(this.processInlineStyles(e.text||e.content||""));i=i.replace(/{{content}}/g,l)}return i}renderListItem(t){return this.templates.listItem.replace(/{{content}}/g,t)}createFallbackHtml(t){var e,n,i;const o=(null==(e=t.data)?void 0:e.text)||(null==(n=t.data)?void 0:n.content)||(null==(i=t.data)?void 0:i.code)||"",r="code"===t.type?this.escapeHtml(o):this.sanitizeHtml(this.processInlineStyles(o)),l=this.templates.fallback;return`<section data-block="${t.type}" style="text-indent: 0px; margin-bottom: 8px;">\n      <div style="${l.container}">\n        <small style="${l.warning}">未知块类型: ${t.type}</small>\n        <div style="${l.content}">${r}</div>\n      </div>\n    </section>`}processInlineStyles(t){if(!t)return"";let e=String(t);const n=this.templates.inlineStyles,i={"<b>":`<strong style="${n.bold}">`,"</b>":"</strong>","<strong>":`<strong style="${n.bold}">`,"<i>":`<em style="${n.italic}">`,"</i>":"</em>","<em>":`<em style="${n.italic}">`,"<u>":`<u style="${n.underline}">`,"<s>":`<s style="${n.strikethrough}">`,"<del>":`<del style="${n.strikethrough}">`,"<code>":`<code style="${n.code}">`,"<mark>":`<mark style="${n.mark}">`,"<small>":`<small style="${n.small}">`,"<sup>":`<sup style="${n.sup}">`,"<sub>":`<sub style="${n.sub}">`};return e=this.processLinkTags(e),Object.entries(i).forEach((([t,n])=>{n.includes("style=")&&e.includes(t)||(e=e.replace(new RegExp(t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"g"),n))})),e}processLinkTags(t){const e=this.templates.inlineStyles.link;return t.replace(/<a\s+href=["']([^"']+)["']([^>]*)>/g,((t,n,i)=>{if(i.includes("style="))return t;try{const t=new URL(n);return"mp.weixin.qq.com"===t.hostname?`<a href="${n}" style="${e}"${i}>`:this.handleNonWeixinLink(n,i,e)}catch(o){return`<a href="${n}" style="${e}"${i}>`}}))}handleNonWeixinLink(t,e,n){return`<a href="${t}" style="${n}"${e}>`}sanitizeHtml(t){let e=t;return["script","iframe","object","embed","form"].forEach((t=>{const n=new RegExp(`<${t}[^>]*>.*?</${t}>`,"gi");e=e.replace(n,"")})),e}escapeHtml(t){return t?String(t).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;"):""}parse(t,e={}){const{skipEmpty:n=!0}=e;if(!t||!Array.isArray(t.blocks))return console.warn("无效的EditorJS数据"),"";const i=t.blocks.map((t=>this.parseBlock(t))).filter((t=>!n||t.trim())).join("\n");return[this.templates.head||"",i,this.templates.ending||"",'<section><span leaf=""><br class="ProseMirror-trailingBreak"></span></section>'].filter((t=>t.trim())).join("\n")}registerTemplate(t,e,n="default"){this.templates[t]||(this.templates[t]={}),"string"==typeof e?this.templates[t][n]=e:"object"==typeof e&&(this.templates[t]={...this.templates[t],...e})}setTemplate(t,e,n){this.templates[t]||(this.templates[t]={}),this.templates[t][e]=n}renderDocument(t,e={}){const{skipEmpty:n=!0,wrapInContainer:i=!1}=e;if(!t||!Array.isArray(t.blocks))return console.warn("无效的EditorJS数据"),"";const o=t.blocks.map((t=>this.parseBlock(t))).filter((t=>!n||t.trim())).join("\n");return i?`<div class="editorjs-content" style="max-width: 800px; margin: 0 auto; padding: 20px;">\n${o}\n</div>`:o}getAvailableTemplates(){return{...this.templates}}setTemplates(t){this.templates={...t}}}function r(t,e={}){const n=document.createElement(t);return e.className&&(n.className=e.className),e.id&&(n.id=e.id),e.innerHTML&&(n.innerHTML=e.innerHTML),e.textContent&&(n.textContent=e.textContent),e.cssText&&(n.style.cssText=e.cssText),n}function l(t,e=document){try{return e.querySelector(t)}catch(n){return console.error(`查询选择器失败: ${t}`,n),null}}async function s(t,e={}){try{const{targetSelector:i=n.editorContent,append:s=!0,insertPosition:a="cursor",styleOptions:c={}}=e,d=(new o).parse({blocks:t});console.log("生成的HTML内容:",d);const p=await async function(t,e={}){const{targetSelector:i=n.editorContent,append:o=!0,insertPosition:s="cursor"}=e;try{const e=l(i);if(!e)return console.error("找不到目标编辑器:",i),!1;const n=r("div",{innerHTML:t});if(o)for(;n.firstChild;)e.appendChild(n.firstChild);else switch(s){case"start":for(;n.lastChild;)e.insertBefore(n.lastChild,e.firstChild);break;case"end":for(;n.firstChild;)e.appendChild(n.firstChild);break;default:e.innerHTML=t}return console.log("内容插入成功"),!0}catch(a){return console.error("插入内容失败:",a),!1}}(d,{targetSelector:i,append:s,insertPosition:a});return p}catch(i){return console.error("保存到原编辑器失败:",i),!1}}function a(){return!(!window.EditorJSBundle||!window.EditorJSBundle.EditorJS)}function c(t){if(!document.getElementById(t))throw new Error(`${t}元素不存在，请检查DOM结构`);try{const n={holder:t,tools:function(t){const e={};for(const[n,i]of Object.entries(t)){const{class:t,...o}=i;if(!window.EditorJSBundle||!window.EditorJSBundle[t]){console.warn(`工具类 ${t} 未找到或未加载，跳过工具 ${n}`);continue}const r=window.EditorJSBundle[t];r?e[n]={class:r,...o}:console.warn(`工具类 ${t} 未加载，跳过工具 ${n}`)}return e}(e.tools),data:{blocks:[]},placeholder:e.placeholder,autofocus:e.autofocus,hideToolbar:e.hideToolbar,minHeight:e.minHeight,logLevel:e.logLevel,onReady:()=>{new window.EditorJSBundle.DragDrop(i)}},i=new window.EditorJSBundle.EditorJS(n);return i}catch(n){throw console.error("编辑器初始化失败:",n),n}}async function d(t){if(!a())try{await new Promise(((t,e)=>{chrome.runtime.sendMessage("inject_editorjs_bundle",(n=>{n&&"injected"===n.status?setTimeout((()=>{a()?t():e(new Error("编辑器脚本加载失败"))}),100):e(new Error("编辑器注入失败"))}))}))}catch(e){throw new Error("编辑器加载失败: "+e.message)}return c(t)}new o;const p=Math.min,f=Math.max,u=Math.round,h=Math.floor,m=t=>({x:t,y:t}),g={left:"right",right:"left",bottom:"top",top:"bottom"},x={start:"end",end:"start"};function y(t,e,n){return f(t,p(e,n))}function w(t,e){return"function"==typeof t?t(e):t}function b(t){return t.split("-")[0]}function v(t){return t.split("-")[1]}function k(t){return"x"===t?"y":"x"}function z(t){return"y"===t?"height":"width"}function C(t){return["top","bottom"].includes(b(t))?"y":"x"}function E(t){return k(C(t))}function L(t){return t.replace(/start|end/g,(t=>x[t]))}function F(t){return t.replace(/left|right|bottom|top/g,(t=>g[t]))}function $(t){const{x:e,y:n,width:i,height:o}=t;return{width:i,height:o,top:n,left:e,right:e+i,bottom:n+o,x:e,y:n}}function T(t,e,n){let{reference:i,floating:o}=t;const r=C(e),l=E(e),s=z(l),a=b(e),c="y"===r,d=i.x+i.width/2-o.width/2,p=i.y+i.height/2-o.height/2,f=i[s]/2-o[s]/2;let u;switch(a){case"top":u={x:d,y:i.y-o.height};break;case"bottom":u={x:d,y:i.y+i.height};break;case"right":u={x:i.x+i.width,y:p};break;case"left":u={x:i.x-o.width,y:p};break;default:u={x:i.x,y:i.y}}switch(v(e)){case"start":u[l]-=f*(n&&c?-1:1);break;case"end":u[l]+=f*(n&&c?-1:1)}return u}async function S(t,e){var n;void 0===e&&(e={});const{x:i,y:o,platform:r,rects:l,elements:s,strategy:a}=t,{boundary:c="clippingAncestors",rootBoundary:d="viewport",elementContext:p="floating",altBoundary:f=!1,padding:u=0}=w(e,t),h=function(t){return"number"!=typeof t?function(t){return{top:0,right:0,bottom:0,left:0,...t}}(t):{top:t,right:t,bottom:t,left:t}}(u),m=s[f?"floating"===p?"reference":"floating":p],g=$(await r.getClippingRect({element:null==(n=await(null==r.isElement?void 0:r.isElement(m)))||n?m:m.contextElement||await(null==r.getDocumentElement?void 0:r.getDocumentElement(s.floating)),boundary:c,rootBoundary:d,strategy:a})),x="floating"===p?{x:i,y:o,width:l.floating.width,height:l.floating.height}:l.reference,y=await(null==r.getOffsetParent?void 0:r.getOffsetParent(s.floating)),b=await(null==r.isElement?void 0:r.isElement(y))&&await(null==r.getScale?void 0:r.getScale(y))||{x:1,y:1},v=$(r.convertOffsetParentRelativeRectToViewportRelativeRect?await r.convertOffsetParentRelativeRectToViewportRelativeRect({elements:s,rect:x,offsetParent:y,strategy:a}):x);return{top:(g.top-v.top+h.top)/b.y,bottom:(v.bottom-g.bottom+h.bottom)/b.y,left:(g.left-v.left+h.left)/b.x,right:(v.right-g.right+h.right)/b.x}}function A(){return"undefined"!=typeof window}function R(t){return I(t)?(t.nodeName||"").toLowerCase():"#document"}function M(t){var e;return(null==t||null==(e=t.ownerDocument)?void 0:e.defaultView)||window}function B(t){var e;return null==(e=(I(t)?t.ownerDocument:t.document)||window.document)?void 0:e.documentElement}function I(t){return!!A()&&(t instanceof Node||t instanceof M(t).Node)}function H(t){return!!A()&&(t instanceof Element||t instanceof M(t).Element)}function j(t){return!!A()&&(t instanceof HTMLElement||t instanceof M(t).HTMLElement)}function P(t){return!(!A()||"undefined"==typeof ShadowRoot)&&(t instanceof ShadowRoot||t instanceof M(t).ShadowRoot)}function N(t){const{overflow:e,overflowX:n,overflowY:i,display:o}=W(t);return/auto|scroll|overlay|hidden|clip/.test(e+i+n)&&!["inline","contents"].includes(o)}function O(t){return["table","td","th"].includes(R(t))}function _(t){return[":popover-open",":modal"].some((e=>{try{return t.matches(e)}catch(n){return!1}}))}function D(t){const e=q(),n=H(t)?W(t):t;return["transform","translate","scale","rotate","perspective"].some((t=>!!n[t]&&"none"!==n[t]))||!!n.containerType&&"normal"!==n.containerType||!e&&!!n.backdropFilter&&"none"!==n.backdropFilter||!e&&!!n.filter&&"none"!==n.filter||["transform","translate","scale","rotate","perspective","filter"].some((t=>(n.willChange||"").includes(t)))||["paint","layout","strict","content"].some((t=>(n.contain||"").includes(t)))}function q(){return!("undefined"==typeof CSS||!CSS.supports)&&CSS.supports("-webkit-backdrop-filter","none")}function V(t){return["html","body","#document"].includes(R(t))}function W(t){return M(t).getComputedStyle(t)}function J(t){return H(t)?{scrollLeft:t.scrollLeft,scrollTop:t.scrollTop}:{scrollLeft:t.scrollX,scrollTop:t.scrollY}}function U(t){if("html"===R(t))return t;const e=t.assignedSlot||t.parentNode||P(t)&&t.host||B(t);return P(e)?e.host:e}function X(t){const e=U(t);return V(e)?t.ownerDocument?t.ownerDocument.body:t.body:j(e)&&N(e)?e:X(e)}function Q(t,e,n){var i;void 0===e&&(e=[]),void 0===n&&(n=!0);const o=X(t),r=o===(null==(i=t.ownerDocument)?void 0:i.body),l=M(o);if(r){const t=Y(l);return e.concat(l,l.visualViewport||[],N(o)?o:[],t&&n?Q(t):[])}return e.concat(o,Q(o,[],n))}function Y(t){return t.parent&&Object.getPrototypeOf(t.parent)?t.frameElement:null}function Z(t){const e=W(t);let n=parseFloat(e.width)||0,i=parseFloat(e.height)||0;const o=j(t),r=o?t.offsetWidth:n,l=o?t.offsetHeight:i,s=u(n)!==r||u(i)!==l;return s&&(n=r,i=l),{width:n,height:i,$:s}}function G(t){return H(t)?t:t.contextElement}function K(t){const e=G(t);if(!j(e))return m(1);const n=e.getBoundingClientRect(),{width:i,height:o,$:r}=Z(e);let l=(r?u(n.width):n.width)/i,s=(r?u(n.height):n.height)/o;return l&&Number.isFinite(l)||(l=1),s&&Number.isFinite(s)||(s=1),{x:l,y:s}}const tt=m(0);function et(t){const e=M(t);return q()&&e.visualViewport?{x:e.visualViewport.offsetLeft,y:e.visualViewport.offsetTop}:tt}function nt(t,e,n,i){void 0===e&&(e=!1),void 0===n&&(n=!1);const o=t.getBoundingClientRect(),r=G(t);let l=m(1);e&&(i?H(i)&&(l=K(i)):l=K(t));const s=function(t,e,n){return void 0===e&&(e=!1),!(!n||e&&n!==M(t))&&e}(r,n,i)?et(r):m(0);let a=(o.left+s.x)/l.x,c=(o.top+s.y)/l.y,d=o.width/l.x,p=o.height/l.y;if(r){const t=M(r),e=i&&H(i)?M(i):i;let n=t,o=Y(n);for(;o&&i&&e!==n;){const t=K(o),e=o.getBoundingClientRect(),i=W(o),r=e.left+(o.clientLeft+parseFloat(i.paddingLeft))*t.x,l=e.top+(o.clientTop+parseFloat(i.paddingTop))*t.y;a*=t.x,c*=t.y,d*=t.x,p*=t.y,a+=r,c+=l,n=M(o),o=Y(n)}}return $({width:d,height:p,x:a,y:c})}function it(t,e){const n=J(t).scrollLeft;return e?e.left+n:nt(B(t)).left+n}function ot(t,e,n){void 0===n&&(n=!1);const i=t.getBoundingClientRect();return{x:i.left+e.scrollLeft-(n?0:it(t,i)),y:i.top+e.scrollTop}}function rt(t,e,n){let i;if("viewport"===e)i=function(t,e){const n=M(t),i=B(t),o=n.visualViewport;let r=i.clientWidth,l=i.clientHeight,s=0,a=0;if(o){r=o.width,l=o.height;const t=q();(!t||t&&"fixed"===e)&&(s=o.offsetLeft,a=o.offsetTop)}return{width:r,height:l,x:s,y:a}}(t,n);else if("document"===e)i=function(t){const e=B(t),n=J(t),i=t.ownerDocument.body,o=f(e.scrollWidth,e.clientWidth,i.scrollWidth,i.clientWidth),r=f(e.scrollHeight,e.clientHeight,i.scrollHeight,i.clientHeight);let l=-n.scrollLeft+it(t);const s=-n.scrollTop;return"rtl"===W(i).direction&&(l+=f(e.clientWidth,i.clientWidth)-o),{width:o,height:r,x:l,y:s}}(B(t));else if(H(e))i=function(t,e){const n=nt(t,!0,"fixed"===e),i=n.top+t.clientTop,o=n.left+t.clientLeft,r=j(t)?K(t):m(1);return{width:t.clientWidth*r.x,height:t.clientHeight*r.y,x:o*r.x,y:i*r.y}}(e,n);else{const n=et(t);i={x:e.x-n.x,y:e.y-n.y,width:e.width,height:e.height}}return $(i)}function lt(t,e){const n=U(t);return!(n===e||!H(n)||V(n))&&("fixed"===W(n).position||lt(n,e))}function st(t,e,n){const i=j(e),o=B(e),r="fixed"===n,l=nt(t,!0,r,e);let s={scrollLeft:0,scrollTop:0};const a=m(0);function c(){a.x=it(o)}if(i||!i&&!r)if(("body"!==R(e)||N(o))&&(s=J(e)),i){const t=nt(e,!0,r,e);a.x=t.x+e.clientLeft,a.y=t.y+e.clientTop}else o&&c();r&&!i&&o&&c();const d=!o||i||r?m(0):ot(o,s);return{x:l.left+s.scrollLeft-a.x-d.x,y:l.top+s.scrollTop-a.y-d.y,width:l.width,height:l.height}}function at(t){return"static"===W(t).position}function ct(t,e){if(!j(t)||"fixed"===W(t).position)return null;if(e)return e(t);let n=t.offsetParent;return B(t)===n&&(n=n.ownerDocument.body),n}function dt(t,e){const n=M(t);if(_(t))return n;if(!j(t)){let e=U(t);for(;e&&!V(e);){if(H(e)&&!at(e))return e;e=U(e)}return n}let i=ct(t,e);for(;i&&O(i)&&at(i);)i=ct(i,e);return i&&V(i)&&at(i)&&!D(i)?n:i||function(t){let e=U(t);for(;j(e)&&!V(e);){if(D(e))return e;if(_(e))return null;e=U(e)}return null}(t)||n}const pt={convertOffsetParentRelativeRectToViewportRelativeRect:function(t){let{elements:e,rect:n,offsetParent:i,strategy:o}=t;const r="fixed"===o,l=B(i),s=!!e&&_(e.floating);if(i===l||s&&r)return n;let a={scrollLeft:0,scrollTop:0},c=m(1);const d=m(0),p=j(i);if((p||!p&&!r)&&(("body"!==R(i)||N(l))&&(a=J(i)),j(i))){const t=nt(i);c=K(i),d.x=t.x+i.clientLeft,d.y=t.y+i.clientTop}const f=!l||p||r?m(0):ot(l,a,!0);return{width:n.width*c.x,height:n.height*c.y,x:n.x*c.x-a.scrollLeft*c.x+d.x+f.x,y:n.y*c.y-a.scrollTop*c.y+d.y+f.y}},getDocumentElement:B,getClippingRect:function(t){let{element:e,boundary:n,rootBoundary:i,strategy:o}=t;const r=[..."clippingAncestors"===n?_(e)?[]:function(t,e){const n=e.get(t);if(n)return n;let i=Q(t,[],!1).filter((t=>H(t)&&"body"!==R(t))),o=null;const r="fixed"===W(t).position;let l=r?U(t):t;for(;H(l)&&!V(l);){const e=W(l),n=D(l);n||"fixed"!==e.position||(o=null),(r?!n&&!o:!n&&"static"===e.position&&o&&["absolute","fixed"].includes(o.position)||N(l)&&!n&&lt(t,l))?i=i.filter((t=>t!==l)):o=e,l=U(l)}return e.set(t,i),i}(e,this._c):[].concat(n),i],l=r[0],s=r.reduce(((t,n)=>{const i=rt(e,n,o);return t.top=f(i.top,t.top),t.right=p(i.right,t.right),t.bottom=p(i.bottom,t.bottom),t.left=f(i.left,t.left),t}),rt(e,l,o));return{width:s.right-s.left,height:s.bottom-s.top,x:s.left,y:s.top}},getOffsetParent:dt,getElementRects:async function(t){const e=this.getOffsetParent||dt,n=this.getDimensions,i=await n(t.floating);return{reference:st(t.reference,await e(t.floating),t.strategy),floating:{x:0,y:0,width:i.width,height:i.height}}},getClientRects:function(t){return Array.from(t.getClientRects())},getDimensions:function(t){const{width:e,height:n}=Z(t);return{width:e,height:n}},getScale:K,isElement:H,isRTL:function(t){return"rtl"===W(t).direction}};function ft(t,e){return t.x===e.x&&t.y===e.y&&t.width===e.width&&t.height===e.height}function ut(t,e,n,i){void 0===i&&(i={});const{ancestorScroll:o=!0,ancestorResize:r=!0,elementResize:l="function"==typeof ResizeObserver,layoutShift:s="function"==typeof IntersectionObserver,animationFrame:a=!1}=i,c=G(t),d=o||r?[...c?Q(c):[],...Q(e)]:[];d.forEach((t=>{o&&t.addEventListener("scroll",n,{passive:!0}),r&&t.addEventListener("resize",n)}));const u=c&&s?function(t,e){let n,i=null;const o=B(t);function r(){var t;clearTimeout(n),null==(t=i)||t.disconnect(),i=null}return function l(s,a){void 0===s&&(s=!1),void 0===a&&(a=1),r();const c=t.getBoundingClientRect(),{left:d,top:u,width:m,height:g}=c;if(s||e(),!m||!g)return;const x={rootMargin:-h(u)+"px "+-h(o.clientWidth-(d+m))+"px "+-h(o.clientHeight-(u+g))+"px "+-h(d)+"px",threshold:f(0,p(1,a))||1};let y=!0;function w(e){const i=e[0].intersectionRatio;if(i!==a){if(!y)return l();i?l(!1,i):n=setTimeout((()=>{l(!1,1e-7)}),1e3)}1!==i||ft(c,t.getBoundingClientRect())||l(),y=!1}try{i=new IntersectionObserver(w,{...x,root:o.ownerDocument})}catch(b){i=new IntersectionObserver(w,x)}i.observe(t)}(!0),r}(c,n):null;let m,g=-1,x=null;l&&(x=new ResizeObserver((t=>{let[i]=t;i&&i.target===c&&x&&(x.unobserve(e),cancelAnimationFrame(g),g=requestAnimationFrame((()=>{var t;null==(t=x)||t.observe(e)}))),n()})),c&&!a&&x.observe(c),x.observe(e));let y=a?nt(t):null;return a&&function e(){const i=nt(t);y&&!ft(y,i)&&n();y=i,m=requestAnimationFrame(e)}(),n(),()=>{var t;d.forEach((t=>{o&&t.removeEventListener("scroll",n),r&&t.removeEventListener("resize",n)})),null==u||u(),null==(t=x)||t.disconnect(),x=null,a&&cancelAnimationFrame(m)}}const ht=function(t){return void 0===t&&(t=0),{name:"offset",options:t,async fn(e){var n,i;const{x:o,y:r,placement:l,middlewareData:s}=e,a=await async function(t,e){const{placement:n,platform:i,elements:o}=t,r=await(null==i.isRTL?void 0:i.isRTL(o.floating)),l=b(n),s=v(n),a="y"===C(n),c=["left","top"].includes(l)?-1:1,d=r&&a?-1:1,p=w(e,t);let{mainAxis:f,crossAxis:u,alignmentAxis:h}="number"==typeof p?{mainAxis:p,crossAxis:0,alignmentAxis:null}:{mainAxis:p.mainAxis||0,crossAxis:p.crossAxis||0,alignmentAxis:p.alignmentAxis};return s&&"number"==typeof h&&(u="end"===s?-1*h:h),a?{x:u*d,y:f*c}:{x:f*c,y:u*d}}(e,t);return l===(null==(n=s.offset)?void 0:n.placement)&&null!=(i=s.arrow)&&i.alignmentOffset?{}:{x:o+a.x,y:r+a.y,data:{...a,placement:l}}}}},mt=function(t){return void 0===t&&(t={}),{name:"shift",options:t,async fn(e){const{x:n,y:i,placement:o}=e,{mainAxis:r=!0,crossAxis:l=!1,limiter:s={fn:t=>{let{x:e,y:n}=t;return{x:e,y:n}}},...a}=w(t,e),c={x:n,y:i},d=await S(e,a),p=C(b(o)),f=k(p);let u=c[f],h=c[p];if(r){const t="y"===f?"bottom":"right";u=y(u+d["y"===f?"top":"left"],u,u-d[t])}if(l){const t="y"===p?"bottom":"right";h=y(h+d["y"===p?"top":"left"],h,h-d[t])}const m=s.fn({...e,[f]:u,[p]:h});return{...m,data:{x:m.x-n,y:m.y-i,enabled:{[f]:r,[p]:l}}}}}},gt=function(t){return void 0===t&&(t={}),{name:"flip",options:t,async fn(e){var n,i;const{placement:o,middlewareData:r,rects:l,initialPlacement:s,platform:a,elements:c}=e,{mainAxis:d=!0,crossAxis:p=!0,fallbackPlacements:f,fallbackStrategy:u="bestFit",fallbackAxisSideDirection:h="none",flipAlignment:m=!0,...g}=w(t,e);if(null!=(n=r.arrow)&&n.alignmentOffset)return{};const x=b(o),y=C(s),k=b(s)===s,$=await(null==a.isRTL?void 0:a.isRTL(c.floating)),T=f||(k||!m?[F(s)]:function(t){const e=F(t);return[L(t),e,L(e)]}(s)),A="none"!==h;!f&&A&&T.push(...function(t,e,n,i){const o=v(t);let r=function(t,e,n){const i=["left","right"],o=["right","left"],r=["top","bottom"],l=["bottom","top"];switch(t){case"top":case"bottom":return n?e?o:i:e?i:o;case"left":case"right":return e?r:l;default:return[]}}(b(t),"start"===n,i);return o&&(r=r.map((t=>t+"-"+o)),e&&(r=r.concat(r.map(L)))),r}(s,m,h,$));const R=[s,...T],M=await S(e,g),B=[];let I=(null==(i=r.flip)?void 0:i.overflows)||[];if(d&&B.push(M[x]),p){const t=function(t,e,n){void 0===n&&(n=!1);const i=v(t),o=E(t),r=z(o);let l="x"===o?i===(n?"end":"start")?"right":"left":"start"===i?"bottom":"top";return e.reference[r]>e.floating[r]&&(l=F(l)),[l,F(l)]}(o,l,$);B.push(M[t[0]],M[t[1]])}if(I=[...I,{placement:o,overflows:B}],!B.every((t=>t<=0))){var H,j;const t=((null==(H=r.flip)?void 0:H.index)||0)+1,e=R[t];if(e){if(!("alignment"===p&&y!==C(e))||I.every((t=>t.overflows[0]>0&&C(t.placement)===y)))return{data:{index:t,overflows:I},reset:{placement:e}}}let n=null==(j=I.filter((t=>t.overflows[0]<=0)).sort(((t,e)=>t.overflows[1]-e.overflows[1]))[0])?void 0:j.placement;if(!n)switch(u){case"bestFit":{var P;const t=null==(P=I.filter((t=>{if(A){const e=C(t.placement);return e===y||"y"===e}return!0})).map((t=>[t.placement,t.overflows.filter((t=>t>0)).reduce(((t,e)=>t+e),0)])).sort(((t,e)=>t[1]-e[1]))[0])?void 0:P[0];t&&(n=t);break}case"initialPlacement":n=s}if(o!==n)return{reset:{placement:n}}}return{}}}},xt=(t,e,n)=>{const i=new Map,o={platform:pt,...n},r={...o.platform,_c:i};return(async(t,e,n)=>{const{placement:i="bottom",strategy:o="absolute",middleware:r=[],platform:l}=n,s=r.filter(Boolean),a=await(null==l.isRTL?void 0:l.isRTL(e));let c=await l.getElementRects({reference:t,floating:e,strategy:o}),{x:d,y:p}=T(c,i,a),f=i,u={},h=0;for(let m=0;m<s.length;m++){const{name:n,fn:r}=s[m],{x:g,y:x,data:y,reset:w}=await r({x:d,y:p,initialPlacement:i,placement:f,strategy:o,middlewareData:u,rects:c,platform:l,elements:{reference:t,floating:e}});d=null!=g?g:d,p=null!=x?x:p,u={...u,[n]:{...u[n],...y}},w&&h<=50&&(h++,"object"==typeof w&&(w.placement&&(f=w.placement),w.rects&&(c=!0===w.rects?await l.getElementRects({reference:t,floating:e,strategy:o}):w.rects),({x:d,y:p}=T(c,f,a))),m=-1)}return{x:d,y:p,placement:f,strategy:o,middlewareData:u}})(t,e,{...o,platform:r})};let yt=null;let wt=null;async function bt(){try{await async function(){if(vt)return void console.debug("智能编辑器已经激活");if(!l(n.editorContent))return void alert("找不到编辑器容器");try{!function(){const t=r("div",{id:"smart-editor-container",className:"flowedit-editor-container"}),e=l(n.editorContent);if(!e)throw console.error("无法找到合适的参考元素来定位智能编辑器，请检查页面结构"),new Error("无法找到合适的参考元素来定位智能编辑器");const i=l(n.editorWrapper);i?i.appendChild(t):document.body.appendChild(t);const o=async()=>{const{x:n,y:i}=await xt(e,t,{strategy:"fixed",middleware:[{name:"cover",fn:({rects:t})=>({x:t.reference.x,y:t.reference.y})},{name:"size",fn:({rects:t})=>({data:{width:t.reference.width,height:t.reference.height}})}]});Object.assign(t.style,{position:"fixed",left:n-70+"px",top:`${i}px`,width:`${e.offsetWidth+160}px`,height:`${e.offsetHeight}px`}),console.log("智能编辑器定位模式: 完全覆盖 (Floating UI)")};o(),yt=ut(e,t,o);const s=r("div",{id:"editor-holder",className:"flowedit-editor-holder"});t.appendChild(s),console.log("智能编辑器界面创建完成，使用 Floating UI 定位")}(),kt=function(t={}){const{onSave:e,onCancel:i}=t,o=r("div",{className:"flowedit-editor-action-bar"}),s=r("button",{textContent:"💾 保存",className:"flowedit-editor-save-btn"}),a=r("button",{textContent:"↩️ 取消",className:"flowedit-editor-cancel-btn"}),c=r("div",{className:"spacer"});o.appendChild(s),o.appendChild(a),o.appendChild(c);const d=l(n.botBar);if(d){document.body.appendChild(o);const t=()=>{xt(d,o,{strategy:"fixed",middleware:[{name:"cover",fn:({rects:t})=>({x:t.reference.x,y:t.reference.y})},{name:"size",fn:({rects:t})=>({data:{width:t.reference.width,height:t.reference.height}})}]}).then((({x:t,y:e})=>{const n=d.getBoundingClientRect();Object.assign(o.style,{left:`${t}px`,top:`${e}px`,width:`${n.width}px`,height:`${n.height}px`})}))};t(),wt=ut(d,o,t)}else console.warn("找不到botBar元素，将控制栏添加到body并使用默认定位"),document.body.appendChild(o);return e&&"function"==typeof e&&s.addEventListener("click",e),i&&"function"==typeof i&&a.addEventListener("click",i),console.log("智能编辑器控制栏创建完成，使用 Floating UI 定位"),o}({onSave:Lt,onCancel:Et}),await new Promise((t=>setTimeout(t,50))),vt=await d("editor-holder"),console.log("智能编辑器激活成功")}catch(t){console.error("智能插入功能启动失败:",t),alert("智能插入功能启动失败"),Et()}}()}catch(t){console.error("智能插入按钮点击处理失败:",t)}}let vt=null,kt=null,zt=null;function Ct(){if(zt)console.warn("智能插入按钮功能已经初始化");else try{zt=function(){const t=r("button",{className:"flowedit-smart-btn flowedit-btn-fixed",textContent:"智能插入"});t.addEventListener("click",bt),document.body.appendChild(t);const e=l(n.toolbar);if(!e)throw new Error(`工具栏容器未找到: ${n.toolbar}`);const i=e.lastElementChild||e;return xt(i,t,{placement:"right-start",middleware:[ht(i.offsetWidth),gt(),mt({padding:8})]}).then((({x:e,y:n})=>{Object.assign(t.style,{left:`${e}px`,top:`${n}px`})})),{element:t,cleanup:()=>{t.parentNode&&t.parentNode.removeChild(t)}}}(),console.log("智能插入按钮成功")}catch(t){console.error("智能编辑器功能初始化失败:",t)}}function Et(){var t;!function(){yt&&(yt(),yt=null);const t=document.getElementById("smart-editor-container");t&&(t.remove(),console.log("智能编辑器界面已移除"))}(),kt&&(t=kt,wt&&(wt(),wt=null),t&&(t.remove(),console.log("智能编辑器控制栏已移除")),kt=null),vt&&(!function(t){if(t)try{t.destroy()}catch(e){console.warn("编辑器销毁错误:",e)}}(vt),vt=null),console.log("智能编辑器已停用")}async function Lt(t={}){if(vt)try{const e=await vt.save();console.log("保存的数据:",e);await s(e.blocks,{...t})?console.log("内容已成功保存到原编辑器"):console.error("保存到原编辑器失败")}catch(e){console.error("保存失败:",e)}finally{Et()}else console.error("编辑器未初始化")}const Ft={name:"smart-editor",initialize:async()=>{Ct()},cleanup:()=>{Et(),zt&&zt.cleanup&&(zt.cleanup(),zt=null,console.log("智能编辑器功能已清理"))},isEnabled:()=>!0,isActive:()=>null!==vt};function $t(t){const e=document.querySelector(n.sidebar);if(e){const n="none"===e.style.display;if(e.style.display=n?"":"none",t&&t.currentTarget){const e=t.currentTarget;n?e.classList.add("on"):e.classList.remove("on")}}}let Tt=null;function St(){if(Tt)console.warn("侧边栏功能已经初始化");else try{Tt=function(){const t=r("button",{className:"flowedit-switch flowedit-switch-fixed",innerHTML:'\n      <div class="flowedit-switch-track"></div>\n      <div class="flowedit-switch-thumb"></div>\n    '});t.addEventListener("click",$t),document.body.appendChild(t);const e=l(n.toolbar);if(!e)throw new Error(`工具栏容器未找到: ${n.toolbar}`);const i=e.firstElementChild||e;return xt(i,t,{placement:"left-start",middleware:[ht(-i.offsetWidth),gt(),mt({padding:8})]}).then((({x:e,y:n})=>{Object.assign(t.style,{left:`${e}px`,top:`${n}px`})})),{element:t,cleanup:()=>{t.parentNode&&t.parentNode.removeChild(t)}}}(),console.log("侧边栏功能初始化成功")}catch(t){console.error("侧边栏功能初始化失败:",t)}}const At={name:"sidebar",initialize:async()=>{St()},cleanup:()=>{Tt&&Tt.cleanup&&(Tt.cleanup(),Tt=null,console.log("侧边栏功能已清理"))},isEnabled:()=>!0,isActive:()=>null!==Tt};const Rt=new class{constructor(){this.config={},this.initialized=!1}async initialize(){try{console.log("初始化用户配置管理器..."),this.initialized=!0,console.log("用户配置管理器初始化完成")}catch(t){throw console.error("用户配置管理器初始化失败:",t),t}}getUserConfig(t){return this.initialized?t?this.config[t]:this.config:(console.warn("用户配置管理器未初始化"),null)}async setUserConfig(t,e){try{return this.initialized?("object"==typeof t?this.config={...this.config,...t}:this.config[t]=e,console.log("用户配置已更新:",t),!0):(console.warn("用户配置管理器未初始化"),!1)}catch(n){return console.error("设置用户配置失败:",n),!1}}},Mt=new class{constructor(){this.initialized=!1,this.styleCache={},this.syncInterval=null}async initialize(){try{console.log("初始化远程样式同步服务..."),this.initialized=!0,console.log("远程样式同步服务初始化完成")}catch(t){throw console.error("远程样式同步服务初始化失败:",t),t}}async manualSync(){try{return this.initialized?(console.log("开始手动同步远程样式..."),console.log("远程样式同步完成"),!0):(console.warn("远程样式同步服务未初始化"),!1)}catch(t){return console.error("远程样式同步失败:",t),!1}}startAutoSync(t=3e4){this.syncInterval&&clearInterval(this.syncInterval),this.syncInterval=setInterval((async()=>{await this.manualSync()}),t),console.log(`远程样式自动同步已启动，间隔: ${t}ms`)}stopAutoSync(){this.syncInterval&&(clearInterval(this.syncInterval),this.syncInterval=null,console.log("远程样式自动同步已停止"))}};async function Bt(t={}){try{return console.log("开始初始化FlowEdit应用服务..."),await Rt.initialize(),await async function(t={}){try{if(await Mt.initialize(),!1!==t.enableAutoSync){const e=t.syncInterval||3e4;Mt.startAutoSync(e)}!1!==t.initialSync&&await Mt.manualSync(),console.log("远程样式系统初始化完成")}catch(e){console.error("远程样式系统初始化失败:",e)}}(t),console.log("FlowEdit应用服务初始化完成"),!0}catch(e){return console.error("FlowEdit应用服务初始化失败:",e),!1}}async function It(){if(!document.querySelector("#js_toolbar_0"))return void console.log("FlowEdit 插件功能模块初始化失败：页面可能未登录");!function(){const t="flow-editor-plugin-styles";if(!document.getElementById(t)){const e=document.createElement("style");e.id=t,e.setAttribute("data-flowedit-plugin-ui","true"),e.textContent="\n      /* FlowEdit 插件UI样式 */\n      \n  /* 扩展按钮基础样式 */\n    .flowedit-smart-btn {\n    /* 基础样式 */\n    display: inline-block;\n    height: 22px;\n    cursor: pointer;\n    border: none;\n    outline: none;\n    box-sizing: border-box;\n    \n    /* 特定样式 */\n    background-color: #07c160;\n    color: white;\n    border-radius: 4px;\n    padding: 0 12px;\n    font-size: 12px;\n    line-height: 22px;\n    transition: all 0.3s ease;\n  }\n\n    /* 固定定位按钮样式 */\n  .flowedit-btn-fixed {\n    position: fixed;\n    z-index: 100;\n  }\n  \n  /* 智能插入按钮悬浮效果 */\n  .flowedit-smart-btn:hover {\n    background-color: #07c160;\n    background-image: linear-gradient(to bottom, #07C160 0, #07C160 100%);\n    border-color: #07C160;\n    color: #FFFFFF;\n    transform: translateY(-1px);\n    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);\n  }\n\n      \n  /* Switch开关样式 */\n  .flowedit-switch {\n    display: inline-block;\n    height: 22px;\n    cursor: pointer;\n    position: relative;\n    width: 40px;\n    border: none;\n    outline: none;\n    box-sizing: border-box;\n  }\n\n    /* 固定定位的开关样式 */\n  .flowedit-switch-fixed {\n    position: fixed;\n    z-index: 100;\n  }\n  \n  .flowedit-switch-track {\n    position: absolute;\n    top: 0;\n    left: 0;\n    right: 0;\n    bottom: 0;\n    background-color: #ccc;\n    border-radius: 11px;\n    transition: all 0.3s ease;\n  }\n  \n  .flowedit-switch-thumb {\n    position: absolute;\n    width: 18px;\n    height: 18px;\n    left: 2px;\n    bottom: 2px;\n    background-color: white;\n    border-radius: 50%;\n    transition: transform 0.3s ease;\n  }\n  \n  .flowedit-switch.on .flowedit-switch-track {\n    background-color: #07c160;\n  }\n  \n  .flowedit-switch.on .flowedit-switch-thumb {\n    transform: translateX(18px);\n  }\n\n      \n  /* 智能插入编辑器容器样式 */\n  .flowedit-editor-container {\n    position: fixed; /* 统一使用 fixed */\n    background: #fff;\n    border-radius: 4px;\n    box-sizing: border-box;\n    overflow: hidden;\n    padding: 0 30px 0 55px;\n    z-index: 10;\n  }\n  \n  /* 智能插入编辑器占位元素样式 */\n  .flowedit-editor-holder {\n    padding: 0;\n  }\n  \n  /* 智能插入控制栏样式 */\n  .flowedit-editor-action-bar {\n    position: fixed; /* 统一使用 fixed */\n    background-color: #ffffff;\n    display: flex;\n    justify-content: flex-end;\n    align-items: center; /* 上下居中对齐 */\n    gap: 15px;\n    z-index: 120; /* 统一层级值 */\n    bottom: 0; /* 固定在底部 */\n  }\n\n  /* 透明占位元素样式 */\n  .spacer {\n    width: 20px; /* 控制右边距 */\n    height: 1px; /* 无实际高度，仅占位 */\n  }\n  \n  /* 智能插入保存按钮样式 */\n  .flowedit-editor-save-btn {\n    padding: 4px 12px;\n    height: 34px;\n    width: 98px;\n    display: inline-block;\n    background: #07c160;\n    color: white;\n    border: none;\n    border-radius: 4px;\n    cursor: pointer;\n    font-size: 14px;\n    transition: all 0.3s ease;\n  }\n  \n\n  \n  /* 智能插入取消按钮样式 */\n  .flowedit-editor-cancel-btn {\n    padding: 4px 12px;\n    height: 34px;\n    width: 98px;\n    display: inline-block;\n    background: #999999;\n    color: white;\n    border: none;\n    border-radius: 4px;\n    cursor: pointer;\n    font-size: 14px;\n    transition: all 0.3s ease;\n  }\n\n    ",document.head.appendChild(e),console.log("FlowEdit 插件UI样式已注入")}}();const e=await t.initializeAll();e.success.length>0&&console.log(`成功初始化功能模块: ${e.success.join(", ")}`),e.failed.length>0&&console.warn(`初始化失败的功能模块: ${e.failed.join(", ")}`),console.log("FlowEdit 插件功能模块初始化完成")}t.register("smart-editor",Ft),t.register("sidebar",At),async function(){console.log("FlowEdit 内容脚本启动"),"loading"===document.readyState&&await new Promise((t=>{document.addEventListener("DOMContentLoaded",t)}));try{await Bt(),console.log("FlowEdit 应用服务初始化成功")}catch(t){console.error("FlowEdit 应用服务初始化失败:",t)}await It()}().catch((t=>{console.error("FlowEdit 启动失败:",t)}))}();
