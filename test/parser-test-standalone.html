<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlowEdit Parser æµ‹è¯• - ä¼˜åŒ–ç‰ˆæœ¬</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f8f9fa;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }
        button:hover {
            background: #0056b3;
        }
        button.success {
            background: #28a745;
        }
        button.success:hover {
            background: #1e7e34;
        }
        button.warning {
            background: #ffc107;
            color: #212529;
        }
        button.warning:hover {
            background: #e0a800;
        }
        .results-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        .panel {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .panel h3 {
            margin-top: 0;
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        .console-output {
            background: #1e1e1e;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            overflow-y: auto;
            max-height: 400px;
            min-height: 200px;
        }
        .html-preview {
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            background: white;
            overflow-y: auto;
            max-height: 400px;
            min-height: 200px;
        }
        .status {
            text-align: center;
            padding: 15px;
            margin: 15px 0;
            border-radius: 6px;
            font-weight: 500;
        }
        .status.info {
            background: #e3f2fd;
            color: #1976d2;
            border: 1px solid #90caf9;
        }
        .status.success {
            background: #e8f5e8;
            color: #2e7d32;
            border: 1px solid #81c784;
        }
        .status.error {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ef5350;
        }
        .tabs {
            display: flex;
            border-bottom: 1px solid #dee2e6;
            margin-bottom: 15px;
        }
        .tab {
            padding: 10px 20px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-bottom: none;
            cursor: pointer;
            margin-right: 5px;
            border-radius: 4px 4px 0 0;
        }
        .tab.active {
            background: white;
            border-bottom: 1px solid white;
            margin-bottom: -1px;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #007bff;
        }
        .loading.show {
            display: block;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        .stat-label {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
        .version-info {
            background: #f8f9fa;
            padding: 10px 15px;
            border-radius: 6px;
            margin: 15px 0;
            border: 1px solid #dee2e6;
        }
        .version-info .title {
            font-weight: 600;
            color: #10b981;
            margin-bottom: 5px;
        }
        .version-info .features {
            font-size: 14px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸš€ FlowEdit Parser æµ‹è¯• - ä¼˜åŒ–ç‰ˆæœ¬</h1>
        <p>ä½¿ç”¨æ–°çš„è§£ææ¨¡å—ï¼ŒåŒ…å«é”™è¯¯å¤„ç†ã€è§£è€¦æ¶æ„å’Œå ä½ç¬¦æ¡ä»¶æ¸²æŸ“</p>
        <div class="version-info">
            <div class="title">âœ¨ æ–°åŠŸèƒ½ç‰¹æ€§</div>
            <div class="features">
                ç»Ÿä¸€é”™è¯¯å¤„ç† â€¢ è§£è€¦æ¶æ„ â€¢ å ä½ç¬¦æ¡ä»¶æ¸²æŸ“ {{?field}} â€¢ ç®€åŒ–Listæ¨¡æ¿ â€¢ æ¨¡æ¿éªŒè¯å™¨
            </div>
        </div>
    </div>

    <div class="controls">
        <button id="runAllTestsBtn" class="success">ğŸ§ª è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
        <button id="showSimplePreviewBtn">ğŸ“ ç®€å•ç¤ºä¾‹é¢„è§ˆ</button>
        <button id="showFullPreviewBtn">ğŸ“š å®Œæ•´ç¤ºä¾‹é¢„è§ˆ</button>
        <button id="testNewFeaturesBtn">âš¡ æ–°åŠŸèƒ½æµ‹è¯•</button>
        <button id="testQuoteBtn">ğŸ’¬ æµ‹è¯•Quoteæ¸²æŸ“</button>
        <button id="clearResultsBtn" class="warning">ğŸ—‘ï¸ æ¸…ç©ºç»“æœ</button>
    </div>

    <div id="status" class="status info">
        ç‚¹å‡»"è¿è¡Œæ‰€æœ‰æµ‹è¯•"å¼€å§‹æµ‹è¯•ä¼˜åŒ–ç‰ˆæœ¬ Parser åŠŸèƒ½
    </div>

    <div id="loading" class="loading">
        <div>ğŸ”„ æ­£åœ¨è¿è¡Œæµ‹è¯•...</div>
    </div>

    <div id="stats" class="stats" style="display: none;">
        <div class="stat-card">
            <div id="test-count" class="stat-value">0</div>
            <div class="stat-label">æµ‹è¯•æ€»æ•°</div>
        </div>
        <div class="stat-card">
            <div id="pass-count" class="stat-value">0</div>
            <div class="stat-label">é€šè¿‡æµ‹è¯•</div>
        </div>
        <div class="stat-card">
            <div id="avg-time" class="stat-value">0ms</div>
            <div class="stat-label">å¹³å‡è€—æ—¶</div>
        </div>
        <div class="stat-card">
            <div id="total-blocks" class="stat-value">0</div>
            <div class="stat-label">å¤„ç†å—æ•°</div>
        </div>
    </div>

    <div class="results-container">
        <div class="panel">
            <h3>ğŸ“Š æ§åˆ¶å°è¾“å‡º</h3>
            <div id="console-output" class="console-output">
ç­‰å¾…æµ‹è¯•è¿è¡Œ...
            </div>
        </div>

        <div class="panel">
            <h3>ğŸ¨ HTMLé¢„è§ˆ</h3>
            <div class="tabs">
                <div class="tab active" id="simple-tab">ç®€å•ç¤ºä¾‹</div>
                <div class="tab" id="full-tab">å®Œæ•´ç¤ºä¾‹</div>
                <div class="tab" id="new-features-tab">æ–°åŠŸèƒ½å±•ç¤º</div>
                <div class="tab" id="html-source-tab">HTMLæºç </div>
            </div>
            
            <div id="simple-preview" class="tab-content active">
                <div id="simple-html" class="html-preview">
                    ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æŸ¥çœ‹é¢„è§ˆ
                </div>
            </div>
            
            <div id="full-preview" class="tab-content">
                <div id="full-html" class="html-preview">
                    ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æŸ¥çœ‹é¢„è§ˆ
                </div>
            </div>

            <div id="new-features" class="tab-content">
                <div id="new-features-html" class="html-preview">
                    ç‚¹å‡»"æ–°åŠŸèƒ½æµ‹è¯•"æˆ–"æµ‹è¯•Quoteæ¸²æŸ“"æŸ¥çœ‹å ä½ç¬¦æ¡ä»¶æ¸²æŸ“ç­‰æ–°ç‰¹æ€§
                </div>
            </div>

            <div id="html-source" class="tab-content">
                <div id="html-source-content" class="console-output" style="max-height: 500px; white-space: pre-wrap;">
                    ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®ç”ŸæˆHTMLæºç 
                    
æç¤ºï¼šç”Ÿæˆé¢„è§ˆåï¼Œç‚¹å‡»æ­¤æ ‡ç­¾å¯æŸ¥çœ‹æ ¼å¼åŒ–çš„HTMLæºä»£ç 
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // ===================================
        // å¯¼å…¥ä¼˜åŒ–çš„è§£ææ¨¡å—
        // ===================================
        
        import Renderer from './parsers_test/Renderer.js';
        import TemplateLoader, { ParserError } from './parsers_test/TemplateLoader.js';
        import InlineStyleProcessor from './parsers_test/InlineStyleProcessor.js';

        // ===================================
        // æµ‹è¯•æ•°æ®å®šä¹‰
        // ===================================
        
        // åŠ è½½æµ‹è¯•æ•°æ®
        let testData = null;
        let styleTemplate = null;
        
        async function loadTestData() {
            try {
                const response = await fetch('./parsers_test/test-data.json');
                testData = await response.json();
                console.log('âœ… æµ‹è¯•æ•°æ®åŠ è½½æˆåŠŸï¼ŒåŒ…å«', testData.blocks.length, 'ä¸ªå—');
                return true;
            } catch (error) {
                console.error('âŒ æµ‹è¯•æ•°æ®åŠ è½½å¤±è´¥:', error);
                return false;
            }
        }
        
        async function loadStyleTemplate() {
            try {
                const response = await fetch('./parsers_test/style-template.json');
                styleTemplate = await response.json();
                console.log('âœ… æ ·å¼æ¨¡æ¿åŠ è½½æˆåŠŸ:', styleTemplate.theme);
                return true;
            } catch (error) {
                console.error('âŒ æ ·å¼æ¨¡æ¿åŠ è½½å¤±è´¥:', error);
                return false;
            }
        }

        // ===================================
        // æµ‹è¯•ç±»
        // ===================================
        
        class OptimizedParserTester {
            constructor() {
                this.results = [];
                console.log('ğŸš€ ä¼˜åŒ–ç‰ˆ Parser Tester åˆå§‹åŒ–å®Œæˆ');
            }

            async runAllTests() {
                console.log('\nğŸ§ª å¼€å§‹è¿è¡Œä¼˜åŒ–ç‰ˆè§£æå™¨æµ‹è¯•...\n');
                this.results = [];
                
                // ç¡®ä¿æ•°æ®å·²åŠ è½½
                if (!testData) {
                    const loaded = await loadTestData();
                    if (!loaded) {
                        this.addResult('æµ‹è¯•æ•°æ®åŠ è½½', false, 0, 'âŒ æµ‹è¯•æ•°æ®åŠ è½½å¤±è´¥');
                        return this.results;
                    }
                }
                
                if (!styleTemplate) {
                    const loaded = await loadStyleTemplate();
                    if (!loaded) {
                        this.addResult('æ¨¡æ¿åŠ è½½', false, 0, 'âŒ æ ·å¼æ¨¡æ¿åŠ è½½å¤±è´¥');
                        return this.results;
                    }
                }
                
                await this.testTemplateValidation();
                await this.testErrorHandling();
                await this.testPlaceholderRendering();
                await this.testRealDataConversion();
                await this.testPerformance();
                
                this.showResults();
                return this.results;
            }

            async testTemplateValidation() {
                console.log('ğŸ” æµ‹è¯• 1: æ¨¡æ¿éªŒè¯å™¨');
                const startTime = performance.now();
                
                try {
                    const templateLoader = new TemplateLoader();
                    templateLoader.loadTemplate(styleTemplate);
                    const endTime = performance.now();
                    
                    this.addResult('æ¨¡æ¿éªŒè¯å™¨', true, endTime - startTime, 'âœ… æ¨¡æ¿éªŒè¯é€šè¿‡');
                    console.log(`âœ… æ¨¡æ¿éªŒè¯é€šè¿‡ï¼Œè€—æ—¶: ${(endTime - startTime).toFixed(2)}ms`);
                } catch (error) {
                    const endTime = performance.now();
                    this.addResult('æ¨¡æ¿éªŒè¯å™¨', false, endTime - startTime, `âŒ éªŒè¯å¤±è´¥: ${error.message}`);
                    console.error('âŒ æ¨¡æ¿éªŒè¯å¤±è´¥:', error);
                }
                console.log('');
            }

            async testErrorHandling() {
                console.log('âš ï¸ æµ‹è¯• 2: ç»Ÿä¸€é”™è¯¯å¤„ç†');
                const startTime = performance.now();
                
                try {
                    const templateLoader = new TemplateLoader();
                    
                    // æµ‹è¯•åŠ è½½æ— æ•ˆæ¨¡æ¿
                    try {
                        templateLoader.loadTemplate(null);
                        this.addResult('é”™è¯¯å¤„ç†', false, 0, 'âŒ åº”è¯¥æŠ›å‡ºé”™è¯¯ä½†æ²¡æœ‰');
                    } catch (error) {
                        const endTime = performance.now();
                        const isParserError = error instanceof ParserError;
                        this.addResult('é”™è¯¯å¤„ç†', isParserError, endTime - startTime, 
                            isParserError ? 'âœ… æ­£ç¡®æŠ›å‡ºParserError' : 'âŒ é”™è¯¯ç±»å‹ä¸æ­£ç¡®');
                        console.log(`âœ… é”™è¯¯å¤„ç†æµ‹è¯•é€šè¿‡ï¼Œè€—æ—¶: ${(endTime - startTime).toFixed(2)}ms`);
                        console.log(`é”™è¯¯ç±»å‹: ${error.constructor.name}, é”™è¯¯ä¿¡æ¯: ${error.message}`);
                    }
                } catch (error) {
                    this.addResult('é”™è¯¯å¤„ç†', false, 0, `âŒ æµ‹è¯•å¤±è´¥: ${error.message}`);
                    console.error('âŒ é”™è¯¯å¤„ç†æµ‹è¯•å¤±è´¥:', error);
                }
                console.log('');
            }

            async testPlaceholderRendering() {
                console.log('ğŸ¯ æµ‹è¯• 3: å ä½ç¬¦æ¡ä»¶æ¸²æŸ“');
                const startTime = performance.now();
                
                try {
                    const templateLoader = new TemplateLoader();
                    templateLoader.loadTemplate(styleTemplate);
                    const inlineStyleProcessor = new InlineStyleProcessor(templateLoader);
                    const renderer = new Renderer(templateLoader, inlineStyleProcessor);
                    
                    // ä»çœŸå®æ•°æ®ä¸­æå–quoteå’Œimageå—æ¥æµ‹è¯•æ¡ä»¶æ¸²æŸ“
                    const quoteBlock = testData.blocks.find(block => block.type === 'quote');
                    const imageBlock = testData.blocks.find(block => block.type === 'image');
                    
                    const testData_conditional = {
                        time: Date.now(),
                        blocks: [quoteBlock, imageBlock].filter(Boolean),
                        version: testData.version
                    };
                    
                    const result = renderer.render(testData_conditional);
                    const endTime = performance.now();
                    
                    // æ£€æŸ¥æ¡ä»¶æ¸²æŸ“æ˜¯å¦æ­£ç¡®å·¥ä½œ
                    const hasConditionalContent = result.includes('æ¥è‡ªflowedit') && 
                                                result.includes('è¿™æ˜¯ä¸€ä¸ªå›¾ç‰‡blockçš„ç¤ºä¾‹') &&
                                                !result.includes('{{?caption}}');
                    
                    this.addResult('å ä½ç¬¦æ¡ä»¶æ¸²æŸ“', hasConditionalContent, endTime - startTime, 
                        hasConditionalContent ? 'âœ… æ¡ä»¶æ¸²æŸ“å·¥ä½œæ­£å¸¸' : 'âŒ æ¡ä»¶æ¸²æŸ“å¼‚å¸¸');
                    
                    if (hasConditionalContent) {
                        console.log(`âœ… å ä½ç¬¦æ¡ä»¶æ¸²æŸ“æµ‹è¯•é€šè¿‡ï¼Œè€—æ—¶: ${(endTime - startTime).toFixed(2)}ms`);
                        console.log(`ç”ŸæˆHTMLé•¿åº¦: ${result.length} å­—ç¬¦`);
                    } else {
                        console.log('âŒ å ä½ç¬¦æ¡ä»¶æ¸²æŸ“æµ‹è¯•å¤±è´¥');
                    }
                } catch (error) {
                    this.addResult('å ä½ç¬¦æ¡ä»¶æ¸²æŸ“', false, 0, `âŒ é”™è¯¯: ${error.message}`);
                    console.error('âŒ å ä½ç¬¦æ¡ä»¶æ¸²æŸ“æµ‹è¯•å‡ºé”™:', error);
                }
                console.log('');
            }

            async testRealDataConversion() {
                console.log('ğŸ“š æµ‹è¯• 4: çœŸå®æ•°æ®è½¬æ¢');
                const startTime = performance.now();
                
                try {
                    const templateLoader = new TemplateLoader();
                    templateLoader.loadTemplate(styleTemplate);
                    const inlineStyleProcessor = new InlineStyleProcessor(templateLoader);
                    const renderer = new Renderer(templateLoader, inlineStyleProcessor);
                    
                    const result = renderer.render(testData);
                    const endTime = performance.now();
                    
                    const success = result && result.length > 0;
                    this.addResult('çœŸå®æ•°æ®è½¬æ¢', success, endTime - startTime, 
                        success ? 'âœ… è½¬æ¢æˆåŠŸ' : 'âŒ è½¬æ¢å¤±è´¥');
                    
                    if (success) {
                        console.log(`âœ… çœŸå®æ•°æ®è½¬æ¢æˆåŠŸï¼Œè€—æ—¶: ${(endTime - startTime).toFixed(2)}ms`);
                        console.log(`ç”ŸæˆHTMLé•¿åº¦: ${result.length} å­—ç¬¦`);
                        console.log(`å¤„ç†äº† ${testData.blocks.length} ä¸ªå—`);
                        
                        // ç»Ÿè®¡å—ç±»å‹åˆ†å¸ƒ
                        const blockTypes = {};
                        testData.blocks.forEach(block => {
                            blockTypes[block.type] = (blockTypes[block.type] || 0) + 1;
                        });
                        console.log('å—ç±»å‹åˆ†å¸ƒ:', Object.entries(blockTypes).map(([type, count]) => `${type}(${count})`).join(', '));
                    } else {
                        console.log('âŒ çœŸå®æ•°æ®è½¬æ¢å¤±è´¥');
                    }
                } catch (error) {
                    this.addResult('çœŸå®æ•°æ®è½¬æ¢', false, 0, `âŒ é”™è¯¯: ${error.message}`);
                    console.error('âŒ çœŸå®æ•°æ®è½¬æ¢å‡ºé”™:', error);
                }
                console.log('');
            }

            async testPerformance() {
                console.log('âš¡ æµ‹è¯• 5: æ€§èƒ½æµ‹è¯•ï¼ˆå¤šæ¬¡è½¬æ¢ï¼‰');
                const iterations = 10;
                const times = [];
                
                try {
                    const templateLoader = new TemplateLoader();
                    templateLoader.loadTemplate(styleTemplate);
                    const inlineStyleProcessor = new InlineStyleProcessor(templateLoader);
                    const renderer = new Renderer(templateLoader, inlineStyleProcessor);
                    
                    for (let i = 0; i < iterations; i++) {
                        const startTime = performance.now();
                        renderer.render(testData);
                        const endTime = performance.now();
                        times.push(endTime - startTime);
                    }
                    
                    const avgTime = times.reduce((a, b) => a + b, 0) / times.length;
                    const minTime = Math.min(...times);
                    const maxTime = Math.max(...times);
                    
                    const success = avgTime < 100;
                    this.addResult('æ€§èƒ½æµ‹è¯•', success, avgTime, 
                        `${success ? 'âœ…' : 'âš ï¸'} å¹³å‡: ${avgTime.toFixed(2)}ms, æœ€å°: ${minTime.toFixed(2)}ms, æœ€å¤§: ${maxTime.toFixed(2)}ms`
                    );
                    
                    console.log(`âš¡ æ€§èƒ½æµ‹è¯•å®Œæˆ (${iterations}æ¬¡è½¬æ¢)`);
                    console.log(`å¹³å‡è€—æ—¶: ${avgTime.toFixed(2)}ms`);
                    console.log(`æœ€å°è€—æ—¶: ${minTime.toFixed(2)}ms`);
                    console.log(`æœ€å¤§è€—æ—¶: ${maxTime.toFixed(2)}ms`);
                } catch (error) {
                    this.addResult('æ€§èƒ½æµ‹è¯•', false, 0, `âŒ é”™è¯¯: ${error.message}`);
                    console.error('âŒ æ€§èƒ½æµ‹è¯•å‡ºé”™:', error);
                }
                console.log('');
            }

            addResult(testName, success, time, details) {
                this.results.push({
                    name: testName,
                    success,
                    time: time.toFixed(2) + 'ms',
                    details
                });
            }

            showResults() {
                console.log('ğŸ“Š ä¼˜åŒ–ç‰ˆæµ‹è¯•ç»“æœæ±‡æ€»:');
                console.log('=====================================');
                
                let passedCount = 0;
                this.results.forEach(result => {
                    if (result.success) passedCount++;
                    console.log(`${result.success ? 'âœ…' : 'âŒ'} ${result.name}: ${result.details}`);
                });
                
                console.log('=====================================');
                console.log(`æ€»è®¡: ${this.results.length} ä¸ªæµ‹è¯•, é€šè¿‡: ${passedCount} ä¸ª, å¤±è´¥: ${this.results.length - passedCount} ä¸ª`);
                
                if (passedCount === this.results.length) {
                    console.log('ğŸ‰ æ‰€æœ‰ä¼˜åŒ–ç‰ˆæµ‹è¯•é€šè¿‡ï¼');
                } else {
                    console.log('âš ï¸ éƒ¨åˆ†æµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ä¸Šè¿°é”™è¯¯ä¿¡æ¯');
                }
            }

            async getSimpleResult() {
                try {
                    if (!testData) await loadTestData();
                    if (!styleTemplate) await loadStyleTemplate();
                    
                    const templateLoader = new TemplateLoader();
                    templateLoader.loadTemplate(styleTemplate);
                    const inlineStyleProcessor = new InlineStyleProcessor(templateLoader);
                    const renderer = new Renderer(templateLoader, inlineStyleProcessor);
                    
                    // ä½¿ç”¨çœŸå®æ•°æ®çš„å‰5ä¸ªå—ä½œä¸ºç®€å•ç¤ºä¾‹
                    const simpleData = {
                        time: testData.time,
                        blocks: testData.blocks.slice(0, 5),
                        version: testData.version
                    };
                    
                    return renderer.render(simpleData);
                } catch (error) {
                    console.error('è·å–ç®€å•ç»“æœå‡ºé”™:', error);
                    return `<p style="color: red;">è½¬æ¢å‡ºé”™: ${error.message}</p>`;
                }
            }

            async getFullResult() {
                try {
                    if (!testData) await loadTestData();
                    if (!styleTemplate) await loadStyleTemplate();
                    
                    const templateLoader = new TemplateLoader();
                    templateLoader.loadTemplate(styleTemplate);
                    const inlineStyleProcessor = new InlineStyleProcessor(templateLoader);
                    const renderer = new Renderer(templateLoader, inlineStyleProcessor);
                    
                    return renderer.render(testData);
                } catch (error) {
                    console.error('è·å–å®Œæ•´ç»“æœå‡ºé”™:', error);
                    return `<p style="color: red;">è½¬æ¢å‡ºé”™: ${error.message}</p>`;
                }
            }

            async getNewFeaturesResult() {
                try {
                    if (!testData) await loadTestData();
                    if (!styleTemplate) await loadStyleTemplate();
                    
                    const templateLoader = new TemplateLoader();
                    templateLoader.loadTemplate(styleTemplate);
                    const inlineStyleProcessor = new InlineStyleProcessor(templateLoader);
                    const renderer = new Renderer(templateLoader, inlineStyleProcessor);
                    
                    // å±•ç¤ºç‰¹å®šçš„æ–°åŠŸèƒ½å—ï¼šquote, image, listç­‰
                    const featureBlocks = testData.blocks.filter(block => 
                        ['quote', 'image', 'list', 'code', 'raw'].includes(block.type)
                    );
                    
                    const featuresData = {
                        time: testData.time,
                        blocks: featureBlocks,
                        version: testData.version
                    };
                    
                    return renderer.render(featuresData);
                } catch (error) {
                    console.error('è·å–æ–°åŠŸèƒ½ç»“æœå‡ºé”™:', error);
                    return `<p style="color: red;">è½¬æ¢å‡ºé”™: ${error.message}</p>`;
                }
            }

            async getQuoteTestResult() {
                try {
                    if (!testData) await loadTestData();
                    if (!styleTemplate) await loadStyleTemplate();
                    
                    const templateLoader = new TemplateLoader();
                    templateLoader.loadTemplate(styleTemplate);
                    const inlineStyleProcessor = new InlineStyleProcessor(templateLoader);
                    const renderer = new Renderer(templateLoader, inlineStyleProcessor);
                    
                    // åˆ›å»ºä¸“é—¨çš„quoteæµ‹è¯•æ•°æ®
                    const quoteTestData = {
                        time: Date.now(),
                        blocks: [
                            {
                                "id": "quote-test-1",
                                "type": "header",
                                "data": {
                                    "text": "Quote æ¸²æŸ“æµ‹è¯•",
                                    "level": 2
                                }
                            },
                            {
                                "id": "quote-test-2",
                                "type": "paragraph",
                                "data": {
                                    "text": "ä»¥ä¸‹å±•ç¤ºäº†ä¸åŒç±»å‹çš„quoteå—ï¼Œç‰¹åˆ«å…³æ³¨captionå­—æ®µçš„æ ·å¼å¤„ç†ï¼š"
                                }
                            },
                            {
                                "id": "quote-test-3",
                                "type": "quote",
                                "data": {
                                    "text": "è¿™æ˜¯floweditçš„Quoteå†…å®¹",
                                    "caption": "æ¥è‡ªflowedit",
                                    "alignment": "left"
                                }
                            },
                            {
                                "id": "quote-test-4",
                                "type": "quote",
                                "data": {
                                    "text": "è¿™æ˜¯ä¸€ä¸ªæ²¡æœ‰captionçš„quoteå—",
                                    "alignment": "left"
                                }
                            },
                            {
                                "id": "quote-test-5",
                                "type": "quote",
                                "data": {
                                    "text": "The unexamined life is not worth living.",
                                    "caption": "Socrates",
                                    "alignment": "left"
                                }
                            },
                            {
                                "id": "quote-test-6",
                                "type": "paragraph",
                                "data": {
                                    "text": "æ³¨æ„è§‚å¯Ÿï¼šæœ‰captionçš„quoteä¼šåœ¨åº•éƒ¨æ˜¾ç¤ºæ ·å¼åŒ–çš„å¼•ç”¨æ¥æºï¼Œè€Œæ²¡æœ‰captionçš„quoteåˆ™ä¸ä¼šæ˜¾ç¤ºã€‚è¿™å±•ç¤ºäº†{{?caption}}å ä½ç¬¦æ¡ä»¶æ¸²æŸ“çš„å·¥ä½œæ•ˆæœã€‚"
                                }
                            }
                        ],
                        version: testData.version
                    };
                    
                    const result = renderer.render(quoteTestData);
                    
                    // æ·»åŠ è°ƒè¯•ä¿¡æ¯åˆ°æ§åˆ¶å°
                    console.log('\nğŸ¯ Quoteæ¸²æŸ“æµ‹è¯•è¯¦æƒ…:');
                    console.log('æµ‹è¯•çš„quoteæ•°æ®:', quoteTestData.blocks.filter(b => b.type === 'quote'));
                    console.log('æ¸²æŸ“ç»“æœé•¿åº¦:', result.length);
                    
                    return result;
                } catch (error) {
                    console.error('è·å–Quoteæµ‹è¯•ç»“æœå‡ºé”™:', error);
                    return `<p style="color: red;">Quoteæµ‹è¯•å‡ºé”™: ${error.message}</p>`;
                }
            }
        }

        // ===================================
        // UI æ§åˆ¶é€»è¾‘
        // ===================================
        
        let consoleOutput = '';
        let currentTester = null;
        
        // æ§åˆ¶å°æ•è·
        const originalConsole = {
            log: console.log,
            error: console.error,
            warn: console.warn,
            info: console.info,
            debug: console.debug
        };
        
        function captureConsole(type, ...args) {
            originalConsole[type].apply(console, args);
            const timestamp = new Date().toLocaleTimeString();
            const message = args.map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
            ).join(' ');
            consoleOutput += `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            updateConsoleDisplay();
        }
        
        // é‡å†™æ§åˆ¶å°æ–¹æ³•
        console.log = (...args) => captureConsole('log', ...args);
        console.error = (...args) => captureConsole('error', ...args);
        console.warn = (...args) => captureConsole('warn', ...args);
        console.info = (...args) => captureConsole('info', ...args);
        console.debug = (...args) => captureConsole('debug', ...args);
        
        function updateConsoleDisplay() {
            document.getElementById('console-output').textContent = consoleOutput;
            const output = document.getElementById('console-output');
            output.scrollTop = output.scrollHeight;
        }
        
        // äº‹ä»¶ç›‘å¬å™¨ç»‘å®š
        document.addEventListener('DOMContentLoaded', function() {
            // æŒ‰é’®äº‹ä»¶ç»‘å®š
            document.getElementById('runAllTestsBtn').addEventListener('click', async function() {
                try {
                    showLoading(true);
                    showStatus('æ­£åœ¨è¿è¡Œä¼˜åŒ–ç‰ˆæµ‹è¯•...', 'info');
                    clearConsole();
                    
                    currentTester = new OptimizedParserTester();
                    const results = await currentTester.runAllTests();
                    
                    updateStats(results);
                    
                    const passedCount = results.filter(r => r.success).length;
                    if (passedCount === results.length) {
                        showStatus(`ğŸ‰ æ‰€æœ‰ä¼˜åŒ–ç‰ˆæµ‹è¯•é€šè¿‡ï¼(${passedCount}/${results.length})`, 'success');
                    } else {
                        showStatus(`âš ï¸ éƒ¨åˆ†æµ‹è¯•å¤±è´¥ (${passedCount}/${results.length})`, 'error');
                    }
                    
                } catch (error) {
                    console.error('æµ‹è¯•è¿è¡Œå¤±è´¥:', error);
                    showStatus('âŒ æµ‹è¯•è¿è¡Œå¤±è´¥: ' + error.message, 'error');
                } finally {
                    showLoading(false);
                }
            });
            
            document.getElementById('showSimplePreviewBtn').addEventListener('click', async function() {
                try {
                    showStatus('ç”Ÿæˆç®€å•ç¤ºä¾‹é¢„è§ˆ...', 'info');
                    const tester = currentTester || new OptimizedParserTester();
                    const html = await tester.getSimpleResult();
                    document.getElementById('simple-html').innerHTML = html;
                    updateHtmlSource(html);
                    switchPreviewTab('simple-preview');
                    showStatus('âœ… ç®€å•ç¤ºä¾‹é¢„è§ˆå·²ç”Ÿæˆ', 'success');
                } catch (error) {
                    console.error('ç®€å•é¢„è§ˆå¤±è´¥:', error);
                    document.getElementById('simple-html').innerHTML = `<p style="color: red;">é¢„è§ˆå¤±è´¥: ${error.message}</p>`;
                    showStatus('âŒ ç®€å•é¢„è§ˆå¤±è´¥', 'error');
                }
            });
            
            document.getElementById('showFullPreviewBtn').addEventListener('click', async function() {
                try {
                    showStatus('ç”Ÿæˆå®Œæ•´ç¤ºä¾‹é¢„è§ˆ...', 'info');
                    const tester = currentTester || new OptimizedParserTester();
                    const html = await tester.getFullResult();
                    document.getElementById('full-html').innerHTML = html;
                    updateHtmlSource(html);
                    switchPreviewTab('full-preview');
                    showStatus('âœ… å®Œæ•´ç¤ºä¾‹é¢„è§ˆå·²ç”Ÿæˆ', 'success');
                } catch (error) {
                    console.error('å®Œæ•´é¢„è§ˆå¤±è´¥:', error);
                    document.getElementById('full-html').innerHTML = `<p style="color: red;">é¢„è§ˆå¤±è´¥: ${error.message}</p>`;
                    showStatus('âŒ å®Œæ•´é¢„è§ˆå¤±è´¥', 'error');
                }
            });

            document.getElementById('testNewFeaturesBtn').addEventListener('click', async function() {
                try {
                    showStatus('æµ‹è¯•æ–°åŠŸèƒ½ç‰¹æ€§...', 'info');
                    const tester = currentTester || new OptimizedParserTester();
                    const html = await tester.getNewFeaturesResult();
                    document.getElementById('new-features-html').innerHTML = html;
                    updateHtmlSource(html);
                    switchPreviewTab('new-features');
                    showStatus('âœ… æ–°åŠŸèƒ½æµ‹è¯•å®Œæˆ', 'success');
                } catch (error) {
                    console.error('æ–°åŠŸèƒ½æµ‹è¯•å¤±è´¥:', error);
                    document.getElementById('new-features-html').innerHTML = `<p style="color: red;">æ–°åŠŸèƒ½æµ‹è¯•å¤±è´¥: ${error.message}</p>`;
                    showStatus('âŒ æ–°åŠŸèƒ½æµ‹è¯•å¤±è´¥', 'error');
                }
            });

            document.getElementById('testQuoteBtn').addEventListener('click', async function() {
                try {
                    showStatus('æµ‹è¯•Quoteæ¸²æŸ“...', 'info');
                    const tester = currentTester || new OptimizedParserTester();
                    const html = await tester.getQuoteTestResult();
                    document.getElementById('new-features-html').innerHTML = html;
                    updateHtmlSource(html);
                    switchPreviewTab('new-features');
                    showStatus('âœ… Quoteæ¸²æŸ“æµ‹è¯•å®Œæˆï¼Œè¯·æŸ¥çœ‹captionæ ·å¼å¤„ç†', 'success');
                } catch (error) {
                    console.error('Quoteæµ‹è¯•å¤±è´¥:', error);
                    document.getElementById('new-features-html').innerHTML = `<p style="color: red;">Quoteæµ‹è¯•å¤±è´¥: ${error.message}</p>`;
                    showStatus('âŒ Quoteæµ‹è¯•å¤±è´¥', 'error');
                }
            });
            
            document.getElementById('clearResultsBtn').addEventListener('click', function() {
                clearConsole();
                document.getElementById('simple-html').innerHTML = 'ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æŸ¥çœ‹é¢„è§ˆ';
                document.getElementById('full-html').innerHTML = 'ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æŸ¥çœ‹é¢„è§ˆ';
                document.getElementById('new-features-html').innerHTML = 'ç‚¹å‡»"æ–°åŠŸèƒ½æµ‹è¯•"æˆ–"æµ‹è¯•Quoteæ¸²æŸ“"æŸ¥çœ‹å ä½ç¬¦æ¡ä»¶æ¸²æŸ“ç­‰æ–°ç‰¹æ€§';
                document.getElementById('html-source-content').textContent = 'ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®ç”ŸæˆHTMLæºç \n\næç¤ºï¼šç”Ÿæˆé¢„è§ˆåï¼Œç‚¹å‡»æ­¤æ ‡ç­¾å¯æŸ¥çœ‹æ ¼å¼åŒ–çš„HTMLæºä»£ç ';
                document.getElementById('stats').style.display = 'none';
                showStatus('âœ… ç»“æœå·²æ¸…ç©º', 'success');
            });

            // æ ‡ç­¾é¡µäº‹ä»¶ç»‘å®š
            document.getElementById('simple-tab').addEventListener('click', function() {
                switchPreviewTab('simple-preview');
            });
            
            document.getElementById('full-tab').addEventListener('click', function() {
                switchPreviewTab('full-preview');
            });
            
            document.getElementById('new-features-tab').addEventListener('click', function() {
                switchPreviewTab('new-features');
            });

            document.getElementById('html-source-tab').addEventListener('click', function() {
                switchPreviewTab('html-source');
            });
        });
        
        function switchPreviewTab(tabId) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            
            // æ¿€æ´»å¯¹åº”çš„æ ‡ç­¾
            if (tabId === 'simple-preview') {
                document.getElementById('simple-tab').classList.add('active');
            } else if (tabId === 'full-preview') {
                document.getElementById('full-tab').classList.add('active');
            } else if (tabId === 'new-features') {
                document.getElementById('new-features-tab').classList.add('active');
            } else if (tabId === 'html-source') {
                document.getElementById('html-source-tab').classList.add('active');
            }
        }

        // æ›´æ–°HTMLæºç æ˜¾ç¤º
        function updateHtmlSource(html) {
            if (html) {
                const formattedHtml = formatHtml(html);
                document.getElementById('html-source-content').textContent = formattedHtml;
            }
        }

        // æ ¼å¼åŒ–HTMLæºç 
        function formatHtml(html) {
            // ç®€å•çš„HTMLæ ¼å¼åŒ–
            let formatted = html;
            
            // æ·»åŠ æ¢è¡Œç¬¦
            formatted = formatted.replace(/></g, '>\n<');
            
            // æ·»åŠ ç¼©è¿›
            const lines = formatted.split('\n');
            let indent = 0;
            const indentSize = 2;
            
            const formattedLines = lines.map(line => {
                const trimmed = line.trim();
                if (!trimmed) return '';
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯ç»“æŸæ ‡ç­¾
                if (trimmed.match(/^<\/\w+>/)) {
                    indent = Math.max(0, indent - indentSize);
                }
                
                const indentedLine = ' '.repeat(indent) + trimmed;
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯å¼€å§‹æ ‡ç­¾ï¼ˆéè‡ªé—­åˆï¼‰
                if (trimmed.match(/^<\w+[^>]*>/) && !trimmed.match(/\/>$/)) {
                    indent += indentSize;
                }
                
                return indentedLine;
            });
            
            return formattedLines.join('\n');
        }
        
        // è¾…åŠ©å‡½æ•°
        function showLoading(show) {
            document.getElementById('loading').classList.toggle('show', show);
        }
        
        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
        }
        
        function clearConsole() {
            consoleOutput = '';
            updateConsoleDisplay();
        }
        
        function updateStats(results) {
            const passedCount = results.filter(r => r.success).length;
            const avgTime = results.length > 0 ? 
                (results.reduce((sum, r) => sum + parseFloat(r.time), 0) / results.length).toFixed(2) : 0;
            
            document.getElementById('test-count').textContent = results.length;
            document.getElementById('pass-count').textContent = passedCount;
            document.getElementById('avg-time').textContent = avgTime + 'ms';
            document.getElementById('total-blocks').textContent = testData ? testData.blocks.length : 'æœªåŠ è½½';
            
            document.getElementById('stats').style.display = 'grid';
        }
        
        // åˆå§‹åŒ–
        console.log('ğŸ¯ FlowEdit ä¼˜åŒ–ç‰ˆ Parser æµ‹è¯•ç¯å¢ƒå·²å‡†å¤‡å°±ç»ª');
        console.log('æ–°åŠŸèƒ½åŒ…æ‹¬: ç»Ÿä¸€é”™è¯¯å¤„ç†ã€è§£è€¦æ¶æ„ã€å ä½ç¬¦æ¡ä»¶æ¸²æŸ“ã€ç®€åŒ–Listæ¨¡æ¿ã€æ¨¡æ¿éªŒè¯å™¨');
        
        // é¢„åŠ è½½æµ‹è¯•æ•°æ®å’Œæ ·å¼æ¨¡æ¿
        Promise.all([loadTestData(), loadStyleTemplate()]).then(results => {
            const [dataLoaded, templateLoaded] = results;
            if (dataLoaded && templateLoaded) {
                console.log('âœ… æµ‹è¯•æ•°æ®å’Œæ ·å¼æ¨¡æ¿é¢„åŠ è½½å®Œæˆï¼Œå¯ä»¥å¼€å§‹æµ‹è¯•');
                console.log(`æµ‹è¯•æ•°æ®åŒ…å« ${testData.blocks.length} ä¸ªå—ï¼Œæ ·å¼ä¸»é¢˜: ${styleTemplate.theme}`);
            } else {
                console.log('âŒ é¢„åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶è·¯å¾„');
            }
        });
    </script>
</body>
</html>