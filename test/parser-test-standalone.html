<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlowEdit Parser 测试 - 优化版本</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f8f9fa;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }
        button:hover {
            background: #0056b3;
        }
        button.success {
            background: #28a745;
        }
        button.success:hover {
            background: #1e7e34;
        }
        button.warning {
            background: #ffc107;
            color: #212529;
        }
        button.warning:hover {
            background: #e0a800;
        }
        .results-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        .panel {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .panel h3 {
            margin-top: 0;
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        .console-output {
            background: #1e1e1e;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            overflow-y: auto;
            max-height: 400px;
            min-height: 200px;
        }
        .html-preview {
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            background: white;
            overflow-y: auto;
            max-height: 400px;
            min-height: 200px;
        }
        .status {
            text-align: center;
            padding: 15px;
            margin: 15px 0;
            border-radius: 6px;
            font-weight: 500;
        }
        .status.info {
            background: #e3f2fd;
            color: #1976d2;
            border: 1px solid #90caf9;
        }
        .status.success {
            background: #e8f5e8;
            color: #2e7d32;
            border: 1px solid #81c784;
        }
        .status.error {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ef5350;
        }
        .tabs {
            display: flex;
            border-bottom: 1px solid #dee2e6;
            margin-bottom: 15px;
        }
        .tab {
            padding: 10px 20px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-bottom: none;
            cursor: pointer;
            margin-right: 5px;
            border-radius: 4px 4px 0 0;
        }
        .tab.active {
            background: white;
            border-bottom: 1px solid white;
            margin-bottom: -1px;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #007bff;
        }
        .loading.show {
            display: block;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        .stat-label {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
        .version-info {
            background: #f8f9fa;
            padding: 10px 15px;
            border-radius: 6px;
            margin: 15px 0;
            border: 1px solid #dee2e6;
        }
        .version-info .title {
            font-weight: 600;
            color: #10b981;
            margin-bottom: 5px;
        }
        .version-info .features {
            font-size: 14px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🚀 FlowEdit Parser 测试 - 优化版本</h1>
        <p>使用新的解析模块，包含错误处理、解耦架构和占位符条件渲染</p>
        <div class="version-info">
            <div class="title">✨ 新功能特性</div>
            <div class="features">
                统一错误处理 • 解耦架构 • 占位符条件渲染 {{?field}} • 简化List模板 • 模板验证器
            </div>
        </div>
    </div>

    <div class="controls">
        <button id="runAllTestsBtn" class="success">🧪 运行所有测试</button>
        <button id="showSimplePreviewBtn">📝 简单示例预览</button>
        <button id="showFullPreviewBtn">📚 完整示例预览</button>
        <button id="testNewFeaturesBtn">⚡ 新功能测试</button>
        <button id="testQuoteBtn">💬 测试Quote渲染</button>
        <button id="clearResultsBtn" class="warning">🗑️ 清空结果</button>
    </div>

    <div id="status" class="status info">
        点击"运行所有测试"开始测试优化版本 Parser 功能
    </div>

    <div id="loading" class="loading">
        <div>🔄 正在运行测试...</div>
    </div>

    <div id="stats" class="stats" style="display: none;">
        <div class="stat-card">
            <div id="test-count" class="stat-value">0</div>
            <div class="stat-label">测试总数</div>
        </div>
        <div class="stat-card">
            <div id="pass-count" class="stat-value">0</div>
            <div class="stat-label">通过测试</div>
        </div>
        <div class="stat-card">
            <div id="avg-time" class="stat-value">0ms</div>
            <div class="stat-label">平均耗时</div>
        </div>
        <div class="stat-card">
            <div id="total-blocks" class="stat-value">0</div>
            <div class="stat-label">处理块数</div>
        </div>
    </div>

    <div class="results-container">
        <div class="panel">
            <h3>📊 控制台输出</h3>
            <div id="console-output" class="console-output">
等待测试运行...
            </div>
        </div>

        <div class="panel">
            <h3>🎨 HTML预览</h3>
            <div class="tabs">
                <div class="tab active" id="simple-tab">简单示例</div>
                <div class="tab" id="full-tab">完整示例</div>
                <div class="tab" id="new-features-tab">新功能展示</div>
                <div class="tab" id="html-source-tab">HTML源码</div>
            </div>
            
            <div id="simple-preview" class="tab-content active">
                <div id="simple-html" class="html-preview">
                    点击上方按钮查看预览
                </div>
            </div>
            
            <div id="full-preview" class="tab-content">
                <div id="full-html" class="html-preview">
                    点击上方按钮查看预览
                </div>
            </div>

            <div id="new-features" class="tab-content">
                <div id="new-features-html" class="html-preview">
                    点击"新功能测试"或"测试Quote渲染"查看占位符条件渲染等新特性
                </div>
            </div>

            <div id="html-source" class="tab-content">
                <div id="html-source-content" class="console-output" style="max-height: 500px; white-space: pre-wrap;">
                    点击上方按钮生成HTML源码
                    
提示：生成预览后，点击此标签可查看格式化的HTML源代码
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // ===================================
        // 导入优化的解析模块
        // ===================================
        
        import Renderer from './parsers_test/Renderer.js';
        import TemplateLoader, { ParserError } from './parsers_test/TemplateLoader.js';
        import InlineStyleProcessor from './parsers_test/InlineStyleProcessor.js';

        // ===================================
        // 测试数据定义
        // ===================================
        
        // 加载测试数据
        let testData = null;
        let styleTemplate = null;
        
        async function loadTestData() {
            try {
                const response = await fetch('./parsers_test/test-data.json');
                testData = await response.json();
                console.log('✅ 测试数据加载成功，包含', testData.blocks.length, '个块');
                return true;
            } catch (error) {
                console.error('❌ 测试数据加载失败:', error);
                return false;
            }
        }
        
        async function loadStyleTemplate() {
            try {
                const response = await fetch('./parsers_test/style-template.json');
                styleTemplate = await response.json();
                console.log('✅ 样式模板加载成功:', styleTemplate.theme);
                return true;
            } catch (error) {
                console.error('❌ 样式模板加载失败:', error);
                return false;
            }
        }

        // ===================================
        // 测试类
        // ===================================
        
        class OptimizedParserTester {
            constructor() {
                this.results = [];
                console.log('🚀 优化版 Parser Tester 初始化完成');
            }

            async runAllTests() {
                console.log('\n🧪 开始运行优化版解析器测试...\n');
                this.results = [];
                
                // 确保数据已加载
                if (!testData) {
                    const loaded = await loadTestData();
                    if (!loaded) {
                        this.addResult('测试数据加载', false, 0, '❌ 测试数据加载失败');
                        return this.results;
                    }
                }
                
                if (!styleTemplate) {
                    const loaded = await loadStyleTemplate();
                    if (!loaded) {
                        this.addResult('模板加载', false, 0, '❌ 样式模板加载失败');
                        return this.results;
                    }
                }
                
                await this.testTemplateValidation();
                await this.testErrorHandling();
                await this.testPlaceholderRendering();
                await this.testRealDataConversion();
                await this.testPerformance();
                
                this.showResults();
                return this.results;
            }

            async testTemplateValidation() {
                console.log('🔍 测试 1: 模板验证器');
                const startTime = performance.now();
                
                try {
                    const templateLoader = new TemplateLoader();
                    templateLoader.loadTemplate(styleTemplate);
                    const endTime = performance.now();
                    
                    this.addResult('模板验证器', true, endTime - startTime, '✅ 模板验证通过');
                    console.log(`✅ 模板验证通过，耗时: ${(endTime - startTime).toFixed(2)}ms`);
                } catch (error) {
                    const endTime = performance.now();
                    this.addResult('模板验证器', false, endTime - startTime, `❌ 验证失败: ${error.message}`);
                    console.error('❌ 模板验证失败:', error);
                }
                console.log('');
            }

            async testErrorHandling() {
                console.log('⚠️ 测试 2: 统一错误处理');
                const startTime = performance.now();
                
                try {
                    const templateLoader = new TemplateLoader();
                    
                    // 测试加载无效模板
                    try {
                        templateLoader.loadTemplate(null);
                        this.addResult('错误处理', false, 0, '❌ 应该抛出错误但没有');
                    } catch (error) {
                        const endTime = performance.now();
                        const isParserError = error instanceof ParserError;
                        this.addResult('错误处理', isParserError, endTime - startTime, 
                            isParserError ? '✅ 正确抛出ParserError' : '❌ 错误类型不正确');
                        console.log(`✅ 错误处理测试通过，耗时: ${(endTime - startTime).toFixed(2)}ms`);
                        console.log(`错误类型: ${error.constructor.name}, 错误信息: ${error.message}`);
                    }
                } catch (error) {
                    this.addResult('错误处理', false, 0, `❌ 测试失败: ${error.message}`);
                    console.error('❌ 错误处理测试失败:', error);
                }
                console.log('');
            }

            async testPlaceholderRendering() {
                console.log('🎯 测试 3: 占位符条件渲染');
                const startTime = performance.now();
                
                try {
                    const templateLoader = new TemplateLoader();
                    templateLoader.loadTemplate(styleTemplate);
                    const inlineStyleProcessor = new InlineStyleProcessor(templateLoader);
                    const renderer = new Renderer(templateLoader, inlineStyleProcessor);
                    
                    // 从真实数据中提取quote和image块来测试条件渲染
                    const quoteBlock = testData.blocks.find(block => block.type === 'quote');
                    const imageBlock = testData.blocks.find(block => block.type === 'image');
                    
                    const testData_conditional = {
                        time: Date.now(),
                        blocks: [quoteBlock, imageBlock].filter(Boolean),
                        version: testData.version
                    };
                    
                    const result = renderer.render(testData_conditional);
                    const endTime = performance.now();
                    
                    // 检查条件渲染是否正确工作
                    const hasConditionalContent = result.includes('来自flowedit') && 
                                                result.includes('这是一个图片block的示例') &&
                                                !result.includes('{{?caption}}');
                    
                    this.addResult('占位符条件渲染', hasConditionalContent, endTime - startTime, 
                        hasConditionalContent ? '✅ 条件渲染工作正常' : '❌ 条件渲染异常');
                    
                    if (hasConditionalContent) {
                        console.log(`✅ 占位符条件渲染测试通过，耗时: ${(endTime - startTime).toFixed(2)}ms`);
                        console.log(`生成HTML长度: ${result.length} 字符`);
                    } else {
                        console.log('❌ 占位符条件渲染测试失败');
                    }
                } catch (error) {
                    this.addResult('占位符条件渲染', false, 0, `❌ 错误: ${error.message}`);
                    console.error('❌ 占位符条件渲染测试出错:', error);
                }
                console.log('');
            }

            async testRealDataConversion() {
                console.log('📚 测试 4: 真实数据转换');
                const startTime = performance.now();
                
                try {
                    const templateLoader = new TemplateLoader();
                    templateLoader.loadTemplate(styleTemplate);
                    const inlineStyleProcessor = new InlineStyleProcessor(templateLoader);
                    const renderer = new Renderer(templateLoader, inlineStyleProcessor);
                    
                    const result = renderer.render(testData);
                    const endTime = performance.now();
                    
                    const success = result && result.length > 0;
                    this.addResult('真实数据转换', success, endTime - startTime, 
                        success ? '✅ 转换成功' : '❌ 转换失败');
                    
                    if (success) {
                        console.log(`✅ 真实数据转换成功，耗时: ${(endTime - startTime).toFixed(2)}ms`);
                        console.log(`生成HTML长度: ${result.length} 字符`);
                        console.log(`处理了 ${testData.blocks.length} 个块`);
                        
                        // 统计块类型分布
                        const blockTypes = {};
                        testData.blocks.forEach(block => {
                            blockTypes[block.type] = (blockTypes[block.type] || 0) + 1;
                        });
                        console.log('块类型分布:', Object.entries(blockTypes).map(([type, count]) => `${type}(${count})`).join(', '));
                    } else {
                        console.log('❌ 真实数据转换失败');
                    }
                } catch (error) {
                    this.addResult('真实数据转换', false, 0, `❌ 错误: ${error.message}`);
                    console.error('❌ 真实数据转换出错:', error);
                }
                console.log('');
            }

            async testPerformance() {
                console.log('⚡ 测试 5: 性能测试（多次转换）');
                const iterations = 10;
                const times = [];
                
                try {
                    const templateLoader = new TemplateLoader();
                    templateLoader.loadTemplate(styleTemplate);
                    const inlineStyleProcessor = new InlineStyleProcessor(templateLoader);
                    const renderer = new Renderer(templateLoader, inlineStyleProcessor);
                    
                    for (let i = 0; i < iterations; i++) {
                        const startTime = performance.now();
                        renderer.render(testData);
                        const endTime = performance.now();
                        times.push(endTime - startTime);
                    }
                    
                    const avgTime = times.reduce((a, b) => a + b, 0) / times.length;
                    const minTime = Math.min(...times);
                    const maxTime = Math.max(...times);
                    
                    const success = avgTime < 100;
                    this.addResult('性能测试', success, avgTime, 
                        `${success ? '✅' : '⚠️'} 平均: ${avgTime.toFixed(2)}ms, 最小: ${minTime.toFixed(2)}ms, 最大: ${maxTime.toFixed(2)}ms`
                    );
                    
                    console.log(`⚡ 性能测试完成 (${iterations}次转换)`);
                    console.log(`平均耗时: ${avgTime.toFixed(2)}ms`);
                    console.log(`最小耗时: ${minTime.toFixed(2)}ms`);
                    console.log(`最大耗时: ${maxTime.toFixed(2)}ms`);
                } catch (error) {
                    this.addResult('性能测试', false, 0, `❌ 错误: ${error.message}`);
                    console.error('❌ 性能测试出错:', error);
                }
                console.log('');
            }

            addResult(testName, success, time, details) {
                this.results.push({
                    name: testName,
                    success,
                    time: time.toFixed(2) + 'ms',
                    details
                });
            }

            showResults() {
                console.log('📊 优化版测试结果汇总:');
                console.log('=====================================');
                
                let passedCount = 0;
                this.results.forEach(result => {
                    if (result.success) passedCount++;
                    console.log(`${result.success ? '✅' : '❌'} ${result.name}: ${result.details}`);
                });
                
                console.log('=====================================');
                console.log(`总计: ${this.results.length} 个测试, 通过: ${passedCount} 个, 失败: ${this.results.length - passedCount} 个`);
                
                if (passedCount === this.results.length) {
                    console.log('🎉 所有优化版测试通过！');
                } else {
                    console.log('⚠️ 部分测试失败，请检查上述错误信息');
                }
            }

            async getSimpleResult() {
                try {
                    if (!testData) await loadTestData();
                    if (!styleTemplate) await loadStyleTemplate();
                    
                    const templateLoader = new TemplateLoader();
                    templateLoader.loadTemplate(styleTemplate);
                    const inlineStyleProcessor = new InlineStyleProcessor(templateLoader);
                    const renderer = new Renderer(templateLoader, inlineStyleProcessor);
                    
                    // 使用真实数据的前5个块作为简单示例
                    const simpleData = {
                        time: testData.time,
                        blocks: testData.blocks.slice(0, 5),
                        version: testData.version
                    };
                    
                    return renderer.render(simpleData);
                } catch (error) {
                    console.error('获取简单结果出错:', error);
                    return `<p style="color: red;">转换出错: ${error.message}</p>`;
                }
            }

            async getFullResult() {
                try {
                    if (!testData) await loadTestData();
                    if (!styleTemplate) await loadStyleTemplate();
                    
                    const templateLoader = new TemplateLoader();
                    templateLoader.loadTemplate(styleTemplate);
                    const inlineStyleProcessor = new InlineStyleProcessor(templateLoader);
                    const renderer = new Renderer(templateLoader, inlineStyleProcessor);
                    
                    return renderer.render(testData);
                } catch (error) {
                    console.error('获取完整结果出错:', error);
                    return `<p style="color: red;">转换出错: ${error.message}</p>`;
                }
            }

            async getNewFeaturesResult() {
                try {
                    if (!testData) await loadTestData();
                    if (!styleTemplate) await loadStyleTemplate();
                    
                    const templateLoader = new TemplateLoader();
                    templateLoader.loadTemplate(styleTemplate);
                    const inlineStyleProcessor = new InlineStyleProcessor(templateLoader);
                    const renderer = new Renderer(templateLoader, inlineStyleProcessor);
                    
                    // 展示特定的新功能块：quote, image, list等
                    const featureBlocks = testData.blocks.filter(block => 
                        ['quote', 'image', 'list', 'code', 'raw'].includes(block.type)
                    );
                    
                    const featuresData = {
                        time: testData.time,
                        blocks: featureBlocks,
                        version: testData.version
                    };
                    
                    return renderer.render(featuresData);
                } catch (error) {
                    console.error('获取新功能结果出错:', error);
                    return `<p style="color: red;">转换出错: ${error.message}</p>`;
                }
            }

            async getQuoteTestResult() {
                try {
                    if (!testData) await loadTestData();
                    if (!styleTemplate) await loadStyleTemplate();
                    
                    const templateLoader = new TemplateLoader();
                    templateLoader.loadTemplate(styleTemplate);
                    const inlineStyleProcessor = new InlineStyleProcessor(templateLoader);
                    const renderer = new Renderer(templateLoader, inlineStyleProcessor);
                    
                    // 创建专门的quote测试数据
                    const quoteTestData = {
                        time: Date.now(),
                        blocks: [
                            {
                                "id": "quote-test-1",
                                "type": "header",
                                "data": {
                                    "text": "Quote 渲染测试",
                                    "level": 2
                                }
                            },
                            {
                                "id": "quote-test-2",
                                "type": "paragraph",
                                "data": {
                                    "text": "以下展示了不同类型的quote块，特别关注caption字段的样式处理："
                                }
                            },
                            {
                                "id": "quote-test-3",
                                "type": "quote",
                                "data": {
                                    "text": "这是flowedit的Quote内容",
                                    "caption": "来自flowedit",
                                    "alignment": "left"
                                }
                            },
                            {
                                "id": "quote-test-4",
                                "type": "quote",
                                "data": {
                                    "text": "这是一个没有caption的quote块",
                                    "alignment": "left"
                                }
                            },
                            {
                                "id": "quote-test-5",
                                "type": "quote",
                                "data": {
                                    "text": "The unexamined life is not worth living.",
                                    "caption": "Socrates",
                                    "alignment": "left"
                                }
                            },
                            {
                                "id": "quote-test-6",
                                "type": "paragraph",
                                "data": {
                                    "text": "注意观察：有caption的quote会在底部显示样式化的引用来源，而没有caption的quote则不会显示。这展示了{{?caption}}占位符条件渲染的工作效果。"
                                }
                            }
                        ],
                        version: testData.version
                    };
                    
                    const result = renderer.render(quoteTestData);
                    
                    // 添加调试信息到控制台
                    console.log('\n🎯 Quote渲染测试详情:');
                    console.log('测试的quote数据:', quoteTestData.blocks.filter(b => b.type === 'quote'));
                    console.log('渲染结果长度:', result.length);
                    
                    return result;
                } catch (error) {
                    console.error('获取Quote测试结果出错:', error);
                    return `<p style="color: red;">Quote测试出错: ${error.message}</p>`;
                }
            }
        }

        // ===================================
        // UI 控制逻辑
        // ===================================
        
        let consoleOutput = '';
        let currentTester = null;
        
        // 控制台捕获
        const originalConsole = {
            log: console.log,
            error: console.error,
            warn: console.warn,
            info: console.info,
            debug: console.debug
        };
        
        function captureConsole(type, ...args) {
            originalConsole[type].apply(console, args);
            const timestamp = new Date().toLocaleTimeString();
            const message = args.map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
            ).join(' ');
            consoleOutput += `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            updateConsoleDisplay();
        }
        
        // 重写控制台方法
        console.log = (...args) => captureConsole('log', ...args);
        console.error = (...args) => captureConsole('error', ...args);
        console.warn = (...args) => captureConsole('warn', ...args);
        console.info = (...args) => captureConsole('info', ...args);
        console.debug = (...args) => captureConsole('debug', ...args);
        
        function updateConsoleDisplay() {
            document.getElementById('console-output').textContent = consoleOutput;
            const output = document.getElementById('console-output');
            output.scrollTop = output.scrollHeight;
        }
        
        // 事件监听器绑定
        document.addEventListener('DOMContentLoaded', function() {
            // 按钮事件绑定
            document.getElementById('runAllTestsBtn').addEventListener('click', async function() {
                try {
                    showLoading(true);
                    showStatus('正在运行优化版测试...', 'info');
                    clearConsole();
                    
                    currentTester = new OptimizedParserTester();
                    const results = await currentTester.runAllTests();
                    
                    updateStats(results);
                    
                    const passedCount = results.filter(r => r.success).length;
                    if (passedCount === results.length) {
                        showStatus(`🎉 所有优化版测试通过！(${passedCount}/${results.length})`, 'success');
                    } else {
                        showStatus(`⚠️ 部分测试失败 (${passedCount}/${results.length})`, 'error');
                    }
                    
                } catch (error) {
                    console.error('测试运行失败:', error);
                    showStatus('❌ 测试运行失败: ' + error.message, 'error');
                } finally {
                    showLoading(false);
                }
            });
            
            document.getElementById('showSimplePreviewBtn').addEventListener('click', async function() {
                try {
                    showStatus('生成简单示例预览...', 'info');
                    const tester = currentTester || new OptimizedParserTester();
                    const html = await tester.getSimpleResult();
                    document.getElementById('simple-html').innerHTML = html;
                    updateHtmlSource(html);
                    switchPreviewTab('simple-preview');
                    showStatus('✅ 简单示例预览已生成', 'success');
                } catch (error) {
                    console.error('简单预览失败:', error);
                    document.getElementById('simple-html').innerHTML = `<p style="color: red;">预览失败: ${error.message}</p>`;
                    showStatus('❌ 简单预览失败', 'error');
                }
            });
            
            document.getElementById('showFullPreviewBtn').addEventListener('click', async function() {
                try {
                    showStatus('生成完整示例预览...', 'info');
                    const tester = currentTester || new OptimizedParserTester();
                    const html = await tester.getFullResult();
                    document.getElementById('full-html').innerHTML = html;
                    updateHtmlSource(html);
                    switchPreviewTab('full-preview');
                    showStatus('✅ 完整示例预览已生成', 'success');
                } catch (error) {
                    console.error('完整预览失败:', error);
                    document.getElementById('full-html').innerHTML = `<p style="color: red;">预览失败: ${error.message}</p>`;
                    showStatus('❌ 完整预览失败', 'error');
                }
            });

            document.getElementById('testNewFeaturesBtn').addEventListener('click', async function() {
                try {
                    showStatus('测试新功能特性...', 'info');
                    const tester = currentTester || new OptimizedParserTester();
                    const html = await tester.getNewFeaturesResult();
                    document.getElementById('new-features-html').innerHTML = html;
                    updateHtmlSource(html);
                    switchPreviewTab('new-features');
                    showStatus('✅ 新功能测试完成', 'success');
                } catch (error) {
                    console.error('新功能测试失败:', error);
                    document.getElementById('new-features-html').innerHTML = `<p style="color: red;">新功能测试失败: ${error.message}</p>`;
                    showStatus('❌ 新功能测试失败', 'error');
                }
            });

            document.getElementById('testQuoteBtn').addEventListener('click', async function() {
                try {
                    showStatus('测试Quote渲染...', 'info');
                    const tester = currentTester || new OptimizedParserTester();
                    const html = await tester.getQuoteTestResult();
                    document.getElementById('new-features-html').innerHTML = html;
                    updateHtmlSource(html);
                    switchPreviewTab('new-features');
                    showStatus('✅ Quote渲染测试完成，请查看caption样式处理', 'success');
                } catch (error) {
                    console.error('Quote测试失败:', error);
                    document.getElementById('new-features-html').innerHTML = `<p style="color: red;">Quote测试失败: ${error.message}</p>`;
                    showStatus('❌ Quote测试失败', 'error');
                }
            });
            
            document.getElementById('clearResultsBtn').addEventListener('click', function() {
                clearConsole();
                document.getElementById('simple-html').innerHTML = '点击上方按钮查看预览';
                document.getElementById('full-html').innerHTML = '点击上方按钮查看预览';
                document.getElementById('new-features-html').innerHTML = '点击"新功能测试"或"测试Quote渲染"查看占位符条件渲染等新特性';
                document.getElementById('html-source-content').textContent = '点击上方按钮生成HTML源码\n\n提示：生成预览后，点击此标签可查看格式化的HTML源代码';
                document.getElementById('stats').style.display = 'none';
                showStatus('✅ 结果已清空', 'success');
            });

            // 标签页事件绑定
            document.getElementById('simple-tab').addEventListener('click', function() {
                switchPreviewTab('simple-preview');
            });
            
            document.getElementById('full-tab').addEventListener('click', function() {
                switchPreviewTab('full-preview');
            });
            
            document.getElementById('new-features-tab').addEventListener('click', function() {
                switchPreviewTab('new-features');
            });

            document.getElementById('html-source-tab').addEventListener('click', function() {
                switchPreviewTab('html-source');
            });
        });
        
        function switchPreviewTab(tabId) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            
            // 激活对应的标签
            if (tabId === 'simple-preview') {
                document.getElementById('simple-tab').classList.add('active');
            } else if (tabId === 'full-preview') {
                document.getElementById('full-tab').classList.add('active');
            } else if (tabId === 'new-features') {
                document.getElementById('new-features-tab').classList.add('active');
            } else if (tabId === 'html-source') {
                document.getElementById('html-source-tab').classList.add('active');
            }
        }

        // 更新HTML源码显示
        function updateHtmlSource(html) {
            if (html) {
                const formattedHtml = formatHtml(html);
                document.getElementById('html-source-content').textContent = formattedHtml;
            }
        }

        // 格式化HTML源码
        function formatHtml(html) {
            // 简单的HTML格式化
            let formatted = html;
            
            // 添加换行符
            formatted = formatted.replace(/></g, '>\n<');
            
            // 添加缩进
            const lines = formatted.split('\n');
            let indent = 0;
            const indentSize = 2;
            
            const formattedLines = lines.map(line => {
                const trimmed = line.trim();
                if (!trimmed) return '';
                
                // 检查是否是结束标签
                if (trimmed.match(/^<\/\w+>/)) {
                    indent = Math.max(0, indent - indentSize);
                }
                
                const indentedLine = ' '.repeat(indent) + trimmed;
                
                // 检查是否是开始标签（非自闭合）
                if (trimmed.match(/^<\w+[^>]*>/) && !trimmed.match(/\/>$/)) {
                    indent += indentSize;
                }
                
                return indentedLine;
            });
            
            return formattedLines.join('\n');
        }
        
        // 辅助函数
        function showLoading(show) {
            document.getElementById('loading').classList.toggle('show', show);
        }
        
        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
        }
        
        function clearConsole() {
            consoleOutput = '';
            updateConsoleDisplay();
        }
        
        function updateStats(results) {
            const passedCount = results.filter(r => r.success).length;
            const avgTime = results.length > 0 ? 
                (results.reduce((sum, r) => sum + parseFloat(r.time), 0) / results.length).toFixed(2) : 0;
            
            document.getElementById('test-count').textContent = results.length;
            document.getElementById('pass-count').textContent = passedCount;
            document.getElementById('avg-time').textContent = avgTime + 'ms';
            document.getElementById('total-blocks').textContent = testData ? testData.blocks.length : '未加载';
            
            document.getElementById('stats').style.display = 'grid';
        }
        
        // 初始化
        console.log('🎯 FlowEdit 优化版 Parser 测试环境已准备就绪');
        console.log('新功能包括: 统一错误处理、解耦架构、占位符条件渲染、简化List模板、模板验证器');
        
        // 预加载测试数据和样式模板
        Promise.all([loadTestData(), loadStyleTemplate()]).then(results => {
            const [dataLoaded, templateLoaded] = results;
            if (dataLoaded && templateLoaded) {
                console.log('✅ 测试数据和样式模板预加载完成，可以开始测试');
                console.log(`测试数据包含 ${testData.blocks.length} 个块，样式主题: ${styleTemplate.theme}`);
            } else {
                console.log('❌ 预加载失败，请检查文件路径');
            }
        });
    </script>
</body>
</html>