<!--
/**
 * EditorJS 集成测试页面
 * 用于测试 EditorJS 编辑器的完整功能，包括各种插件和数据输出
 * 这是一个独立的HTML页面，可以直接在浏览器中打开进行手动测试
 */
-->
<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>EditorJS 集成测试页面</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        display: flex;
        gap: 20px;
        min-height: 80vh;
      }
      .editor-section {
        flex: 1;
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .output-section {
        flex: 1;
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      #editorjs {
        min-height: 400px;
        border: 1px solid #e0e0e0;
        border-radius: 4px;
        padding: 10px;
      }
      #output {
        background: #f8f9fa;
        border: 1px solid #e0e0e0;
        border-radius: 4px;
        padding: 15px;
        font-family: "Courier New", monospace;
        font-size: 12px;
        white-space: pre-wrap;
        overflow-y: auto;
        max-height: 400px;
      }
      .controls {
        margin: 15px 0;
        display: flex;
        gap: 10px;
      }
      button {
        padding: 8px 16px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
      }
      button:hover {
        background: #0056b3;
      }
      button:disabled {
        background: #6c757d;
        cursor: not-allowed;
      }
      .status {
        margin: 10px 0;
        padding: 10px;
        border-radius: 4px;
        font-size: 14px;
      }
      .status.success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .status.error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      h1 {
        text-align: center;
        color: #333;
        margin-bottom: 30px;
      }
      h2 {
        color: #555;
        margin-bottom: 15px;
      }
    </style>
  </head>
  <body>
    <h1>EditorJS 测试页面</h1>

    <div class="container">
      <div class="editor-section">
        <h2>编辑器</h2>
        <div id="status" class="status" style="display: none"></div>
        <div id="editorjs"></div>
        <div class="controls">
          <button id="saveBtn" onclick="saveData()">保存数据</button>
          <button id="loadBtn" onclick="loadSampleData()">加载示例数据</button>
          <button id="clearBtn" onclick="clearEditor()">清空编辑器</button>
        </div>
      </div>

      <div class="output-section">
        <h2>数据输出</h2>
        <div class="controls">
          <button onclick="refreshOutput()">刷新输出</button>
          <button onclick="copyOutput()">复制数据</button>
          <button onclick="toggleOutputMode()">切换模式</button>
        </div>
        <div style="margin-bottom: 10px">
          <span id="outputModeLabel">当前模式: JSON</span>
        </div>
        <div id="output">等待编辑器初始化...</div>
      </div>
    </div>

    <!-- 加载 EditorJS 核心 -->
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/editorjs@latest"></script>

    <!-- 加载 EditorJS 插件 -->
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/header@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/quote@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/simple-image@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/list@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/link@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/embed@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/table@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/delimiter@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/warning@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/code@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/raw@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/attaches@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/marker@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/inline-code@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/raw@2.5.1/dist/raw.umd.min.js"></script>

    <!-- 加载自定义 HTML 解析器模块 -->
    <script src="../../src/content/config/style-template.js"></script>
    <script>
      // 直接嵌入 HTML 解析器代码（避免 ES6 模块导入问题）

      // HTML模板配置（从 style-template.js 获取）
      const HTML_TEMPLATES = window.HTML_TEMPLATES || {
        inlineStyles: {
          a: `<span style="color: rgb(16, 185, 129); text-decoration: underline; text-decoration-color: rgba(16, 185, 129, 0.5); text-underline-offset: 2px;">{{content}}</span>`,
          b: `<span style="font-weight: 700; color: rgb(16, 185, 129);">{{content}}</span>`,
          i: `<span style="font-style: italic; color: rgb(16, 185, 129); letter-spacing: 0.5px; font-weight: 500;">{{content}}</span>`,
          u: `<span style="text-decoration: underline; text-decoration-color: rgb(16, 185, 129); text-underline-offset: 3px; text-decoration-thickness: 2px;">{{content}}</span>`,
          mark: `<span style="background: rgba(16, 185, 129, 0.2); padding: 0.1em 0.4em; border-radius: 3px;">{{content}}</span>`,
          code: `<span style="font-family: 'Consolas', 'Monaco', 'Courier New', monospace; font-size: 0.85em; background: rgba(16, 185, 129, 0.1); color: rgb(6, 95, 70); padding: 0.25em 0.6em; border-radius: 5px; border: 1px solid rgba(16, 185, 129, 0.25); font-weight: 500; letter-spacing: 0.3px;">{{content}}</span>`,
          sup: `<sup style="color: rgba(16, 185, 129, 0.7); font-size: 0.7em; margin-left: 0.2em;">{{sup}}</sup>`,
        },
        paragraph: {
          default: `<section style="font-style: normal;font-variant-ligatures: normal;font-variant-caps: normal;orphans: 2;text-indent: 0px;text-transform: none;widows: 2;word-spacing: 0px;-webkit-text-stroke-width: 0px;white-space: normal;text-decoration-thickness: initial;text-decoration-style: initial;text-decoration-color: initial;box-sizing: border-box;border-width: 0px;border-style: solid;margin: 0.8em 0px;text-align: left;line-height: 1.7;font-family: -apple-system, BlinkMacSystemFont, &quot;Segoe UI&quot;, Roboto, &quot;Helvetica Neue&quot;, Arial, sans-serif;display: block;padding: 0px;"><section style="font-size: 16px; color: rgb(55, 65, 81); letter-spacing: 0.3px; padding: 0.5em 1.2em;"><span leaf="">{{content}}</span></section></section>`,
        },
        header: {
          h1: `<section style="font-style: normal;font-variant-ligatures: normal;font-variant-caps: normal;letter-spacing: 0.5px;orphans: 2;text-indent: 0px;text-transform: none;widows: 2;word-spacing: 0px;-webkit-text-stroke-width: 0px;white-space: normal;text-decoration-thickness: initial;text-decoration-style: initial;text-decoration-color: initial;box-sizing: border-box;border-width: 0px;border-style: solid;font-size: 20px;font-weight: 600;margin: 1.8em 0px 1.2em;text-align: center;line-height: 1.4;font-family: -apple-system, BlinkMacSystemFont, &quot;Segoe UI&quot;, Roboto, &quot;Helvetica Neue&quot;, Arial, sans-serif;display: flex;justify-content: center;padding: 0px;color: rgb(4, 120, 87);"><section style="display: inline-block;padding: 1em 2.2em;color: rgb(255, 255, 255);background: linear-gradient(135deg, rgb(16, 185, 129) 0%, rgb(5, 150, 105) 100%);border-radius: 12px;box-shadow: rgba(16, 185, 129, 0.25) 0px 6px 20px -4px, rgba(0, 0, 0, 0.1) 0px 2px 8px -2px;"><span leaf="">{{content}}</span></section></section>`,
          h2: `<section style="font-style: normal;font-variant-ligatures: normal;font-variant-caps: normal;letter-spacing: 0.3px;orphans: 2;text-indent: 0px;text-transform: none;widows: 2;word-spacing: 0px;-webkit-text-stroke-width: 0px;white-space: normal;text-decoration-thickness: initial;text-decoration-style: initial;text-decoration-color: initial;box-sizing: border-box;border-width: 0px;border-style: solid;font-size: 18px;font-weight: 600;margin: 1.5em 0px 1em;text-align: left;line-height: 1.4;font-family: -apple-system, BlinkMacSystemFont, &quot;Segoe UI&quot;, Roboto, &quot;Helvetica Neue&quot;, Arial, sans-serif;display: block;padding: 0px;color: rgb(4, 120, 87);"><section style="display: inline-flex; align-items: center; padding: 0.8em 1.8em 0.8em 1.2em; background: rgba(16, 185, 129, 0.06); border-left: 4px solid rgb(16, 185, 129); border-radius: 0px 8px 8px 0px; min-width: fit-content;"><span style="display: inline-block; width: 8px; height: 8px; background: rgb(16, 185, 129); border-radius: 50%; margin-right: 0.8em; vertical-align: middle;"></span><span leaf="">{{content}}</span></section></section>`,
        },
      };

      // 简化的 HTML 解析器类
      class CustomHtmlParser {
        constructor(templates = HTML_TEMPLATES) {
          this.templates = templates;
        }

        processInlineStyles(text) {
          if (!text) return "";

          const htmlString = `<div>${text}</div>`;
          const doc = new DOMParser().parseFromString(htmlString, "text/html");
          const styles = this.templates.inlineStyles;

          // 处理链接
          doc.querySelectorAll("a").forEach((a) => {
            const content = a.innerHTML;
            const styledHtml = styles.a.replace(/{{content}}/g, content);
            const tempDiv = document.createElement("div");
            tempDiv.innerHTML = styledHtml;
            a.replaceWith(...tempDiv.childNodes);
          });

          // 处理加粗
          doc.querySelectorAll("b, strong").forEach((b) => {
            const content = b.innerHTML;
            const styledHtml = styles.b.replace(/{{content}}/g, content);
            const tempDiv = document.createElement("div");
            tempDiv.innerHTML = styledHtml;
            b.replaceWith(...tempDiv.childNodes);
          });

          // 处理斜体
          doc.querySelectorAll("i, em").forEach((i) => {
            const content = i.innerHTML;
            const styledHtml = styles.i.replace(/{{content}}/g, content);
            const tempDiv = document.createElement("div");
            tempDiv.innerHTML = styledHtml;
            i.replaceWith(...tempDiv.childNodes);
          });

          // 处理下划线
          doc.querySelectorAll("u").forEach((u) => {
            const content = u.innerHTML;
            const styledHtml = styles.u.replace(/{{content}}/g, content);
            const tempDiv = document.createElement("div");
            tempDiv.innerHTML = styledHtml;
            u.replaceWith(...tempDiv.childNodes);
          });

          // 处理高亮
          doc.querySelectorAll("mark").forEach((mark) => {
            const content = mark.innerHTML;
            const styledHtml = styles.mark.replace(/{{content}}/g, content);
            const tempDiv = document.createElement("div");
            tempDiv.innerHTML = styledHtml;
            mark.replaceWith(...tempDiv.childNodes);
          });

          // 处理行内代码
          doc.querySelectorAll("code").forEach((code) => {
            const content = code.innerHTML;
            const styledHtml = styles.code.replace(/{{content}}/g, content);
            const tempDiv = document.createElement("div");
            tempDiv.innerHTML = styledHtml;
            code.replaceWith(...tempDiv.childNodes);
          });

          // 处理上标
          doc.querySelectorAll("sup").forEach((sup) => {
            const content = sup.innerHTML;
            const styledHtml = styles.sup.replace(/{{sup}}/g, content);
            const tempDiv = document.createElement("div");
            tempDiv.innerHTML = styledHtml;
            sup.replaceWith(...tempDiv.childNodes);
          });

          return doc.body.querySelector("div").innerHTML;
        }

        parseBlock(block) {
          if (!block || !block.type) {
            console.warn("无效的块数据:", block);
            return "";
          }

          const blockData = block.data || {};
          let content = "";

          // 根据块类型处理内容
          switch (block.type) {
            case "paragraph":
              content = this.processInlineStyles(blockData.text || "");
              return this.templates.paragraph.default.replace(
                /{{content}}/g,
                content
              );

            case "header":
              const level = Math.min(Math.max(blockData.level || 1, 1), 6);
              const headerTemplate =
                this.templates.header[`h${level}`] || this.templates.header.h2;
              content = this.escapeHtml(blockData.text || "");
              return headerTemplate.replace(/{{content}}/g, content);

            default:
              content = this.processInlineStyles(
                blockData.text || blockData.content || ""
              );
              return `<div style="margin: 10px 0; padding: 10px; border-left: 3px solid #ccc;">${content}</div>`;
          }
        }

        escapeHtml(text) {
          if (!text) return "";
          return String(text)
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#39;");
        }

        parse(editorData) {
          if (!editorData || !Array.isArray(editorData.blocks)) {
            console.warn("无效的EditorJS数据");
            return "";
          }

          const htmlBlocks = editorData.blocks
            .map((block) => this.parseBlock(block))
            .filter((html) => html.trim());

          return htmlBlocks.join("\n");
        }
      }

      // 创建解析器实例
      const customHtmlParser = new CustomHtmlParser();

      // 包装器类，保持与原有接口兼容
      class HTMLParser {
        constructor() {
          this.parser = customHtmlParser;
          this.isInitialized = true;
        }

        init() {
          console.log("自定义 HTML 解析器初始化成功");
          return true;
        }

        isReady() {
          return this.isInitialized;
        }

        parse(editorData) {
          if (!this.isReady()) {
            throw new Error("HTML 解析器未初始化");
          }

          try {
            return this.parser.parse(editorData);
          } catch (error) {
            console.error("HTML 解析失败:", error);
            throw new Error("HTML 解析失败: " + error.message);
          }
        }

        safeParse(editorData) {
          try {
            const html = this.parse(editorData);
            console.log("HTML 解析成功", html);
            return {
              success: true,
              html: html,
              error: null,
            };
          } catch (error) {
            return {
              success: false,
              html: null,
              error: error.message,
            };
          }
        }

        getFormattedHTML(editorData) {
          const result = this.safeParse(editorData);

          if (result.success) {
            return `<div style="border: 1px solid #ddd; padding: 10px; background: white; border-radius: 4px;">${result.html}</div>`;
          } else {
            return `<div style="color: red; padding: 10px;">HTML 解析失败: ${result.error}</div>`;
          }
        }
      }

      // 创建全局实例
      const htmlParser = new HTMLParser();

      // 导出到全局作用域
      window.HTMLParser = HTMLParser;
      window.htmlParser = htmlParser;

      // 自动初始化
      htmlParser.init();
    </script>

    <script>
      // 全局变量
      let editor;
      let outputMode = "json"; // 'json' 或 'html'

      /**
       * 初始化 EditorJS 编辑器
       */
      function initEditor() {
        try {
          editor = new EditorJS({
            holder: "editorjs",
            placeholder: "开始编写内容...",
            hideToolbar: false,
            tools: {
              header: {
                class: Header,
                config: {
                  placeholder: "输入标题...",
                  levels: [1, 2, 3],
                  defaultLevel: 2,
                },
              },
              quote: {
                class: Quote,
                config: {
                  quotePlaceholder: "输入引用内容...",
                  captionPlaceholder: "",
                },
              },
              image: SimpleImage,
              List: {
                class: EditorjsList,
                inlineToolbar: true,
                config: {
                  defaultStyle: "unordered",
                  maxLevel: 5,
                  styles: ["ordered", "unordered"],
                },
              },
              linkTool: {
                class: LinkTool,
                config: {
                  endpoint: "http://localhost:8008/fetchUrl",
                },
              },
              embed: {
                class: Embed,
                config: {
                  services: {
                    youtube: true,
                    coub: true,
                  },
                },
              },
              table: {
                class: Table,
                inlineToolbar: true,
                config: {
                  rows: 2,
                  cols: 3,
                },
              },
              delimiter: Delimiter,
              warning: {
                class: Warning,
                inlineToolbar: true,
                config: {
                  titlePlaceholder: "警告标题...",
                  messagePlaceholder: "警告内容...",
                },
              },
              code: {
                class: CodeTool,
                config: {
                  placeholder: "输入代码...",
                },
              },
              raw: {
                class: RawTool,
                config: {
                  placeholder: "输入原始HTML...",
                },
              },
              attaches: {
                class: AttachesTool,
                config: {
                  endpoint: "http://localhost:8008/uploadFile",
                },
              },
              Marker: {
                class: Marker,
                shortcut: "CMD+SHIFT+M",
              },
              inlineCode: {
                class: InlineCode,
                shortcut: "CMD+SHIFT+M",
              },
            },
            onChange: function () {
              refreshOutput();
            },
            onReady: function () {
              showStatus("编辑器初始化成功！", "success");
              refreshOutput();
            },
          });
        } catch (error) {
          console.error("编辑器初始化失败:", error);
          showStatus("编辑器初始化失败: " + error.message, "error");
        }
      }

      /**
       * 显示状态信息
       * @param {string} message - 状态消息
       * @param {string} type - 状态类型 ('success' 或 'error')
       */
      function showStatus(message, type) {
        const statusEl = document.getElementById("status");
        statusEl.textContent = message;
        statusEl.className = `status ${type}`;
        statusEl.style.display = "block";

        // 3秒后自动隐藏
        setTimeout(() => {
          statusEl.style.display = "none";
        }, 3000);
      }

      /**
       * 保存编辑器数据
       */
      async function saveData() {
        if (!editor) {
          showStatus("编辑器未初始化", "error");
          return;
        }

        try {
          const outputData = await editor.save();
          console.log("保存的数据:", outputData);
          showStatus("数据保存成功！", "success");
          refreshOutput();
        } catch (error) {
          console.error("保存失败:", error);
          showStatus("保存失败: " + error.message, "error");
        }
      }

      /**
       * 加载示例数据
       */
      async function loadSampleData() {
        if (!editor) {
          showStatus("编辑器未初始化", "error");
          return;
        }

        const sampleData = {
          time: Date.now(),
          blocks: [
            {
              type: "header",
              data: {
                text: "EditorJS 示例内容",
                level: 1,
              },
            },
            {
              type: "paragraph",
              data: {
                text: "这是一个 EditorJS 编辑器的示例内容。你可以在这里编辑文本，添加各种块类型。",
              },
            },
            {
              type: "header",
              data: {
                text: "功能特性",
                level: 2,
              },
            },
            {
              type: "list",
              data: {
                style: "unordered",
                items: ["支持多种块类型", "实时预览", "数据导出", "HTML 转换"],
              },
            },
            {
              type: "quote",
              data: {
                text: "EditorJS 是一个现代化的块级编辑器，具有干净的 JSON 输出。",
                caption: "EditorJS 官方介绍",
              },
            },
            {
              type: "code",
              data: {
                code: 'console.log("Hello, EditorJS!");',
              },
            },
          ],
          version: "2.28.2",
        };

        try {
          await editor.render(sampleData);
          showStatus("示例数据加载成功！", "success");
          refreshOutput();
        } catch (error) {
          console.error("加载示例数据失败:", error);
          showStatus("加载示例数据失败: " + error.message, "error");
        }
      }

      /**
       * 清空编辑器
       */
      async function clearEditor() {
        if (!editor) {
          showStatus("编辑器未初始化", "error");
          return;
        }

        try {
          await editor.clear();
          showStatus("编辑器已清空", "success");
          refreshOutput();
        } catch (error) {
          console.error("清空编辑器失败:", error);
          showStatus("清空编辑器失败: " + error.message, "error");
        }
      }

      /**
       * 刷新输出显示
       */
      async function refreshOutput() {
        if (!editor) {
          document.getElementById("output").textContent = "编辑器未初始化";
          return;
        }

        try {
          const outputData = await editor.save();
          const outputEl = document.getElementById("output");

          if (outputMode === "json") {
            outputEl.textContent = JSON.stringify(outputData, null, 2);
          } else if (outputMode === "html") {
            if (window.htmlParser && window.htmlParser.isReady()) {
              const result = window.htmlParser.safeParse(outputData);
              if (result.success) {
                outputEl.innerHTML = `<div style="background: white; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">${result.html}</div>`;
              } else {
                outputEl.textContent = "HTML 解析失败: " + result.error;
              }
            } else {
              outputEl.textContent = "HTML 解析器未就绪";
            }
          }
        } catch (error) {
          console.error("刷新输出失败:", error);
          document.getElementById("output").textContent =
            "获取数据失败: " + error.message;
        }
      }

      /**
       * 复制输出内容
       */
      async function copyOutput() {
        const outputEl = document.getElementById("output");
        const text = outputEl.textContent || outputEl.innerText;

        try {
          await navigator.clipboard.writeText(text);
          showStatus("内容已复制到剪贴板", "success");
        } catch (error) {
          console.error("复制失败:", error);
          showStatus("复制失败: " + error.message, "error");
        }
      }

      /**
       * 切换输出模式
       */
      function toggleOutputMode() {
        outputMode = outputMode === "json" ? "html" : "json";
        document.getElementById(
          "outputModeLabel"
        ).textContent = `当前模式: ${outputMode.toUpperCase()}`;
        refreshOutput();
      }

      // 页面加载完成后初始化编辑器
      document.addEventListener("DOMContentLoaded", function () {
        // 等待所有脚本加载完成
        setTimeout(initEditor, 500);
      });
    </script>
  </body>
</html>
