<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>自定义 EditorJS 组件渲染测试</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            display: flex;
            gap: 20px;
            min-height: 80vh;
        }
        .editor-section {
            flex: 1;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .output-section {
            flex: 1;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        #editorjs {
            min-height: 400px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            padding: 10px;
        }
        #output {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            padding: 15px;
            min-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
        }
        .controls {
            margin: 15px 0;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            background: #007bff;
            color: white;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #0056b3;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info-box {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .info-box h3 {
            margin-top: 0;
            color: #1976d2;
        }
        .custom-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            margin: 10px 0;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            border-left: 5px solid #ffd700;
        }
        .custom-paragraph {
            background: #f8f9fa;
            border-left: 4px solid #28a745;
            padding: 15px;
            margin: 10px 0;
            border-radius: 0 8px 8px 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>
    <h1>自定义 EditorJS 组件渲染测试</h1>
    
    <div class="info-box">
        <h3>测试说明</h3>
        <p>这个页面演示了如何通过继承 EditorJS 的 Header 和 Paragraph 组件来自定义 render() 方法，实现个性化的 HTML 渲染样式。</p>
        <ul>
            <li><strong>CustomHeader</strong>: 继承自 Header，添加渐变背景和阴影效果</li>
            <li><strong>CustomParagraph</strong>: 继承自 Paragraph，添加左边框和背景色</li>
        </ul>
    </div>

    <div class="container">
        <div class="editor-section">
            <h2>编辑器</h2>
            <div id="status" class="status" style="display: none"></div>
            <div id="editorjs"></div>
            <div class="controls">
                <button onclick="saveData()">保存数据</button>
                <button onclick="loadSampleData()">加载示例数据</button>
                <button onclick="clearEditor()">清空编辑器</button>
                <button onclick="exportHTML()">导出HTML</button>

            </div>
        </div>

        <div class="output-section">
            <h2>数据输出</h2>
            <div class="controls">
                <button onclick="refreshOutput()">刷新输出</button>
                <button onclick="copyOutput()">复制数据</button>
                <button onclick="toggleOutputMode()">切换模式</button>
                <button onclick="previewWithTemplate()">模板预览</button>
            </div>
            <div style="margin-bottom: 10px">
                <span id="outputModeLabel">当前模式: JSON</span>
            </div>
            <div id="output">等待编辑器初始化...</div>
        </div>
    </div>

    <!-- 加载 EditorJS 核心 -->
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/editorjs@latest"></script>
    <!-- 加载 EditorJS 插件 -->
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/header@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/paragraph@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/quote@latest"></script>

    <script src="https://cdn.jsdelivr.net/npm/@editorjs/delimiter@latest"></script>

    <script>
        // 样式模板数据（从 style-template.js 复制）
        const HTML_TEMPLATES = {
            // 头部模板
            head: `<section data-mpa-template="t" data-mpa-template-id="23968" data-mpa-category="style_single_material"><section style="display:flex;flex-direction:column;padding:0 10px;" data-mid=""><section style="display:flex;flex-direction:column;align-self:flex-start;" data-mid=""><section nodeleaf="" style="display:flex;justify-content:center;align-items:center;z-index:1;width:16px;margin:0 0 -1px 25px;" data-mid=""><img src="https://mmbiz.qpic.cn/mmbiz_png/dEf5U8O2YzjX7RPfmgLtXZGQ4emxXdzQs0UcN2m15pprg9EBQ6X6wYZvncMFvgT45MTASpAn6tyLMN2ibLGiawRA/0?from=appmsg" alt="" style="display:block;" data-mid=""></section><section style="background:#FFFFFF;border:1px solid #1a6840;padding:6px 18px 5px 19px;text-align:left;border-radius:32px;" data-mid=""><p yb-mpa-mark="mark-style-text" style="font-size:14px;color:#333333;line-height:20px;word-break:break-word;" data-mid="">点击上方<span style="color:#1a6840;" data-mid="">蓝字</span>关注我们</p></section><section nodeleaf="" style="display:flex;justify-content:center;align-items:center;width:24px;align-self:center;margin:-6px 0 0 0;" data-mid=""><img src="https://mmbiz.qpic.cn/mmbiz_gif/YtIDLfKRkon8SLKBvmCfjvZ4I8azbdaFnZbM5cE2jjuApZCV2VwwWaUAgspNrka1Qn9VQnbH2064IVdEaFl37w/0?from=appmsg" alt="" style="display:block;" data-mid=""></section></section></section></section>`,

            // 尾部模板
            ending: `<section></section>`,

            // 内联样式配置
            inlineStyles: {
                bold: "font-weight:bold;",
                italic: "font-style:italic;",
                underline: "text-decoration:underline;",
                strikethrough: "text-decoration:line-through;",
                code: "background:rgba(26,104,64,0.1);padding:2px 4px;border-radius:3px;font-family:'Courier New',monospace;font-size:0.9em;",
                mark: "background:rgba(26,104,64,0.2);padding:1px 2px;border-radius:2px;",
                small: "font-size:0.85em;",
                sup: "font-size:0.75em;vertical-align:super;",
                sub: "font-size:0.75em;vertical-align:sub;",
                link: "color:rgba(26,104,64,1);text-decoration:underline;transition:color 0.2s ease;",
                cite: "display:block;margin-top:0.5em;font-size:0.9em;color:rgba(26,104,64,0.7);",
            },
            header: {
                h1: `<section style="text-align: center;"><section style="width:100%;padding:0px 12px;" data-mid=""><section style="width:100%;display:flex;align-items:center;justify-content:space-between;" data-mid=""><section style="display:flex;align-items:center;width:100%;height:5px;" data-mid=""><section style="flex-shrink:0;width:6px;height:6px;background:#1a6840;border-radius:50%;" data-mid=""><span leaf=""><br class="ProseMirror-trailingBreak"></span></section><section style="width:100%;border-top:1px solid #1a6840;height:1px;" data-mid=""><span leaf=""><br class="ProseMirror-trailingBreak"></span></section></section><section style="flex-shrink:0;min-width:79px;text-align:center;background:#1a6840;padding:5px 15px 4px 15px;" data-mid=""><p style="color:#ffffff;font-size:16px;line-height:17px;word-break:break-word;" data-mid=""><span leaf="">{{content}}</span><mpchecktext></mpchecktext></p></section><section style="display:flex;align-items:center;width:100%;" data-mid=""><section style="width:100%;border-top:1px solid #1a6840;height:1px;" data-mid=""><span leaf=""><br class="ProseMirror-trailingBreak"></span></section><section style="flex-shrink:0;width:6px;height:6px;background:#1a6840;border-radius:50%;" data-mid=""><span leaf=""><br class="ProseMirror-trailingBreak"></span></section></section></section></section></section>`,

                h2: `<section data-block="header" data-level="2" style="text-indent:0px;margin-bottom:8px;"><h2 style="font-size:17px;color:rgba(26,104,64,1);font-weight:bold;margin:1.5em 8px 1em;border-bottom:1px solid rgba(26,104,64,0.3);padding-bottom:0.3em;">{{content}}</h2></section>`,

                h3: `<section data-block="header" data-level="3" style="text-indent:0px;margin-bottom:8px;"><h3 style="font-size:15px;color:rgba(26,104,64,1);font-weight:bold;margin:1.2em 8px 0.8em;">{{content}}</h3></section>`,
            },

            paragraph: {
                default: `<section style="margin-bottom:8px;margin-left:16px;margin-right:16px;"><div style="font-size:14px; line-height:2em;"><span style="letter-spacing:2px;">{{content}}</span></div></section>`,
            },

            quote: {
                default: `<section style="margin-bottom:8px;margin-left:16px;margin-right:16px;"><blockquote style="background-color:rgba(26,104,64,0.1); border-left:4px solid #1a6840; padding:1em 1.5em; border-radius:6px; margin:0;"><p style="font-size:1.05em; color:#212529; margin:0; font-style:italic;">{{content}}</p><span style="display:block; text-align:right; color:rgba(26,104,64,0.7); font-size:1em; margin-top:1em;">—— {{caption}}</span></blockquote></section>`,
            },

            delimiter: {
                default: `<section style="margin-bottom:8px;margin-left:16px;margin-right:16px;"><hr style="border:0; height:1px; background-image:linear-gradient(to right, rgba(26,104,64,0), rgba(26,104,64,0.25), rgba(26,104,64,0)); margin:2em 0;"></section>`,
            },

            raw: {
                default: ``,
            },



            // 后备HTML模板
            fallback: {
                container: "margin:1.5em 8px;padding:0.5em;border:1px dashed rgba(26,104,64,0.3);background-color:rgba(26,104,64,0.05);",
                warning: "color:rgba(26,104,64,0.7);font-size:0.8em;",
                content: "margin-top:0.5em;",
            },
        };
        
        let editor;
        let outputMode = 'json'; // 'json' 或 'html'


        /**
         * 自定义 Header 组件
         * 继承自 EditorJS Header，重写 render 方法以实现自定义样式
         */
        class CustomHeader {
            constructor({ data, config, api, readOnly }) {
                this.api = api;
                this.readOnly = readOnly;
                this.config = config || {};
                this.data = {
                    text: data.text || '',
                    level: parseInt(data.level) || 2
                };
                this.settingsButtons = [];
                this.wrapper = undefined;
                this.currentLevel = this.data.level;
            }

            /**
             * 自定义渲染方法 - 使用模板样式
             */
            render() {
                return this.renderWithTemplate();
            }

            /**
             * 使用样式模板渲染
             */
            renderWithTemplate() {
                const templateKey = `h${this.currentLevel}`;
                const template = HTML_TEMPLATES.header[templateKey] || HTML_TEMPLATES.header.h2;
                
                // 创建临时容器来解析模板HTML
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = template.replace('{{content}}', this.data.text || '');
                
                // 获取模板的根元素
                this.wrapper = tempDiv.firstElementChild.cloneNode(true);
                
                // 根据不同的模板结构查找可编辑元素
                let editableElement;
                if (this.currentLevel === 1) {
                    // h1模板使用复杂的section结构，文本在span[leaf]中
                    editableElement = this.wrapper.querySelector('span[leaf=""]');
                } else {
                    // h2, h3等直接使用h标签
                    editableElement = this.wrapper.querySelector('h2, h3, h4, h5, h6');
                }
                
                if (editableElement) {
                    editableElement.contentEditable = !this.readOnly;
                    editableElement.dataset.placeholder = this.api.i18n.t('Header');
                    
                    // 绑定输入事件
                    editableElement.addEventListener('input', () => {
                        this.data.text = editableElement.textContent || editableElement.innerHTML;
                    });
                    
                    // 绑定键盘事件，防止换行
                    editableElement.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                        }
                    });
                    
                    // 设置初始焦点样式
                    editableElement.addEventListener('focus', () => {
                        editableElement.style.outline = '2px solid #007bff';
                    });
                    
                    editableElement.addEventListener('blur', () => {
                        editableElement.style.outline = 'none';
                    });
                }
                
                return this.wrapper;
            }

            /**
             * 使用自定义样式渲染
             */
            renderWithCustomStyle() {
                this.wrapper = document.createElement('div');
                this.wrapper.classList.add('custom-header');
                
                const header = document.createElement(`h${this.currentLevel}`);
                header.contentEditable = !this.readOnly;
                header.classList.add('ce-header');
                header.innerHTML = this.data.text || '';
                header.dataset.placeholder = this.api.i18n.t('Header');
                
                // 添加自定义样式
                header.style.margin = '0';
                header.style.fontSize = this.currentLevel === 1 ? '28px' : '22px';
                header.style.fontWeight = 'bold';
                header.style.textShadow = '0 2px 4px rgba(0,0,0,0.3)';
                
                header.addEventListener('input', () => {
                    this.data.text = header.innerHTML;
                });
                
                this.wrapper.appendChild(header);
                return this.wrapper;
            }

            /**
             * 保存数据
             */
            save(blockContent) {
                let textContent = '';
                
                // 根据不同的模板结构提取文本
                if (this.currentLevel === 1) {
                    // h1模板使用复杂的section结构，文本在span[leaf]中
                    const spanElement = blockContent.querySelector('span[leaf=""]');
                    textContent = spanElement ? (spanElement.textContent || spanElement.innerHTML) : '';
                } else {
                    // h2, h3等直接使用h标签
                    const headerElement = blockContent.querySelector('h2, h3, h4, h5, h6');
                    textContent = headerElement ? (headerElement.textContent || headerElement.innerHTML) : '';
                }
                
                return {
                    text: textContent,
                    level: this.currentLevel
                };
            }

            /**
             * 工具栏设置
             */
            renderSettings() {
                const wrapper = document.createElement('div');
                
                [1, 2, 3, 4, 5, 6].forEach(level => {
                    const button = document.createElement('span');
                    button.classList.add('cdx-settings-button');
                    button.innerHTML = `H${level}`;
                    button.classList.toggle('cdx-settings-button--active', level === this.currentLevel);
                    
                    button.addEventListener('click', () => {
                        this.currentLevel = level;
                        this.data.level = level;
                        
                        // 更新标题标签
                        const oldHeader = this.wrapper.querySelector('h1, h2, h3, h4, h5, h6');
                        const newHeader = document.createElement(`h${level}`);
                        newHeader.innerHTML = oldHeader.innerHTML;
                        newHeader.contentEditable = oldHeader.contentEditable;
                        newHeader.classList = oldHeader.classList;
                        newHeader.style.cssText = oldHeader.style.cssText;
                        newHeader.style.fontSize = level === 1 ? '28px' : '22px';
                        
                        // 重新绑定事件
                        newHeader.addEventListener('input', () => {
                            this.data.text = newHeader.innerHTML;
                        });
                        
                        this.wrapper.replaceChild(newHeader, oldHeader);
                        
                        // 更新按钮状态
                        wrapper.querySelectorAll('.cdx-settings-button').forEach(btn => {
                            btn.classList.remove('cdx-settings-button--active');
                        });
                        button.classList.add('cdx-settings-button--active');
                    });
                    
                    wrapper.appendChild(button);
                });
                
                return wrapper;
            }

            /**
             * 工具配置
             */
            static get toolbox() {
                return {
                    icon: '<svg width="11" height="14" xmlns="http://www.w3.org/2000/svg"><path d="M7.6 8.15H2.25v4.525a1.125 1.125 0 0 1-2.25 0V1.125a1.125 1.125 0 1 1 2.25 0V5.6H7.6V1.125a1.125 1.125 0 0 1 2.25 0v11.55a1.125 1.125 0 0 1-2.25 0V8.15Z"/></svg>',
                    title: '自定义标题'
                };
            }
        }

        /**
         * 自定义 Paragraph 组件
         * 继承自 EditorJS Paragraph，重写 render 方法以实现自定义样式
         */
        class CustomParagraph {
            constructor({ data, config, api, readOnly }) {
                this.api = api;
                this.readOnly = readOnly;
                this.config = config || {};
                this.data = {
                    text: data.text || ''
                };
                this.wrapper = undefined;
            }

            /**
             * 自定义渲染方法 - 使用模板样式
             */
            render() {
                return this.renderWithTemplate();
            }

            /**
             * 使用样式模板渲染
             */
            renderWithTemplate() {
                const template = HTML_TEMPLATES.paragraph.default;
                
                // 创建临时容器来解析模板HTML
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = template.replace('{{content}}', this.data.text || '');
                
                // 获取模板的根元素
                this.wrapper = tempDiv.firstElementChild.cloneNode(true);
                
                // 找到可编辑的文本元素并设置为可编辑
                const editableElement = this.wrapper.querySelector('div, span');
                if (editableElement) {
                    editableElement.contentEditable = !this.readOnly;
                    editableElement.addEventListener('input', () => {
                        this.data.text = editableElement.innerHTML;
                    });
                }
                
                return this.wrapper;
            }

            /**
             * 使用自定义样式渲染
             */
            renderWithCustomStyle() {
                this.wrapper = document.createElement('div');
                this.wrapper.classList.add('custom-paragraph');
                
                const paragraph = document.createElement('div');
                paragraph.contentEditable = !this.readOnly;
                paragraph.classList.add('ce-paragraph');
                paragraph.innerHTML = this.data.text || '';
                paragraph.dataset.placeholder = this.api.i18n.t('Type here...');
                
                // 添加自定义样式
                paragraph.style.margin = '0';
                paragraph.style.lineHeight = '1.6';
                paragraph.style.fontSize = '16px';
                paragraph.style.color = '#333';
                
                paragraph.addEventListener('input', () => {
                    this.data.text = paragraph.innerHTML;
                });
                
                this.wrapper.appendChild(paragraph);
                return this.wrapper;
            }

            /**
             * 保存数据
             */
            save(blockContent) {
                const paragraph = blockContent.querySelector('.ce-paragraph');
                return {
                    text: paragraph.innerHTML
                };
            }

            /**
             * 工具配置
             */
            static get toolbox() {
                return {
                    icon: '<svg width="14" height="14" xmlns="http://www.w3.org/2000/svg"><path d="M14 7a1 1 0 0 1-1 1H1a1 1 0 0 1 0-2h12a1 1 0 0 1 1 1zM14 3a1 1 0 0 1-1 1H1a1 1 0 1 1 0-2h12a1 1 0 0 1 1 1zM14 11a1 1 0 0 1-1 1H1a1 1 0 0 1 0-2h12a1 1 0 0 1 1 1z"/></svg>',
                    title: '自定义段落'
                };
            }
        }

        /**
         * 初始化 EditorJS
         */
        function initEditor() {
            editor = new EditorJS({
                holder: 'editorjs',
                placeholder: '开始输入内容...',
                tools: {
                    customHeader: {
                        class: CustomHeader,
                        config: {
                            placeholder: '输入标题...'
                        }
                    },
                    customParagraph: {
                        class: CustomParagraph,
                        config: {
                            placeholder: '输入段落内容...'
                        }
                    },
                    // 保留原生组件用于对比
                    header: Header,
                    quote: Quote,
                    delimiter: Delimiter
                },
                data: {
                    blocks: [
                        {
                            type: 'customHeader',
                            data: {
                                text: '这是自定义样式的标题',
                                level: 1
                            }
                        },
                        {
                            type: 'customParagraph',
                            data: {
                                text: '这是自定义样式的段落，具有特殊的背景色和左边框效果。'
                            }
                        },
                        {
                            type: 'header',
                            data: {
                                text: '这是原生的标题（用于对比）',
                                level: 2
                            }
                        }
                    ]
                },
                onChange: () => {
                    refreshOutput();
                },
                onReady: () => {
                    showStatus('编辑器初始化成功！', 'success');
                    refreshOutput();
                }
            });
        }

        /**
         * 显示状态信息
         */
        function showStatus(message, type = 'success') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
            statusEl.style.display = 'block';
            
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 3000);
        }

        /**
         * 保存数据
         */
        async function saveData() {
            try {
                const outputData = await editor.save();
                localStorage.setItem('editorjs-data', JSON.stringify(outputData));
                showStatus('数据保存成功！', 'success');
            } catch (error) {
                console.error('保存失败:', error);
                showStatus('保存失败: ' + error.message, 'error');
            }
        }

        /**
         * 加载示例数据
         */
        function loadSampleData() {
            const sampleData = {
                blocks: [
                    {
                        type: 'customHeader',
                        data: {
                            text: '自定义标题示例 - 渐变背景',
                            level: 1
                        }
                    },
                    {
                        type: 'customParagraph',
                        data: {
                            text: '这是一个自定义段落示例，展示了如何通过继承 EditorJS 组件来实现个性化的渲染效果。注意左侧的绿色边框和浅灰色背景。'
                        }
                    },
                    {
                        type: 'customHeader',
                        data: {
                            text: '二级自定义标题',
                            level: 2
                        }
                    },
                    {
                        type: 'customParagraph',
                        data: {
                            text: '通过重写 render() 方法，我们可以完全控制组件的外观和行为，同时保持与 EditorJS 生态系统的兼容性。'
                        }
                    },
                    {
                        type: 'header',
                        data: {
                            text: '原生标题（对比）',
                            level: 2
                        }
                    },
                    {
                        type: 'quote',
                        data: {
                            text: '这是一个引用块，用于展示其他组件的正常渲染效果。',
                            caption: '引用说明'
                        }
                    },
                    {
                        type: 'delimiter',
                        data: {}
                    }
                ]
            };
            
            editor.render(sampleData);
            showStatus('示例数据加载成功！', 'success');
        }

        /**
         * 清空编辑器
         */
        function clearEditor() {
            editor.clear();
            showStatus('编辑器已清空', 'success');
        }

        /**
         * 导出HTML
         */
        async function exportHTML() {
            try {
                const outputData = await editor.save();
                let html = '';
                
                outputData.blocks.forEach(block => {
                    switch (block.type) {
                        case 'customHeader':
                            html += `<div class="custom-header"><h${block.data.level}>${block.data.text}</h${block.data.level}></div>\n`;
                            break;
                        case 'customParagraph':
                            html += `<div class="custom-paragraph"><div>${block.data.text}</div></div>\n`;
                            break;
                        case 'header':
                            html += `<h${block.data.level}>${block.data.text}</h${block.data.level}>\n`;
                            break;
                        case 'quote':
                            html += `<blockquote>${block.data.text}</blockquote>\n`;
                            break;
                        case 'delimiter':
                            html += `<hr>\n`;
                            break;
                        default:
                            html += `<div>${JSON.stringify(block.data)}</div>\n`;
                    }
                });
                
                // 创建新窗口显示HTML
                const newWindow = window.open('', '_blank');
                newWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>导出的HTML</title>
                        <style>
                            body { font-family: Arial, sans-serif; padding: 20px; }
                            .custom-header { ${document.querySelector('.custom-header') ? window.getComputedStyle(document.querySelector('.custom-header')).cssText : ''} }
                            .custom-paragraph { ${document.querySelector('.custom-paragraph') ? window.getComputedStyle(document.querySelector('.custom-paragraph')).cssText : ''} }
                        </style>
                    </head>
                    <body>${html}</body>
                    </html>
                `);
                newWindow.document.close();
                
                showStatus('HTML导出成功！', 'success');
            } catch (error) {
                console.error('导出失败:', error);
                showStatus('导出失败: ' + error.message, 'error');
            }
        }

        /**
         * 刷新输出
         */
        async function refreshOutput() {
            try {
                const outputData = await editor.save();
                const outputEl = document.getElementById('output');
                
                if (outputMode === 'json') {
                    outputEl.textContent = JSON.stringify(outputData, null, 2);
                } else {
                    // HTML 模式 - 简单转换
                    let html = '';
                    outputData.blocks.forEach(block => {
                        switch (block.type) {
                            case 'customHeader':
                                html += `<div class="custom-header"><h${block.data.level}>${block.data.text}</h${block.data.level}></div>\n`;
                                break;
                            case 'customParagraph':
                                html += `<div class="custom-paragraph"><div>${block.data.text}</div></div>\n`;
                                break;
                            case 'header':
                                html += `<h${block.data.level}>${block.data.text}</h${block.data.level}>\n`;
                                break;
                            case 'quote':
                                html += `<blockquote>${block.data.text}</blockquote>\n`;
                                break;
                            case 'delimiter':
                                html += `<hr>\n`;
                                break;
                            default:
                                html += `<div>${JSON.stringify(block.data)}</div>\n`;
                        }
                    });
                    outputEl.textContent = html;
                }
            } catch (error) {
                console.error('刷新输出失败:', error);
                document.getElementById('output').textContent = '获取数据失败: ' + error.message;
            }
        }

        /**
         * 复制输出内容
         */
        async function copyOutput() {
            const outputEl = document.getElementById('output');
            const text = outputEl.textContent || outputEl.innerText;
            
            try {
                await navigator.clipboard.writeText(text);
                showStatus('内容已复制到剪贴板', 'success');
            } catch (error) {
                console.error('复制失败:', error);
                showStatus('复制失败: ' + error.message, 'error');
            }
        }

        /**
         * 切换输出模式
         */
        function toggleOutputMode() {
            outputMode = outputMode === 'json' ? 'html' : 'json';
            document.getElementById('outputModeLabel').textContent = `当前模式: ${outputMode.toUpperCase()}`;
            refreshOutput();
        }



        /**
         * 使用模板样式预览HTML
         */
        async function previewWithTemplate() {
            try {
                const outputData = await editor.save();
                let html = HTML_TEMPLATES.head + '\n';
                
                outputData.blocks.forEach(block => {
                    switch (block.type) {
                        case 'customHeader':
                            const headerTemplate = HTML_TEMPLATES.header[`h${block.data.level}`] || HTML_TEMPLATES.header.h2;
                            html += headerTemplate.replace('{{content}}', block.data.text) + '\n';
                            break;
                        case 'customParagraph':
                            html += HTML_TEMPLATES.paragraph.default.replace('{{content}}', block.data.text) + '\n';
                            break;
                        case 'header':
                            const nativeHeaderTemplate = HTML_TEMPLATES.header[`h${block.data.level}`] || HTML_TEMPLATES.header.h2;
                            html += nativeHeaderTemplate.replace('{{content}}', block.data.text) + '\n';
                            break;
                        case 'quote':
                            html += HTML_TEMPLATES.quote.default
                                .replace('{{content}}', block.data.text)
                                .replace('{{caption}}', block.data.caption || '') + '\n';
                            break;
                        case 'delimiter':
                            html += HTML_TEMPLATES.delimiter.default + '\n';
                            break;
                        default:
                            html += `<div>${JSON.stringify(block.data)}</div>\n`;
                    }
                });
                
                html += HTML_TEMPLATES.ending;
                
                // 创建新窗口显示模板样式的HTML
                const newWindow = window.open('', '_blank');
                newWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>模板样式预览</title>
                        <meta charset="UTF-8">
                        <style>
                            body { 
                                font-family: Arial, sans-serif; 
                                padding: 20px; 
                                max-width: 800px;
                                margin: 0 auto;
                                background-color: #f5f5f5;
                            }
                        </style>
                    </head>
                    <body>${html}</body>
                    </html>
                `);
                newWindow.document.close();
                
                showStatus('模板样式预览已打开！', 'success');
            } catch (error) {
                console.error('预览失败:', error);
                showStatus('预览失败: ' + error.message, 'error');
            }
        }

        // 页面加载完成后初始化编辑器
        document.addEventListener('DOMContentLoaded', () => {
            initEditor();
        });
    </script>
</body>
</html>