<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlowEdit æ¨¡æ¿é¢„è§ˆ</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0;
            padding: 0;
            background: #f5f5f7;
        }
        
        .header {
            background: #fff;
            border-bottom: 1px solid #e5e5e7;
            padding: 20px;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header h1 {
            margin: 0;
            color: #1d1d1f;
            font-size: 24px;
            font-weight: 600;
        }
        
        .controls {
            margin-top: 15px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .control-group label {
            font-size: 14px;
            color: #424245;
            font-weight: 500;
        }
        
        select, button {
            padding: 8px 12px;
            border: 1px solid #d2d2d7;
            border-radius: 6px;
            font-size: 14px;
            background: #fff;
            cursor: pointer;
        }
        
        button {
            background: #007aff;
            color: white;
            border-color: #007aff;
            font-weight: 500;
        }
        
        button:hover {
            background: #0056cc;
        }
        
        button:disabled {
            background: #d2d2d7;
            cursor: not-allowed;
        }
        
        .preview-container {
            max-width: 800px;
            margin: 30px auto;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .template-info {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #e5e5e7;
        }
        
        .template-info h2 {
            margin: 0 0 10px 0;
            color: #1d1d1f;
            font-size: 20px;
        }
        
        .template-meta {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .template-meta div {
            font-size: 14px;
            color: #86868b;
        }
        
        .template-meta strong {
            color: #424245;
        }
        
        .content-area {
            padding: 30px;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            color: #86868b;
        }
        
        .error {
            background: #fee;
            border: 1px solid #fcc;
            padding: 20px;
            margin: 20px;
            border-radius: 8px;
            color: #c33;
        }
        
        .global-styles-config {
            background: #fff8e1;
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .global-styles-config h3 {
            margin: 0 0 10px 0;
            color: #f57c00;
            font-size: 16px;
        }
        
        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .checkbox-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
        }
        
        .checkbox-item label {
            font-size: 14px;
            color: #424245;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ¨ FlowEdit æ¨¡æ¿é¢„è§ˆ</h1>
        <div class="controls">
            <div class="control-group">
                <label for="templateSelect">æ¨¡æ¿:</label>
                <select id="templateSelect">
                    <option value="">åŠ è½½ä¸­...</option>
                </select>
            </div>
            <div class="control-group">
                <button id="renderButton" disabled>æ¸²æŸ“é¢„è§ˆ</button>
            </div>
            <div class="control-group">
                <button id="exportButton" disabled>å¯¼å‡ºHTML</button>
            </div>
        </div>
        
        <!-- å…¨å±€æ ·å¼é…ç½® -->
        <div class="global-styles-config">
            <h3>å…¨å±€æ ·å¼é…ç½®</h3>
            <div class="checkbox-group">
                <div class="checkbox-item">
                    <input type="checkbox" id="enableGlobalStyles" checked>
                    <label for="enableGlobalStyles">å¯ç”¨å…¨å±€æ ·å¼</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="enableContainer" checked>
                    <label for="enableContainer">å®¹å™¨æ ·å¼</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="enableReferences" checked>
                    <label for="enableReferences">å¼•ç”¨æ ·å¼</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="enableHeader" checked>
                    <label for="enableHeader">é¡µçœ‰æ ·å¼</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="enableFooter" checked>
                    <label for="enableFooter">é¡µè„šæ ·å¼</label>
                </div>
            </div>
        </div>
    </div>

    <div class="preview-container">
        <div class="template-info" id="templateInfo" style="display: none;">
            <h2 id="templateName">æ¨¡æ¿åç§°</h2>
            <div class="template-meta">
                <div><strong>æè¿°:</strong> <span id="templateDescription">-</span></div>
                <div><strong>ç±»åˆ«:</strong> <span id="templateCategory">-</span></div>
                <div><strong>ä½œè€…:</strong> <span id="templateAuthor">-</span></div>
                <div><strong>ç‰ˆæœ¬:</strong> <span id="templateVersion">-</span></div>
            </div>
        </div>
        
        <div class="content-area">
            <div class="loading" id="loading">
                è¯·é€‰æ‹©æ¨¡æ¿å¹¶ç‚¹å‡»æ¸²æŸ“é¢„è§ˆ
            </div>
            <div id="previewContent"></div>
            <div class="error" id="errorMessage" style="display: none;"></div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let templates = {};
        let testData = null;
        let currentTemplate = null;
        
        // DOM å…ƒç´ 
        const templateSelect = document.getElementById('templateSelect');
        const renderButton = document.getElementById('renderButton');
        const exportButton = document.getElementById('exportButton');
        const templateInfo = document.getElementById('templateInfo');
        const previewContent = document.getElementById('previewContent');
        const loading = document.getElementById('loading');
        const errorMessage = document.getElementById('errorMessage');
        
        // å…¨å±€æ ·å¼é…ç½®
        const globalStylesConfig = {
            enableGlobalStyles: document.getElementById('enableGlobalStyles'),
            enableContainer: document.getElementById('enableContainer'),
            enableReferences: document.getElementById('enableReferences'),
            enableHeader: document.getElementById('enableHeader'),
            enableFooter: document.getElementById('enableFooter')
        };

        // åˆå§‹åŒ–
        async function init() {
            try {
                await Promise.all([
                    loadTemplates(),
                    loadTestData()
                ]);
                
                setupEventListeners();
                renderButton.disabled = false;
                exportButton.disabled = false;
                
            } catch (error) {
                showError('åˆå§‹åŒ–å¤±è´¥: ' + error.message);
            }
        }

        // åŠ è½½æ‰€æœ‰æ¨¡æ¿
        async function loadTemplates() {
            try {
                const templateFiles = ['default.json', 'business-minimal.json', 'literary-green.json', 'warm-orange.json', 'abstract-illustration.json', 'diffused-gradient.json', 'ultra-bold-typography.json', 'handcraft-texture.json'];
                
                templateSelect.innerHTML = '<option value="">è¯·é€‰æ‹©æ¨¡æ¿...</option>';
                
                for (const file of templateFiles) {
                    try {
                        const response = await fetch(`./templates/${file}`);
                        if (response.ok) {
                            const template = await response.json();
                            console.log(`åŠ è½½æ¨¡æ¿: ${template.name}`);
                            
                            templates[template.id || file.replace('.json', '')] = template;
                            
                            const option = document.createElement('option');
                            option.value = template.id || file.replace('.json', '');
                            option.textContent = template.name || file.replace('.json', '');
                            templateSelect.appendChild(option);
                        }
                    } catch (err) {
                        console.warn(`åŠ è½½æ¨¡æ¿ ${file} å¤±è´¥:`, err);
                    }
                }
                
                if (Object.keys(templates).length === 0) {
                    throw new Error('æ²¡æœ‰æ‰¾åˆ°å¯ç”¨çš„æ¨¡æ¿æ–‡ä»¶');
                }
                
            } catch (error) {
                throw new Error('åŠ è½½æ¨¡æ¿å¤±è´¥: ' + error.message);
            }
        }

        // åŠ è½½æµ‹è¯•æ•°æ®
        async function loadTestData() {
            try {
                const response = await fetch('./data/test-data.json');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                testData = await response.json();
            } catch (error) {
                throw new Error('åŠ è½½æµ‹è¯•æ•°æ®å¤±è´¥: ' + error.message);
            }
        }

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            templateSelect.addEventListener('change', onTemplateChange);
            renderButton.addEventListener('click', renderPreview);
            exportButton.addEventListener('click', exportHTML);
            
            // å…¨å±€æ ·å¼é…ç½®å˜åŒ–æ—¶è‡ªåŠ¨é‡æ–°æ¸²æŸ“
            Object.values(globalStylesConfig).forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    if (currentTemplate) {
                        renderPreview();
                    }
                });
            });
        }

        // æ¨¡æ¿é€‰æ‹©å˜åŒ–
        function onTemplateChange() {
            const templateId = templateSelect.value;
            if (templateId && templates[templateId]) {
                currentTemplate = templates[templateId];
                console.log('é€‰æ‹©æ¨¡æ¿:', currentTemplate.name);
                updateTemplateInfo(currentTemplate);
                hideError();
            } else {
                currentTemplate = null;
                templateInfo.style.display = 'none';
            }
        }

        // æ›´æ–°æ¨¡æ¿ä¿¡æ¯æ˜¾ç¤º
        function updateTemplateInfo(template) {
            document.getElementById('templateName').textContent = template.name || 'æœªå‘½åæ¨¡æ¿';
            document.getElementById('templateDescription').textContent = template.description || 'æ— æè¿°';
            document.getElementById('templateCategory').textContent = template.category || 'æœªåˆ†ç±»';
            document.getElementById('templateAuthor').textContent = template.author || 'æœªçŸ¥';
            document.getElementById('templateVersion').textContent = template.version || '1.0.0';
            templateInfo.style.display = 'block';
        }

        // æ¸²æŸ“é¢„è§ˆ
        async function renderPreview() {
            if (!currentTemplate || !testData) {
                showError('è¯·å…ˆé€‰æ‹©æ¨¡æ¿');
                return;
            }

            console.log('æ¸²æŸ“é¢„è§ˆ:', currentTemplate.name);

            showLoading();
            hideError();

            try {
                // è·å–å…¨å±€æ ·å¼é…ç½®
                const globalStylesOptions = {
                    enabled: globalStylesConfig.enableGlobalStyles.checked,
                    container: globalStylesConfig.enableContainer.checked,
                    references: globalStylesConfig.enableReferences.checked,
                    header: globalStylesConfig.enableHeader.checked,
                    footer: globalStylesConfig.enableFooter.checked
                };

                // æ¨¡æ‹Ÿ parsers æ¨¡å—æ¸²æŸ“
                const renderedHTML = await mockRenderWithParsers(testData, currentTemplate, globalStylesOptions);
                
                previewContent.innerHTML = renderedHTML;
                hideLoading();
                
            } catch (error) {
                hideLoading();
                showError('æ¸²æŸ“å¤±è´¥: ' + error.message);
            }
        }

        // æ¨¡æ‹Ÿä½¿ç”¨ parsers æ¨¡å—æ¸²æŸ“ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼‰
        async function mockRenderWithParsers(data, template, globalOptions) {
            console.log('å¼€å§‹æ¸²æŸ“ï¼Œæ•°æ®å—æ•°é‡:', data.blocks.length, 'æ¨¡æ¿:', template.name);
            
            // è¿™é‡Œæ˜¯ç®€åŒ–çš„æ¸²æŸ“é€»è¾‘ï¼Œå®é™…åº”è¯¥è°ƒç”¨ parsers æ¨¡å—
            let html = '';
            
            // æ¸²æŸ“æ¯ä¸ªå—
            for (let i = 0; i < data.blocks.length; i++) {
                const block = data.blocks[i];
                const blockHtml = await renderBlock(block, template);
                html += blockHtml;
            }
            
            // åº”ç”¨å…¨å±€æ ·å¼
            if (globalOptions.enabled) {
                // åº”ç”¨å®¹å™¨æ ·å¼
                if (globalOptions.container && template.globalStyles?.container) {
                    html = template.globalStyles.container.replace('{{content}}', html);
                }
                
                // æ·»åŠ å¼•ç”¨æ ·å¼ï¼ˆå¦‚æœæœ‰å¼•ç”¨é“¾æ¥ï¼‰
                if (globalOptions.references && template.globalStyles?.references && html.includes('<a href=')) {
                    const referencesHTML = template.globalStyles.references.replace('{{links}}', 
                        '<div>[1]: http://ç¤ºä¾‹é“¾æ¥1<br>[2]: http://ç¤ºä¾‹é“¾æ¥2</div>');
                    html += referencesHTML;
                }
            }
            
            return html;
        }

        // æ¸²æŸ“å•ä¸ªå—ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼‰
        async function renderBlock(block, template) {
            console.log('æ¸²æŸ“å—:', block.type);
            
            if (!template || !template.blocks) {
                console.error('æ¨¡æ¿æˆ–æ¨¡æ¿å—ä¸å­˜åœ¨!', template);
                return `<div style="color: #999; font-style: italic;">æ¨¡æ¿é”™è¯¯: æ— æ³•æ‰¾åˆ°æ¨¡æ¿å—å®šä¹‰</div>`;
            }
            
            const blockTemplate = template.blocks[block.type];
            
            if (!blockTemplate) {
                console.warn('æœªæ‰¾åˆ°å—æ¨¡æ¿:', block.type, 'å¯ç”¨æ¨¡æ¿:', Object.keys(template.blocks));
                return `<div style="color: #999; font-style: italic;">ä¸æ”¯æŒçš„å—ç±»å‹: ${block.type}</div>`;
            }
            
            let html = '';
            
            switch (block.type) {
                case 'paragraph':
                    html = blockTemplate.replace('{{text}}', processInlineStyles(block.data.text || '', template));
                    break;
                    
                case 'header':
                    const headerTemplate = blockTemplate[`h${block.data.level}`] || blockTemplate.h1;
                    html = headerTemplate.replace('{{text}}', processInlineStyles(block.data.text || '', template));
                    break;
                    
                case 'quote':
                    html = blockTemplate.template.replace('{{text}}', processInlineStyles(block.data.text || '', template));
                    if (block.data.caption && blockTemplate.optional?.caption) {
                        html = html.replace('{{?caption}}', blockTemplate.optional.caption.replace('{{value}}', block.data.caption));
                    } else {
                        html = html.replace('{{?caption}}', '');
                    }
                    break;
                    
                case 'code':
                    html = blockTemplate.replace('{{code}}', escapeHtml(block.data.code || ''));
                    break;
                    
                case 'delimiter':
                    html = blockTemplate;
                    break;
                    
                case 'image':
                    html = blockTemplate.template
                        .replace('{{url}}', block.data.file?.url || '')
                        .replace('{{alt}}', block.data.caption || '');
                    if (block.data.caption && blockTemplate.optional?.caption) {
                        html = html.replace('{{?caption}}', blockTemplate.optional.caption.replace('{{value}}', block.data.caption));
                    } else {
                        html = html.replace('{{?caption}}', '');
                    }
                    break;
                    
                case 'list':
                    console.log('æ¸²æŸ“åˆ—è¡¨å—:', block);
                    const listStyle = block.data.style || 'unordered';
                    console.log('åˆ—è¡¨æ ·å¼:', listStyle);
                    
                    // ä½¿ç”¨ç»Ÿä¸€çš„å°å†™ 'list' é”®å
                    const listTemplates = template.blocks['list'];
                    console.log('æ‰¾åˆ°çš„åˆ—è¡¨æ¨¡æ¿:', listTemplates);
                    
                    const listTemplate = listTemplates?.[listStyle];
                    console.log('å½“å‰æ ·å¼çš„æ¨¡æ¿:', listTemplate);
                    
                    if (listTemplate) {
                        console.log('å¼€å§‹å¤„ç†åˆ—è¡¨é¡¹:', block.data.items);
                        const items = block.data.items.map((item, index) => {
                            console.log(`å¤„ç†ç¬¬${index}é¡¹:`, item);
                            let itemHtml = listTemplate.item.replace('{{content}}', processInlineStyles(item.content || '', template));
                            
                            // å¤„ç†æœ‰åºåˆ—è¡¨çš„ç´¢å¼•
                            if (listStyle === 'ordered') {
                                itemHtml = itemHtml.replace('{{index}}', (index + 1).toString());
                            }
                            
                            // å¤„ç† checklist
                            if (listStyle === 'checklist') {
                                const checkbox = item.meta?.checked ? listTemplate.checked : listTemplate.unchecked;
                                itemHtml = itemHtml.replace('{{checkbox}}', checkbox);
                            }
                            
                            console.log(`ç¬¬${index}é¡¹ç”Ÿæˆçš„HTML:`, itemHtml);
                            return itemHtml;
                        }).join('');
                        
                        html = listTemplate.wrapper.replace('{{items}}', items).replace('{{class}}', '');
                        console.log('æœ€ç»ˆåˆ—è¡¨HTML:', html);
                    } else {
                        console.error('æœªæ‰¾åˆ°åŒ¹é…çš„åˆ—è¡¨æ¨¡æ¿:', listStyle, 'å¯ç”¨æ¨¡æ¿:', Object.keys(listTemplates || {}));
                        html = `<div style="color: #999; font-style: italic;">æœªæ‰¾åˆ°åˆ—è¡¨æ¨¡æ¿: ${listStyle}</div>`;
                    }
                    break;
                    
                case 'raw':
                    html = blockTemplate.replace('{{html}}', block.data.html || '');
                    break;
                    
                default:
                    html = `<div style="color: #999;">æœªçŸ¥å—ç±»å‹: ${block.type}</div>`;
            }
            
            console.log('å—æ¸²æŸ“å®Œæˆ:', block.type, 'è¾“å‡ºHTML:', html);
            return html;
        }

        // å¤„ç†å†…è”æ ·å¼ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼‰
        function processInlineStyles(text, template) {
            if (!text) return '';
            
            const inlineStyles = template.inlineStyles || {};
            
            // ç®€å•çš„å†…è”æ ·å¼å¤„ç†
            text = text.replace(/<b>(.*?)<\/b>/g, (match, content) => {
                const style = inlineStyles.b || inlineStyles.strong || '';
                return style ? `<span style="${style}">${content}</span>` : `<b>${content}</b>`;
            });
            
            text = text.replace(/<i>(.*?)<\/i>/g, (match, content) => {
                const style = inlineStyles.i || inlineStyles.em || '';
                return style ? `<span style="${style}">${content}</span>` : `<i>${content}</i>`;
            });
            
            text = text.replace(/<mark[^>]*>(.*?)<\/mark>/g, (match, content) => {
                const style = inlineStyles.mark || '';
                return style ? `<span style="${style}">${content}</span>` : `<mark>${content}</mark>`;
            });
            
            text = text.replace(/<code[^>]*>(.*?)<\/code>/g, (match, content) => {
                const style = inlineStyles.code || '';
                return style ? `<span style="${style}">${content}</span>` : `<code>${content}</code>`;
            });
            
            text = text.replace(/<u[^>]*>(.*?)<\/u>/g, (match, content) => {
                const style = inlineStyles.u || '';
                return style ? `<span style="${style}">${content}</span>` : `<u>${content}</u>`;
            });
            
            return text;
        }

        // HTMLè½¬ä¹‰
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // å¯¼å‡ºHTML
        function exportHTML() {
            if (!previewContent.innerHTML.trim()) {
                showError('è¯·å…ˆæ¸²æŸ“é¢„è§ˆå†…å®¹');
                return;
            }
            
            const fullHTML = `<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${currentTemplate?.name || 'æ¨¡æ¿é¢„è§ˆ'}</title>
</head>
<body>
    ${previewContent.innerHTML}
</body>
</html>`;
            
            const blob = new Blob([fullHTML], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${currentTemplate?.id || 'template'}-preview.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        function showLoading() {
            loading.style.display = 'block';
            previewContent.innerHTML = '';
        }

        // éšè—åŠ è½½çŠ¶æ€
        function hideLoading() {
            loading.style.display = 'none';
        }

        // æ˜¾ç¤ºé”™è¯¯
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
        }

        // éšè—é”™è¯¯
        function hideError() {
            errorMessage.style.display = 'none';
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>