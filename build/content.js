!function(){"use strict";function t(t,e){if(!e)return;const n=e.getRangeAt(0);n.deleteContents(),n.insertNode(t),e.removeAllRanges()}function e(t,e="wx-custom-css"){const n=document.getElementById(e);if(n&&n.remove(),!t)return;const s=document.createElement("style");s.id=e,s.textContent=t,document.head.appendChild(s)}function n(t,e){try{return localStorage.setItem(t,JSON.stringify(e)),console.log(`数据已保存到本地存储: ${t}`),!0}catch(e){return console.error(`保存数据到本地存储失败: ${t}`,e),!1}}function s(t,e=null){try{const n=localStorage.getItem(t);return n?JSON.parse(n):e}catch(n){return console.error(`从本地存储加载数据失败: ${t}`,n),e}}const i="wx-floating-toolbar-settings",o="wx-floating-toolbar-enabled";class l{constructor(t,e){this.editor=t,this.toolbarElement=null,this.isVisible=!1,this.currentSelection=null,this.styleSettings=e,this.selectionTimeout=null,this.isEnabled=!0,this.create=this.create.bind(this),this.handleSelectionChange=this.handleSelectionChange.bind(this),this.show=this.show.bind(this),this.hide=this.hide.bind(this),this.applyHeadingStyle=this.applyHeadingStyle.bind(this),this.applyCodeStyle=this.applyCodeStyle.bind(this),this.enable=this.enable.bind(this),this.disable=this.disable.bind(this)}create(){this.toolbarElement=document.createElement("div"),this.toolbarElement.className="wx-floating-toolbar",this.toolbarElement.style.display="none";[{name:"H1",title:"一级标题",action:()=>this.applyHeadingStyle(1)},{name:"H2",title:"二级标题",action:()=>this.applyHeadingStyle(2)},{name:"H3",title:"三级标题",action:()=>this.applyHeadingStyle(3)},{name:"H4",title:"四级标题",action:()=>this.applyHeadingStyle(4)},{name:"Code",title:"行内代码",action:this.applyCodeStyle}].forEach((t=>{const e=document.createElement("button");e.className="wx-toolbar-button",e.textContent=t.name,e.title=t.title,e.addEventListener("click",(e=>{e.preventDefault(),e.stopPropagation(),t.action()})),this.toolbarElement.appendChild(e)})),document.body.appendChild(this.toolbarElement),document.addEventListener("selectionchange",this.handleSelectionChange),document.addEventListener("click",(t=>{this.toolbarElement&&!this.toolbarElement.contains(t.target)&&""===window.getSelection().toString().trim()&&this.hide()})),console.log("浮动工具栏已创建")}handleSelectionChange(){this.isEnabled&&(clearTimeout(this.selectionTimeout),this.selectionTimeout=setTimeout((()=>{const t=window.getSelection();if(!t||t.isCollapsed||""===t.toString().trim())return void this.hide();let e=!1,n=t.anchorNode;for(;n&&!e;)n===this.editor&&(e=!0),n=n.parentNode;e?(this.currentSelection=t,this.show()):this.hide()}),300))}show(){if(!this.currentSelection||!this.toolbarElement)return;const t=this.currentSelection.getRangeAt(0).getBoundingClientRect();let e=t.left+t.width/2-140,n=t.top-40-10;const s=window.innerWidth||document.documentElement.clientWidth;window.innerHeight||document.documentElement.clientHeight,e=Math.max(10,Math.min(e,s-280-10)),n<10?(n=t.bottom+10,this.toolbarElement.classList.add("position-bottom")):this.toolbarElement.classList.remove("position-bottom"),this.toolbarElement.style.position="fixed",this.toolbarElement.style.left=`${e}px`,this.toolbarElement.style.top=`${n}px`,this.toolbarElement.style.display="flex",this.isVisible=!0}hide(){this.toolbarElement&&(this.toolbarElement.style.display="none",this.isVisible=!1)}applyHeadingStyle(e){if(!this.currentSelection)return;const n=this.currentSelection.toString();if(!n.trim())return;const s=document.createElement("span");s.setAttribute("textstyle","");const i=`h${e}`,o=this.styleSettings[i];o&&Object.keys(o).forEach((t=>{t.replace(/([A-Z])/g,"-$1").toLowerCase(),s.style[t]=o[t]})),s.textContent=n;const l=document.createElement("span");l.setAttribute("leaf",""),l.appendChild(s),t(l,this.currentSelection),this.hide()}applyCodeStyle(){if(!this.currentSelection)return;const e=this.currentSelection.toString();if(!e.trim())return;const n=document.createElement("span");n.setAttribute("textstyle","");const s=this.styleSettings.code;s&&Object.keys(s).forEach((t=>{t.replace(/([A-Z])/g,"-$1").toLowerCase(),n.style[t]=s[t]})),n.textContent=e;const i=document.createElement("span");i.setAttribute("leaf",""),i.appendChild(n),t(i,this.currentSelection),this.hide()}updateSettings(t){this.styleSettings=t}enable(){this.isEnabled||(this.isEnabled=!0,console.log("浮动工具栏已启用"),document.addEventListener("selectionchange",this.handleSelectionChange))}disable(){this.isEnabled&&(this.isEnabled=!1,console.log("浮动工具栏已禁用"),document.removeEventListener("selectionchange",this.handleSelectionChange),this.hide())}destroy(){this.toolbarElement&&(document.removeEventListener("selectionchange",this.handleSelectionChange),this.toolbarElement.remove(),this.toolbarElement=null)}}class a{constructor(t){this.panel=null,this.isVisible=!1,this.styleSettings=t||{h1:{fontSize:"30px",fontWeight:"bold"},h2:{fontSize:"24px",fontWeight:"bold"},h3:{fontSize:"20px",fontWeight:"bold"},h4:{fontSize:"16px",fontWeight:"bold"},code:{fontFamily:'SFMono-Regular, Consolas, "Liberation Mono", Menlo, monospace',backgroundColor:"rgba(175, 184, 193, 0.2)",padding:"0.2em 0.4em",borderRadius:"3px",fontSize:"85%"},custom:{css:""}},this.loadSettings(),this.show=this.show.bind(this),this.hide=this.hide.bind(this),this.toggle=this.toggle.bind(this),this.createPanel=this.createPanel.bind(this),this.updateSettings=this.updateSettings.bind(this),this.resetSettings=this.resetSettings.bind(this),this.addHeadingSettings=this.addHeadingSettings.bind(this),this.addCodeSettings=this.addCodeSettings.bind(this),this.addCustomCssSettings=this.addCustomCssSettings.bind(this),this.previewCustomCss=this.previewCustomCss.bind(this)}loadSettings(){try{const t=s(i);t&&(this.styleSettings={h1:{...this.styleSettings.h1,...t.h1},h2:{...this.styleSettings.h2,...t.h2},h3:{...this.styleSettings.h3,...t.h3},h4:{...this.styleSettings.h4,...t.h4},code:{...this.styleSettings.code,...t.code},custom:{css:""}},t.custom&&void 0!==t.custom.css&&(this.styleSettings.custom.css=t.custom.css),console.log("从本地存储加载样式设置"),this.applyCustomCss(this.styleSettings.custom.css))}catch(t){console.error("加载样式设置失败:",t)}}saveSettings(){n(i,this.styleSettings)}applyCustomCss(t){e(t,"wx-custom-css")}show(){this.panel||this.createPanel(),this.panel.style.display="block",this.isVisible=!0}hide(){this.panel&&(this.panel.style.display="none",this.isVisible=!1)}toggle(){this.isVisible?this.hide():this.show()}createPanel(){this.panel=document.createElement("div"),this.panel.className="wx-style-settings-panel";const t=document.createElement("h2");t.textContent="样式设置",this.panel.appendChild(t);const e=document.createElement("form");e.className="wx-settings-form";const n=document.createElement("div");n.className="wx-settings-tabs";const s=document.createElement("button");s.textContent="基本设置",s.className="wx-settings-tab-button wx-settings-tab-active",s.type="button";const i=document.createElement("button");i.textContent="自定义CSS",i.className="wx-settings-tab-button",i.type="button",n.appendChild(s),n.appendChild(i),e.appendChild(n);const o=document.createElement("div");o.className="wx-settings-tab-panel",o.style.display="block",this.addHeadingSettings(o,1),this.addHeadingSettings(o,2),this.addHeadingSettings(o,3),this.addHeadingSettings(o,4),this.addCodeSettings(o);const l=document.createElement("div");l.className="wx-settings-tab-panel",l.style.display="none",this.addCustomCssSettings(l),e.appendChild(o),e.appendChild(l),s.addEventListener("click",(()=>{s.className="wx-settings-tab-button wx-settings-tab-active",i.className="wx-settings-tab-button",o.style.display="block",l.style.display="none"})),i.addEventListener("click",(()=>{s.className="wx-settings-tab-button",i.className="wx-settings-tab-button wx-settings-tab-active",o.style.display="none",l.style.display="block"}));const a=document.createElement("div");a.className="wx-settings-button-group";const c=document.createElement("button");c.textContent="保存设置",c.className="wx-settings-save-button",c.addEventListener("click",(t=>{t.preventDefault(),this.updateSettings(e),this.hide()})),a.appendChild(c);const d=document.createElement("button");d.textContent="取消",d.className="wx-settings-cancel-button",d.addEventListener("click",(t=>{t.preventDefault(),this.hide()})),a.appendChild(d);const h=document.createElement("button");h.textContent="重置默认",h.className="wx-settings-reset-button",h.addEventListener("click",(t=>{t.preventDefault(),this.resetSettings(e)})),a.appendChild(h),e.appendChild(a),this.panel.appendChild(e);const r=document.createElement("button");r.className="wx-settings-close-button",r.innerHTML="&times;",r.addEventListener("click",(()=>{this.hide()})),this.panel.appendChild(r),document.body.appendChild(this.panel)}addHeadingSettings(t,e){const n=document.createElement("div");n.className="wx-settings-section";const s=document.createElement("h3");s.textContent=`H${e} 标题样式`,n.appendChild(s);const i=document.createElement("div");i.className="wx-settings-group";const o=document.createElement("label");o.textContent="字体大小:",i.appendChild(o);const l=document.createElement("input");l.type="text",l.name=`h${e}-font-size`,l.value=this.styleSettings[`h${e}`].fontSize||"",l.placeholder="例如: 24px",i.appendChild(l),n.appendChild(i);const a=document.createElement("div");a.className="wx-settings-group";const c=document.createElement("label");c.textContent="字体粗细:",a.appendChild(c);const d=document.createElement("select");d.name=`h${e}-font-weight`;[{value:"normal",text:"正常"},{value:"bold",text:"粗体"},{value:"100",text:"100"},{value:"200",text:"200"},{value:"300",text:"300"},{value:"400",text:"400"},{value:"500",text:"500"},{value:"600",text:"600"},{value:"700",text:"700"},{value:"800",text:"800"},{value:"900",text:"900"}].forEach((t=>{const n=document.createElement("option");n.value=t.value,n.textContent=t.text,n.selected=this.styleSettings[`h${e}`].fontWeight===t.value,d.appendChild(n)})),a.appendChild(d),n.appendChild(a),t.appendChild(n)}addCodeSettings(t){const e=document.createElement("div");e.className="wx-settings-section";const n=document.createElement("h3");n.textContent="行内代码样式",e.appendChild(n);const s=document.createElement("div");s.className="wx-settings-group";const i=document.createElement("label");i.textContent="字体:",s.appendChild(i);const o=document.createElement("input");o.type="text",o.name="code-font-family",o.value=this.styleSettings.code.fontFamily||"",o.placeholder="例如: monospace",s.appendChild(o),e.appendChild(s);const l=document.createElement("div");l.className="wx-settings-group";const a=document.createElement("label");a.textContent="背景色:",l.appendChild(a);const c=document.createElement("input");c.type="text",c.name="code-background-color",c.value=this.styleSettings.code.backgroundColor||"",c.placeholder="例如: #f0f0f0",l.appendChild(c),e.appendChild(l);const d=document.createElement("div");d.className="wx-settings-group";const h=document.createElement("label");h.textContent="内边距:",d.appendChild(h);const r=document.createElement("input");r.type="text",r.name="code-padding",r.value=this.styleSettings.code.padding||"",r.placeholder="例如: 0.2em 0.4em",d.appendChild(r),e.appendChild(d);const u=document.createElement("div");u.className="wx-settings-group";const p=document.createElement("label");p.textContent="圆角:",u.appendChild(p);const m=document.createElement("input");m.type="text",m.name="code-border-radius",m.value=this.styleSettings.code.borderRadius||"",m.placeholder="例如: 3px",u.appendChild(m),e.appendChild(u);const g=document.createElement("div");g.className="wx-settings-group";const b=document.createElement("label");b.textContent="字体大小:",g.appendChild(b);const y=document.createElement("input");y.type="text",y.name="code-font-size",y.value=this.styleSettings.code.fontSize||"",y.placeholder="例如: 85%",g.appendChild(y),e.appendChild(g),t.appendChild(e)}addCustomCssSettings(t){const e=document.createElement("div");e.className="wx-settings-section wx-custom-css-section";const n=document.createElement("h3");n.textContent="自定义CSS样式",e.appendChild(n);const s=document.createElement("p");s.className="wx-settings-description",s.textContent="在下面输入自定义CSS样式，这些样式将应用到微信编辑器中。",e.appendChild(s);const i=document.createElement("textarea");i.className="wx-custom-css-textarea",i.name="custom-css",i.rows=15,this.styleSettings&&this.styleSettings.custom&&void 0!==this.styleSettings.custom.css?i.value=this.styleSettings.custom.css:(i.value="",this.styleSettings.custom||(this.styleSettings.custom={css:""})),i.placeholder="/* 示例:\n.ProseMirror h1 {\n  color: #ff5722;\n}\n\n.ProseMirror code {\n  background-color: #f0f0f0;\n  padding: 2px 4px;\n  border-radius: 3px;\n}\n*/",e.appendChild(i);const o=document.createElement("button");o.textContent="预览样式",o.className="wx-settings-apply-button",o.type="button",o.addEventListener("click",(()=>{this.previewCustomCss(i.value)})),e.appendChild(o),t.appendChild(e)}previewCustomCss(t){this.applyCustomCss(t)}updateSettings(t){for(let e=1;e<=4;e++){const n=t.querySelector(`input[name="h${e}-font-size"]`).value,s=t.querySelector(`select[name="h${e}-font-weight"]`).value;this.styleSettings[`h${e}`]={...this.styleSettings[`h${e}`],fontSize:n,fontWeight:s}}const e=t.querySelector('input[name="code-font-family"]').value,n=t.querySelector('input[name="code-background-color"]').value,s=t.querySelector('input[name="code-padding"]').value,i=t.querySelector('input[name="code-border-radius"]').value,o=t.querySelector('input[name="code-font-size"]').value;this.styleSettings.code={...this.styleSettings.code,fontFamily:e,backgroundColor:n,padding:s,borderRadius:i,fontSize:o};const l=t.querySelector('textarea[name="custom-css"]').value;this.styleSettings.custom={...this.styleSettings.custom,css:l},this.applyCustomCss(l),this.saveSettings(),console.log("样式设置已更新")}resetSettings(t){this.styleSettings={h1:{fontSize:"30px",fontWeight:"bold"},h2:{fontSize:"24px",fontWeight:"bold"},h3:{fontSize:"20px",fontWeight:"bold"},h4:{fontSize:"16px",fontWeight:"bold"},code:{fontFamily:'SFMono-Regular, Consolas, "Liberation Mono", Menlo, monospace',backgroundColor:"rgba(175, 184, 193, 0.2)",padding:"0.2em 0.4em",borderRadius:"3px",fontSize:"85%"},custom:{css:""}};for(let e=1;e<=4;e++){t.querySelector(`input[name="h${e}-font-size"]`).value=this.styleSettings[`h${e}`].fontSize;const n=t.querySelector(`select[name="h${e}-font-weight"]`);for(let t=0;t<n.options.length;t++)if(n.options[t].value===this.styleSettings[`h${e}`].fontWeight){n.selectedIndex=t;break}}t.querySelector('input[name="code-font-family"]').value=this.styleSettings.code.fontFamily,t.querySelector('input[name="code-background-color"]').value=this.styleSettings.code.backgroundColor,t.querySelector('input[name="code-padding"]').value=this.styleSettings.code.padding,t.querySelector('input[name="code-border-radius"]').value=this.styleSettings.code.borderRadius,t.querySelector('input[name="code-font-size"]').value=this.styleSettings.code.fontSize,t.querySelector('textarea[name="custom-css"]').value=this.styleSettings.custom.css,this.applyCustomCss(this.styleSettings.custom.css),this.saveSettings(),console.log("样式设置已重置为默认值")}getSettings(){return this.styleSettings}}class c{constructor(t){this.container=null,this.button=null,this.isDragging=!1,this.dragEndTime=0,this.onClick=t,this.handleMouseDown=this.handleMouseDown.bind(this),this.handleMouseMove=this.handleMouseMove.bind(this),this.handleMouseUp=this.handleMouseUp.bind(this),this.handleResize=this.handleResize.bind(this),this.handleClick=this.handleClick.bind(this)}create(){const t=document.querySelector(".wx-floating-settings-container");if(t)return console.log("悬浮按钮已存在，不重复创建"),t;try{this.container=document.createElement("div"),this.container.className="wx-floating-settings-container",this.container.style.cssText="\n        position: fixed;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        z-index: 9999;\n        background-color: #fff;\n        border-radius: 50%;\n        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);\n        width: 50px;\n        height: 50px;\n        cursor: move;\n        user-select: none;\n        touch-action: none;\n        transition: transform 0.2s, box-shadow 0.2s;\n        right: 20px;\n        top: 50%;\n      ",this.button=document.createElement("button"),this.button.className="wx-floating-settings-button",this.button.style.cssText="\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        background-color: transparent;\n        color: #4C4D4E;\n        border: none;\n        width: 100%;\n        height: 100%;\n        padding: 0;\n        cursor: pointer;\n        border-radius: 50%;\n      ";const t=function(t,e="#4C4D4E",n=24,s=24){const i=document.createElementNS("http://www.w3.org/2000/svg","svg");i.setAttribute("xmlns","http://www.w3.org/2000/svg"),i.setAttribute("width",n.toString()),i.setAttribute("height",s.toString()),i.setAttribute("viewBox","0 0 24 24");const o=document.createElementNS("http://www.w3.org/2000/svg","path");return o.setAttribute("fill",e),o.setAttribute("fill-rule","evenodd"),o.setAttribute("d",t),i.appendChild(o),i}("M19.502 12c0 .34-.03.66-.07.98l2.11 1.65c.19.15.24.42.12.64l-2 3.46c-.09.16-.26.25-.43.25-.06 0-.12-.01-.18-.03l-2.49-1c-.52.39-1.08.73-1.69.98l-.38 2.65c-.03.24-.24.42-.49.42h-4c-.25 0-.46-.18-.49-.42l-.38-2.65c-.61-.25-1.17-.58-1.69-.98l-2.49 1c-.06.02-.12.03-.18.03-.17 0-.34-.09-.43-.25l-2-3.46c-.12-.22-.07-.49.12-.64l2.11-1.65c-.04-.32-.07-.65-.07-.98s.03-.66.07-.98l-2.11-1.65c-.19-.15-.24-.42-.12-.64l2-3.46c.09-.16.26-.25.43-.25.06 0 .12.01.18.03l2.49 1c.52-.39 1.08-.73 1.69-.98l.38-2.65c.03-.24.24-.42.49-.42h4c.25 0 .46.18.49.42l.38 2.65c.61.25 1.17.58 1.69.98l2.49-1c.06-.02.12-.03.18-.03.17 0 .34.09.43.25l2 3.46c.12.22.07.49-.12.64l-2.11 1.65c.04.32.07.64.07.98zm-8 2c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2z");return this.button.appendChild(t),this.button.title="样式设置 (可拖动)",this.container.appendChild(this.button),document.body?(document.body.appendChild(this.container),console.log("已将按钮添加到body"),this.setInitialPosition(),this.addEventListeners(),console.log("可拖动的悬浮设置按钮已创建"),this.container):(console.error("document.body不存在，无法添加按钮"),null)}catch(t){return console.error("创建悬浮按钮时出错:",t),null}}setInitialPosition(){const t=window.innerWidth-this.container.offsetWidth-20,e=window.innerHeight/2-this.container.offsetHeight/2;this.container.style.left=`${t}px`,this.container.style.top=`${e}px`}addEventListeners(){this.button.addEventListener("click",this.handleClick),this.container.addEventListener("mousedown",this.handleMouseDown),document.addEventListener("mousemove",this.handleMouseMove),document.addEventListener("mouseup",this.handleMouseUp),document.addEventListener("mouseleave",this.handleMouseUp),window.addEventListener("resize",this.handleResize)}removeEventListeners(){this.button.removeEventListener("click",this.handleClick),this.container.removeEventListener("mousedown",this.handleMouseDown),document.removeEventListener("mousemove",this.handleMouseMove),document.removeEventListener("mouseup",this.handleMouseUp),document.removeEventListener("mouseleave",this.handleMouseUp),window.removeEventListener("resize",this.handleResize)}handleClick(t){(!this.isDragging||this.isDragging&&Date.now()-this.dragEndTime>200)&&(t.preventDefault(),t.stopPropagation(),"function"==typeof this.onClick&&this.onClick())}handleMouseDown(t){if(0!==t.button)return;this.isDragging=!0;const e=this.container.getBoundingClientRect();this.offsetX=t.clientX-e.left,this.offsetY=t.clientY-e.top,this.container.classList.add("wx-dragging"),t.preventDefault()}handleMouseMove(t){if(!this.isDragging)return;const e=t.clientX-this.offsetX,n=t.clientY-this.offsetY,s=window.innerWidth-this.container.offsetWidth,i=window.innerHeight-this.container.offsetHeight;this.container.style.left=`${Math.max(0,Math.min(e,s))}px`,this.container.style.top=`${Math.max(0,Math.min(n,i))}px`}handleMouseUp(){if(!this.isDragging)return;this.isDragging=!1,this.dragEndTime=Date.now(),this.container.classList.remove("wx-dragging");const t=this.container.getBoundingClientRect();let e;e=t.left+t.width/2<window.innerWidth/2?20:window.innerWidth-t.width-20,this.container.style.transition="left 0.3s ease-out",this.container.style.left=`${e}px`,setTimeout((()=>{this.container.style.transition=""}),300)}handleResize(){const t=this.container.getBoundingClientRect();t.left>window.innerWidth/2&&(this.container.style.left=window.innerWidth-t.width-20+"px");const e=window.innerHeight-t.height;t.top>e&&(this.container.style.top=`${e}px`)}destroy(){this.container&&(this.removeEventListeners(),this.container.remove(),this.container=null,this.button=null)}}const d="wx-code-block-settings",h={enabled:!0,theme:"github-dark",showMacButtons:!0,fontSize:"11.34px",fontFamily:'"Fira Code", Menlo, "Operator Mono", Consolas, Monaco, monospace',customCSS:"",languages:{python:!0,javascript:!0,html:!0,css:!0}};class r{constructor(t){this.editor=t,this.settings=h,this.observer=null,this.init=this.init.bind(this),this.loadSettings=this.loadSettings.bind(this),this.saveSettings=this.saveSettings.bind(this),this.enhanceCodeBlocks=this.enhanceCodeBlocks.bind(this),this.handleCodeButtonClick=this.handleCodeButtonClick.bind(this),this.observeEditorChanges=this.observeEditorChanges.bind(this),this.updateSettings=this.updateSettings.bind(this)}init(){console.log("初始化代码块增强功能"),this.loadSettings(),this.settings.enabled?(this.listenForCodeButton(),this.observeEditorChanges(),this.enhanceCodeBlocks()):console.log("代码块增强功能已禁用")}loadSettings(){const t=s(d);t?(this.settings={...h,...t},console.log("已加载代码块增强设置:",this.settings)):console.log("使用默认代码块增强设置")}saveSettings(){n(d,this.settings),console.log("已保存代码块增强设置")}updateSettings(t){this.settings={...this.settings,...t},this.saveSettings(),this.enhanceCodeBlocks()}listenForCodeButton(){const t=document.querySelector(".edui-for-insertcode");t?(console.log("找到代码块插入按钮"),t.addEventListener("click",this.handleCodeButtonClick)):console.log("未找到代码块插入按钮")}handleCodeButtonClick(){console.log("代码块插入按钮被点击"),setTimeout(this.enhanceCodeBlocks,500)}observeEditorChanges(){this.editor&&(this.observer=new MutationObserver((t=>{this._debounceTimer&&clearTimeout(this._debounceTimer),this._debounceTimer=setTimeout((()=>{let e=!1;for(const n of t)if((!n.target.classList||!n.target.classList.contains("wx-enhanced")&&!n.target.closest(".wx-enhanced"))&&"childList"===n.type&&n.addedNodes.length){if(Array.from(n.addedNodes).filter((t=>t.nodeType===Node.ELEMENT_NODE)).filter((t=>(!t.classList||!t.classList.contains("wx-enhanced")&&!t.classList.contains("wx-enhanced-code-block"))&&(t.matches?.(".code-snippet:not(.wx-enhanced)")||t.querySelector?.(".code-snippet:not(.wx-enhanced)")||t.matches?.(".code-snippet__js:not(.wx-enhanced)")||t.querySelector?.(".code-snippet__js:not(.wx-enhanced)")))).length){e=!0;break}}e&&(console.log("检测到新的代码块添加"),this.enhanceCodeBlocks())}),300)})),this.observer.observe(this.editor,{childList:!0,subtree:!0}),console.log("已开始观察编辑器变化"))}enhanceCodeBlocks(){if(!this._isEnhancing){this._isEnhancing=!0;try{console.log("开始增强代码块");const t=document.querySelectorAll(".code-snippet__js:not(.wx-enhanced), .code-snippet:not(.wx-enhanced)");if(console.log(`找到 ${t.length} 个未增强的代码块`),0===t.length)return void(this._isEnhancing=!1);t.forEach(((t,e)=>{if(t.classList.contains("wx-enhanced")||"true"===t.dataset.wxEnhanced)return;console.log(`增强代码块 #${e+1}`),t.classList.add("wx-enhanced"),t.dataset.wxEnhanced="true",t.classList.add("wx-enhanced-code-block");const n=t.querySelector("code");if(!n)return;const s=n.textContent||"";if(this.settings.showMacButtons&&!t.querySelector(".wx-code-mac-buttons")){const e=document.createElement("span");e.className="wx-code-mac-buttons",e.innerHTML='<svg viewBox="0 0 450 130" height="13px" width="45px" y="0px" x="0px" version="1.1" xmlns="http://www.w3.org/2000/svg"><ellipse fill="rgb(237,108,96)" stroke-width="2" stroke="rgb(220,60,54)" ry="52" rx="50" cy="65" cx="50"></ellipse><ellipse fill="rgb(247,193,81)" stroke-width="2" stroke="rgb(218,151,33)" ry="52" rx="50" cy="65" cx="225"></ellipse><ellipse fill="rgb(100,200,86)" stroke-width="2" stroke="rgb(27,161,37)" ry="52" rx="50" cy="65" cx="400"></ellipse></svg>',t.insertBefore(e,t.firstChild)}n.style.fontFamily=this.settings.fontFamily,n.style.fontSize=this.settings.fontSize,n.classList.add("wx-code-content");const i=this.detectLanguage(s);if(i&&(n.classList.add(`language-${i}`),t.dataset.language=i),!t.querySelector(".wx-original-content")){const e=document.createElement("div");e.className="wx-original-content",e.style.display="none",e.textContent=s,t.appendChild(e)}if(s.trim()&&i&&this.settings.languages[i]){n.dataset.originalContent=s;const e=document.createElement("div");e.className="wx-highlight-container",e.style.display="none",t.appendChild(e),this.observer&&this.observer.disconnect();const o=this.highlightCode(s,i);e.innerHTML=o,this.observer&&this.editor&&this.observer.observe(this.editor,{childList:!0,subtree:!0})}})),this.settings.customCSS&&e(this.settings.customCSS,"wx-custom-code-styles"),console.log("代码块增强完成")}catch(t){console.error("代码块增强过程中出错:",t)}finally{this._isEnhancing=!1}}}detectLanguage(t){const e=t.trim();return this.settings.languages.python&&/\b(import|from|def|class|if|else|elif|for|while|return|try|except)\b/.test(e)?"python":this.settings.languages.javascript&&/\b(function|const|let|var|if|else|for|while|return|try|catch|class|import|export)\b/.test(e)?"javascript":this.settings.languages.html&&/(<html|<body|<div|<span|<p|<h1|<a)\b/.test(e)?"html":this.settings.languages.css&&/({|}|;|\b(margin|padding|color|background|font-size|width|height):\s)/.test(e)?"css":null}highlightCode(t,e){let n=t;switch(e){case"python":n=n.replace(/\b(import|from|def|class|if|else|elif|for|while|return|try|except|with|as|in|is|not|and|or)\b/g,'<span class="wx-code-keyword">$1</span>'),n=n.replace(/(".*?"|'.*?')/g,'<span class="wx-code-string">$1</span>'),n=n.replace(/(#.*)$/gm,'<span class="wx-code-comment">$1</span>');break;case"javascript":n=n.replace(/\b(function|const|let|var|if|else|for|while|return|try|catch|class|import|export|new|this|typeof|instanceof)\b/g,'<span class="wx-code-keyword">$1</span>'),n=n.replace(/(".*?"|'.*?'|`.*?`)/g,'<span class="wx-code-string">$1</span>'),n=n.replace(/(\/\/.*|\/\*[\s\S]*?\*\/)/g,'<span class="wx-code-comment">$1</span>');break;case"html":n=n.replace(/(&lt;[^&]*&gt;|<[^<>]*>)/g,'<span class="wx-code-keyword">$1</span>'),n=n.replace(/(\s[a-zA-Z-]+)=["']([^"']*)["']/g,'$1=<span class="wx-code-string">"$2"</span>');break;case"css":n=n.replace(/([.#][a-zA-Z0-9_-]+|[a-zA-Z]+)(?=\s*{)/g,'<span class="wx-code-keyword">$1</span>'),n=n.replace(/([a-zA-Z-]+)(?=\s*:)/g,'<span class="wx-code-keyword">$1</span>'),n=n.replace(/:\s*([^;{}]+)/g,': <span class="wx-code-string">$1</span>')}return n}destroy(){this.observer&&this.observer.disconnect();const t=document.querySelector(".edui-for-insertcode");t&&t.removeEventListener("click",this.handleCodeButtonClick)}}class u{constructor(t){this.enhancer=t,this.panelElement=null,this.create=this.create.bind(this),this.show=this.show.bind(this),this.hide=this.hide.bind(this),this.handleSave=this.handleSave.bind(this),this.handleCancel=this.handleCancel.bind(this)}create(){if(this.panelElement)return this.panelElement;this.panelElement=document.createElement("div"),this.panelElement.className="wx-code-settings-panel",this.panelElement.style.display="none";const t=document.createElement("h2");t.textContent="代码块样式设置",this.panelElement.appendChild(t);const e=document.createElement("form");e.className="wx-code-settings-form";const n=this.createSettingGroup("启用代码块增强"),s=document.createElement("input");s.type="checkbox",s.id="wx-code-enabled",s.checked=this.enhancer.settings.enabled;const i=document.createElement("label");i.htmlFor="wx-code-enabled",i.textContent="启用代码块样式增强",n.appendChild(s),n.appendChild(i),e.appendChild(n);const o=this.createSettingGroup("Mac窗口按钮"),l=document.createElement("input");l.type="checkbox",l.id="wx-code-mac-buttons",l.checked=this.enhancer.settings.showMacButtons;const a=document.createElement("label");a.htmlFor="wx-code-mac-buttons",a.textContent="显示Mac窗口按钮",o.appendChild(l),o.appendChild(a),e.appendChild(o);const c=this.createSettingGroup("字体设置"),d=document.createElement("label");d.htmlFor="wx-code-font-size",d.textContent="字体大小:";const h=document.createElement("input");h.type="text",h.id="wx-code-font-size",h.value=this.enhancer.settings.fontSize;const r=document.createElement("label");r.htmlFor="wx-code-font-family",r.textContent="字体系列:";const u=document.createElement("input");u.type="text",u.id="wx-code-font-family",u.value=this.enhancer.settings.fontFamily,c.appendChild(d),c.appendChild(h),c.appendChild(document.createElement("br")),c.appendChild(r),c.appendChild(u),e.appendChild(c);const p=this.createSettingGroup("语言支持"),m=document.createElement("input");m.type="checkbox",m.id="wx-code-lang-python",m.checked=this.enhancer.settings.languages.python;const g=document.createElement("label");g.htmlFor="wx-code-lang-python",g.textContent="Python";const b=document.createElement("input");b.type="checkbox",b.id="wx-code-lang-js",b.checked=this.enhancer.settings.languages.javascript;const y=document.createElement("label");y.htmlFor="wx-code-lang-js",y.textContent="JavaScript";const w=document.createElement("input");w.type="checkbox",w.id="wx-code-lang-html",w.checked=this.enhancer.settings.languages.html;const x=document.createElement("label");x.htmlFor="wx-code-lang-html",x.textContent="HTML";const S=document.createElement("input");S.type="checkbox",S.id="wx-code-lang-css",S.checked=this.enhancer.settings.languages.css;const C=document.createElement("label");C.htmlFor="wx-code-lang-css",C.textContent="CSS",p.appendChild(m),p.appendChild(g),p.appendChild(document.createElement("br")),p.appendChild(b),p.appendChild(y),p.appendChild(document.createElement("br")),p.appendChild(w),p.appendChild(x),p.appendChild(document.createElement("br")),p.appendChild(S),p.appendChild(C),e.appendChild(p);const f=this.createSettingGroup("自定义CSS"),E=document.createElement("label");E.htmlFor="wx-code-custom-css",E.textContent="自定义CSS样式:";const v=document.createElement("textarea");v.id="wx-code-custom-css",v.rows=6,v.value=this.enhancer.settings.customCSS,v.placeholder="/* 在这里添加自定义CSS样式 */\n.wx-enhanced-code-block {\n  /* 自定义样式 */\n}",f.appendChild(E),f.appendChild(document.createElement("br")),f.appendChild(v),e.appendChild(f);const k=document.createElement("div");k.className="wx-code-settings-buttons";const L=document.createElement("button");L.type="button",L.className="wx-code-settings-save",L.textContent="保存设置",L.addEventListener("click",this.handleSave);const M=document.createElement("button");return M.type="button",M.className="wx-code-settings-cancel",M.textContent="取消",M.addEventListener("click",this.handleCancel),k.appendChild(L),k.appendChild(M),e.appendChild(k),this.panelElement.appendChild(e),document.body.appendChild(this.panelElement),this.panelElement}createSettingGroup(t){const e=document.createElement("div");e.className="wx-code-settings-group";const n=document.createElement("h3");return n.textContent=t,e.appendChild(n),e}show(){this.panelElement||this.create(),this.panelElement.style.display="block"}hide(){this.panelElement&&(this.panelElement.style.display="none")}handleSave(){const t=document.getElementById("wx-code-enabled").checked,e=document.getElementById("wx-code-mac-buttons").checked,n=document.getElementById("wx-code-font-size").value,s=document.getElementById("wx-code-font-family").value,i=document.getElementById("wx-code-custom-css").value,o={python:document.getElementById("wx-code-lang-python").checked,javascript:document.getElementById("wx-code-lang-js").checked,html:document.getElementById("wx-code-lang-html").checked,css:document.getElementById("wx-code-lang-css").checked};this.enhancer.updateSettings({enabled:t,showMacButtons:e,fontSize:n,fontFamily:s,customCSS:i,languages:o}),this.hide()}handleCancel(){this.hide()}destroy(){this.panelElement&&this.panelElement.parentNode&&this.panelElement.parentNode.removeChild(this.panelElement),this.panelElement=null}}class p{constructor(t){this.container=null,this.switchInput=null,this.switchLabel=null,this.isOn=!1,this.onChange=t,this.handleChange=this.handleChange.bind(this)}create(){try{const t=document.querySelector(".wx-switch-container");if(t)return console.log("开关按钮已存在，不重复创建"),this.container=t,this.switchInput=t.querySelector(".wx-switch-checkbox"),this.switchLabel=t.querySelector(".wx-switch-label"),this.switchInput&&this.switchInput.addEventListener("change",this.handleChange),this.container;const e=document.querySelector(".edui-editor-toolbarboxouter-placeholder.edui-default");if(!e)return console.error("未找到目标元素，无法添加开关按钮"),null;this.container=document.createElement("div"),this.container.className="wx-switch-container",this.container.style.cssText="\n        position: relative;\n        display: flex;\n        align-items: center;\n        z-index: 999;\n        margin: 10px 20px 0 auto; /* 上右对齐 */\n        font-size: 14px;\n        color: #333;\n        float: right; /* 右浮动 */\n      ";const n=document.createElement("span");n.textContent="启用增强",n.style.marginRight="8px",this.switchInput=document.createElement("input"),this.switchInput.type="checkbox",this.switchInput.id="wx-feature-switch",this.switchInput.className="wx-switch-checkbox",this.switchInput.style.display="none",this.switchLabel=document.createElement("label"),this.switchLabel.htmlFor="wx-feature-switch",this.switchLabel.className="wx-switch-label",this.switchLabel.style.cssText="\n        position: relative;\n        display: inline-block;\n        width: 40px;\n        height: 20px;\n        background-color: #ccc;\n        border-radius: 20px;\n        transition: all 0.3s;\n        cursor: pointer;\n      ";const s=document.createElement("span");return s.className="wx-switch-slider",s.style.cssText="\n        position: absolute;\n        top: 2px;\n        left: 2px;\n        width: 16px;\n        height: 16px;\n        border-radius: 50%;\n        background-color: white;\n        transition: all 0.3s;\n        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);\n      ",this.switchLabel.appendChild(s),this.container.appendChild(n),this.container.appendChild(this.switchInput),this.container.appendChild(this.switchLabel),e.appendChild(this.container),this.switchInput.addEventListener("change",this.handleChange),this.addStyleRules(),console.log("开关按钮已创建"),this.container}catch(t){return console.error("创建开关按钮时出错:",t),null}}addStyleRules(){const t=document.createElement("style");t.textContent="\n      .wx-switch-checkbox:checked + .wx-switch-label {\n        background-color: #4CAF50;\n      }\n      \n      .wx-switch-checkbox:checked + .wx-switch-label .wx-switch-slider {\n        transform: translateX(20px);\n      }\n      \n      .wx-switch-label:hover {\n        opacity: 0.8;\n      }\n    ",document.head.appendChild(t)}handleChange(t){this.isOn=t.target.checked,"function"==typeof this.onChange&&this.onChange(this.isOn)}getState(){return this.isOn}setState(t){this.isOn=Boolean(t),this.switchInput.checked=this.isOn,"function"==typeof this.onChange&&this.onChange(this.isOn)}toggle(){this.setState(!this.isOn)}updatePosition(t){this.container&&(this.container.style.margin="",this.container.style.float="",this.container.style.position="relative",t.margin&&(this.container.style.margin=t.margin),t.float&&(this.container.style.float=t.float),t.customStyles&&Object.entries(t.customStyles).forEach((([t,e])=>{null!=e&&(this.container.style[t]=e)})))}}class m{constructor(){this.editor=null,this.floatingToolbar=null,this.settingsPanel=null,this.draggableButton=null,this.codeBlockEnhancer=null,this.codeBlockSettings=null,this.switchButton=null,this.findEditorInterval=null,this.styleSettings={h1:{fontSize:"30px",fontWeight:"bold"},h2:{fontSize:"24px",fontWeight:"bold"},h3:{fontSize:"20px",fontWeight:"bold"},h4:{fontSize:"16px",fontWeight:"bold"},code:{fontFamily:'SFMono-Regular, Consolas, "Liberation Mono", Menlo, monospace',backgroundColor:"rgba(175, 184, 193, 0.2)",padding:"0.2em 0.4em",borderRadius:"3px",fontSize:"85%"},custom:{css:""}},this.init=this.init.bind(this),this.onSettingsButtonClick=this.onSettingsButtonClick.bind(this),this.updateStyleSettings=this.updateStyleSettings.bind(this),this.onSwitchChange=this.onSwitchChange.bind(this),this.init()}init(){console.log("浮动工具栏插件初始化中...");const t=s(i);t&&(this.styleSettings={h1:{...this.styleSettings.h1,...t.h1},h2:{...this.styleSettings.h2,...t.h2},h3:{...this.styleSettings.h3,...t.h3},h4:{...this.styleSettings.h4,...t.h4},code:{...this.styleSettings.code,...t.code},custom:{css:t.custom?.css||""}},this.styleSettings.custom.css&&e(this.styleSettings.custom.css)),this.settingsPanel=new a(this.styleSettings),this.draggableButton=new c(this.onSettingsButtonClick),this.draggableButton.create(),this.switchButton=new p(this.onSwitchChange);const n=s(o);this.switchButtonState=null===n||n,this.findEditorInterval=setInterval((()=>{const t=function(){const t=document.querySelector('.ProseMirror[contenteditable="true"]');if(t)return console.log("找到ProseMirror编辑器"),t;const e=document.querySelectorAll("iframe");for(const t of e)try{const e=t.contentDocument||t.contentWindow.document,n=e.querySelector('.ProseMirror[contenteditable="true"]')||e.querySelector('[contenteditable="true"]');if(n)return console.log("在iframe中找到编辑器"),n}catch(t){console.log("访问iframe内容时出错:",t)}const n=document.querySelectorAll('[contenteditable="true"]');for(const t of n)if(t.closest(".edui-editor-body")||t.closest(".rich_media_content")||t.closest(".editor")||t.closest(".js_editor_area")||t.closest(".view.rich_media_content")||t.closest("#ueditor_0"))return console.log("找到微信编辑器元素"),t;return n.length>0?(console.log("未找到特定编辑器，使用第一个可编辑元素"),n[0]):(console.log("未找到任何可编辑元素"),null)}();t&&(clearInterval(this.findEditorInterval),this.editor=t,console.log("找到编辑器元素:",this.editor),this.floatingToolbar=new l(this.editor,this.styleSettings),this.floatingToolbar.create(),this.codeBlockEnhancer=new r(this.editor),this.codeBlockEnhancer.init(),this.codeBlockSettings=new u(this.codeBlockEnhancer),setTimeout((()=>{this.switchButton.create()&&void 0!==this.switchButtonState&&this.switchButton.setState(this.switchButtonState)}),500),console.log("浮动工具栏插件初始化完成"))}),1e3),setTimeout((()=>{this.findEditorInterval&&(clearInterval(this.findEditorInterval),console.log("未能找到编辑器元素，停止查找"))}),3e4)}onSettingsButtonClick(){if(this.settingsPanel){this.settingsPanel.show();const t=document.createElement("button");t.className="wx-settings-button wx-code-settings-button",t.textContent="代码块样式设置",t.addEventListener("click",(()=>{this.settingsPanel.hide(),this.codeBlockSettings.show()}));const e=this.settingsPanel.panelElement.querySelector(".wx-settings-buttons")||this.settingsPanel.panelElement;e&&!e.querySelector(".wx-code-settings-button")&&e.appendChild(t);const n=()=>{const t=this.settingsPanel.getSettings();this.updateStyleSettings(t)};if(this.settingsPanel.panel){const t=new MutationObserver((e=>{e.forEach((e=>{"attributes"===e.type&&"style"===e.attributeName&&e.target===this.settingsPanel.panel&&"none"===this.settingsPanel.panel.style.display&&(n(),t.disconnect())}))}));t.observe(this.settingsPanel.panel,{attributes:!0})}}}updateStyleSettings(t){this.styleSettings=t,this.floatingToolbar&&this.floatingToolbar.updateSettings(t)}onSwitchChange(t){console.log("开关状态变化:",t),this.floatingToolbar&&(t?this.floatingToolbar.enable():this.floatingToolbar.disable()),chrome.storage.local.set({[o]:t})}}function g(){console.log("尝试初始化插件..."),document.body&&(console.log("DOM已加载，初始化插件"),new m)}document.addEventListener("DOMContentLoaded",g),"interactive"!==document.readyState&&"complete"!==document.readyState||g(),setTimeout(g,1e3),chrome.runtime.sendMessage({action:"log",data:"内容脚本已加载"})}();
