# FlowEdit 架构优化计划

## 架构分析总结

### 现有架构优点

1. **插件化架构设计良好**
   - 使用 `plugin-registry.js` 统一管理所有功能模块
   - 每个功能模块都遵循标准插件接口 (`initialize`, `cleanup`, `isEnabled`, `isActive`)
   - 模块之间解耦，便于维护和扩展

2. **职责分离清晰**
   - `services/` - 核心服务层（桥接、监听、存储等）
   - `features/` - 功能模块层（智能编辑器、侧边栏等）
   - `utils/` - 工具层（解析器、存储、DOM操作等）
   - `config/` - 配置层

3. **模块化设计**
   - 每个功能模块都有独立的 `manager.js` 处理具体逻辑
   - 统一的入口点 `index.js` 定义插件接口

## 架构优化建议

### 1. 错误处理和日志系统优化

**问题**: 分散的console.log和错误处理
**解决方案**: 
- 创建统一的日志服务 `src/content/services/logger.js`
- 统一错误处理机制
- 添加错误上报和调试模式切换

**实现**:
```
src/content/services/
├── logger.js              # 统一日志服务
└── error-handler.js       # 统一错误处理
```

### 2. DOM监听器职责分离

**问题**: `dom-monitor.js` 承担了多种监听功能，职责混杂
**解决方案**:
```
src/content/services/
├── dom-monitor.js              # 主监听器（工具栏变化）
└── observers/
    ├── toolbar-observer.js     # 工具栏恢复
    └── content-observer.js     # 内容变化监听
```

### 3. 配置管理优化

**问题**: 配置分散在多个文件，缺乏统一管理
**解决方案**:
```
src/content/config/
├── index.js              # 主配置入口
├── editor-config.js      # Editor.js配置
├── feature-config.js     # 功能开关配置
└── runtime-config.js     # 运行时配置管理
```

### 4. 服务初始化顺序优化

**问题**: 初始化逻辑嵌套回调，难以维护
**解决方案**: 
- 使用依赖注入管理服务初始化顺序
- 创建 `ServiceContainer` 统一管理服务生命周期

### 5. 类型安全改善

**问题**: 缺乏类型检查，容易产生运行时错误
**解决方案**:
- 在关键模块添加 JSDoc 类型注释
- 在构建时进行类型检查

### 6. 插件接口标准化

**问题**: 插件接口虽然统一，但缺乏更细粒度的生命周期管理
**解决方案**:
```javascript
// 扩展插件接口
{
  name: string,
  version: string,
  dependencies?: string[],  // 插件依赖
  initialize(): Promise<void>,
  cleanup(): void,
  onActivate?(): void,      // 激活时回调
  onDeactivate?(): void,    // 停用时回调
  isEnabled(): boolean,
  isActive(): boolean
}
```

### 7. 内存管理优化

**问题**: 事件监听器和定时器清理不够完善
**解决方案**:
- 创建 `EventManager` 统一管理事件监听器
- 插件卸载时确保所有资源被正确释放

## 具体优化步骤

### 第一阶段: 日志系统和错误处理统一 ✅ (进行中)

**目标**: 统一日志输出格式，集中错误处理机制
**任务**:
- [ ] 创建统一的日志服务 `src/content/services/logger.js`
- [ ] 创建统一的错误处理机制 `src/content/services/error-handler.js`
- [ ] 更新现有代码使用新的日志系统
- [ ] 添加调试模式和错误上报功能

**预期收益**:
- 更好的调试体验
- 统一的错误处理
- 便于生产环境问题排查

### 第二阶段: DOM监听器拆分重构

**目标**: 将DOM监听器按职责分离，提高代码可维护性
**任务**:
- [ ] 创建 `observers/` 目录
- [ ] 拆分 `dom-monitor.js` 为专门的观察者类
- [ ] 重构工具栏恢复逻辑
- [ ] 重构内容变化监听逻辑

### 第三阶段: 配置管理优化

**目标**: 统一配置管理，支持运行时配置更新
**任务**:
- [ ] 重新组织配置文件结构
- [ ] 创建配置管理器
- [ ] 支持运行时配置更新
- [ ] 添加配置验证机制

### 第四阶段: 服务容器和依赖注入

**目标**: 改善服务初始化顺序和依赖管理
**任务**:
- [ ] 创建 `ServiceContainer` 类
- [ ] 实现简单的依赖注入机制
- [ ] 重构服务初始化流程
- [ ] 添加服务健康检查

### 第五阶段: 类型安全和插件接口改进

**目标**: 提高代码质量和插件扩展性
**任务**:
- [ ] 添加 JSDoc 类型注释
- [ ] 扩展插件接口支持更多生命周期
- [ ] 添加插件依赖管理
- [ ] 实现插件版本兼容性检查

## 注意事项

1. **向后兼容**: 每个阶段的重构都要保持向后兼容，不影响现有功能
2. **渐进式重构**: 逐步进行，每次只关注一个方面的改进
3. **测试覆盖**: 在重构过程中确保功能正常工作
4. **文档更新**: 及时更新 CLAUDE.md 中的架构说明

## 进度跟踪

- ✅ 第一阶段: 日志系统和错误处理统一 (进行中)
- ⏳ 第二阶段: DOM监听器拆分重构
- ⏳ 第三阶段: 配置管理优化  
- ⏳ 第四阶段: 服务容器和依赖注入
- ⏳ 第五阶段: 类型安全和插件接口改进

---

*最后更新: 2025-07-11*